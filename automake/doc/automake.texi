\input texinfo   @c -*-texinfo-*-
@c %**start of header
@setfilename automake.info
@settitle automake
@setchapternewpage off
@c %**end of header

@include version.texi

@copying

This manual is for @acronym{GNU} Automake (version @value{VERSION},
@value{UPDATED}), a program which creates GNU standards-compliant
Makefiles from template files.

Copyright @copyright{} 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
2003, 2004 Free Software Foundation, Inc.

@quotation
Permission is granted to copy, distribute and/or modify this document
under the terms of the @acronym{GNU} Free Documentation License,
Version 1.1 or any later version published by the Free Software
Foundation; with no Invariant Sections, with the Front-Cover texts
being ``A @acronym{GNU} Manual,'' and with the Back-Cover Texts as in
(a) below.  A copy of the license is included in the section entitled
``@acronym{GNU} Free Documentation License.''

(a) The FSF's Back-Cover Text is: ``You have freedom to copy and
modify this @acronym{GNU} Manual, like @acronym{GNU} software.  Copies
published by the Free Software Foundation raise funds for
@acronym{GNU} development.''
@end quotation
@end copying

@dircategory Software development
@direntry
* automake: (automake).		Making Makefile.in's.
@end direntry

@dircategory Individual utilities
@direntry
* aclocal: (automake)Invoking aclocal.          Generating aclocal.m4.
@end direntry

@titlepage
@title GNU Automake
@subtitle For version @value{VERSION}, @value{UPDATED}
@author David MacKenzie
@author Tom Tromey
@author Alexandre Duret-Lutz
@page
@vskip 0pt plus 1filll
@insertcopying
@end titlepage

@c Define an index of configure output variables.
@defcodeindex ov
@c Define an index of configure variables.
@defcodeindex cv
@c Define an index of options.
@defcodeindex op
@c Define an index of targets.
@defcodeindex tr
@c Define an index of commands.
@defcodeindex cm

@c Put the macros and variables into their own index.
@c @syncodeindex fn cp
@syncodeindex ov vr
@syncodeindex cv vr
@syncodeindex fn vr

@c Put everything else into one index (arbitrarily chosen to be the concept index).
@syncodeindex op cp
@syncodeindex tr cp
@syncodeindex cm cp

@ifnottex
@node Top
@comment  node-name,  next,  previous,  up
@top GNU Automake

@insertcopying

@menu
* Introduction::                Automake's purpose
* Generalities::                General ideas
* Examples::                    Some example packages
* Invoking Automake::           Creating a Makefile.in
* configure::                   Scanning configure.ac or configure.in
* Directories::                 Declaring subdirectories
* Programs::                    Building programs and libraries
* Other objects::               Other derived objects
* Other GNU Tools::             Other GNU Tools
* Documentation::               Building documentation
* Install::                     What gets installed
* Clean::                       What gets cleaned
* Dist::                        What goes in a distribution
* Tests::                       Support for test suites
* Rebuilding::                  Automatic rebuilding of Makefile
* Options::                     Changing Automake's behavior
* Miscellaneous::               Miscellaneous rules
* Include::                     Including extra files in an Automake template.
* Conditionals::                Conditionals
* Gnits::                       The effect of @code{--gnu} and @code{--gnits}
* Cygnus::                      The effect of @code{--cygnus}
* Not Enough::                  When Automake is not Enough
* Distributing::                Distributing the Makefile.in
* API versioning::              About compatibility between Automake versions
* Upgrading::                   Upgrading to a Newer Automake Version
* FAQ::                         Frequently Asked Questions
* Copying This Manual::         How to make copies of this manual
* Indices::                     Indices of variables, macros, and concepts

@detailmenu
 --- The Detailed Node Listing ---

General ideas

* General Operation::           General operation of Automake
* Strictness::                  Standards conformance checking
* Uniform::                     The Uniform Naming Scheme
* Canonicalization::            How derived variables are named
* User Variables::              Variables reserved for the user
* Auxiliary Programs::          Programs automake might require

Some example packages

* Complete::                    A simple example, start to finish
* Hello::                       A classic program
* true::                        Building true and false

Scanning @file{configure.ac}

* Requirements::                Configuration requirements
* Optional::                    Other things Automake recognizes
* Invoking aclocal::            Auto-generating aclocal.m4
* aclocal options::             aclocal command line arguments
* Macro search path::           Modifying aclocal's search path
* Macros::                      Autoconf macros supplied with Automake
* Extending aclocal::           Writing your own aclocal macros
* Local Macros::                Organizing local macros
* Future of aclocal::           aclocal's scheduled death

Auto-generating aclocal.m4

* aclocal options::             Options supported by aclocal
* Macro search path::           How aclocal finds .m4 files

Autoconf macros supplied with Automake

* Public macros::               Macros that you can use.
* Private macros::              Macros that you should not use.

Directories

* Subdirectories::              Building subdirectories recursively
* Conditional Subdirectories::  Conditionally not building directories
* Alternative::                 Subdirectories without recursion
* Subpackages::                 Nesting packages

Building Programs and Libraries

* A Program::                   Building a program
* A Library::                   Building a library
* A Shared Library::            Building a Libtool library
* Program and Library Variables::  Variables controlling program and
                                library builds
* Default _SOURCES::            Default source files
* LIBOBJS::                     Special handling for LIBOBJS and ALLOCA
* Program variables::           Variables used when building a program
* Yacc and Lex::                Yacc and Lex support
* C++ Support::                 Compiling C++ sources
* Assembly Support::            Compiling assembly sources
* Fortran 77 Support::          Compiling Fortran 77 sources
* Fortran 9x Support::          Compiling Fortran 9x sources
* Java Support::                Compiling Java sources
* Support for Other Languages::  Compiling other languages
* ANSI::                        Automatic de-ANSI-fication
* Dependencies::                Automatic dependency tracking
* EXEEXT::                      Support for executable extensions

Building a program

* Program Sources::             Defining program sources
* Linking::                     Linking with libraries or extra objects
* Conditional Sources::         Handling conditional sources
* Conditional Programs::        Building program conditionally

Building a Shared Library

* Libtool Concept::             Introducing Libtool
* Libtool Libraries::           Declaring Libtool Libraries
* Conditional Libtool Libraries::  Building Libtool Libraries Conditionally
* Conditional Libtool Sources::  Choosing Library Sources Conditionally
* Libtool Convenience Libraries::  Building Convenience Libtool Libraries
* Libtool Modules::             Building Libtool Modules
* Libtool Flags::               Using _LIBADD and _LDFLAGS
* LTLIBOBJ::                    Using $(LTLIBOBJ)
* Libtool Issues::              Common Issues Related to Libtool's Use

Fortran 77 Support

* Preprocessing Fortran 77::    Preprocessing Fortran 77 sources
* Compiling Fortran 77 Files::  Compiling Fortran 77 sources
* Mixing Fortran 77 With C and C++::  Mixing Fortran 77 With C and C++

Mixing Fortran 77 With C and C++

* How the Linker is Chosen::    Automatic linker selection

Fortran 9x Support

* Compiling Fortran 9x Files::  Compiling Fortran 9x sources

Other Derived Objects

* Scripts::                     Executable scripts
* Headers::                     Header files
* Data::                        Architecture-independent data files
* Sources::                     Derived sources

Built sources

* Built sources example::       Several ways to handle built sources.

Other GNU Tools

* Emacs Lisp::                  Emacs Lisp
* gettext::                     Gettext
* Libtool::                     Libtool
* Java::                        Java
* Python::                      Python

Building documentation

* Texinfo::                     Texinfo
* Man pages::                   Man pages

Miscellaneous Rules

* Tags::                        Interfacing to etags and mkid
* Suffixes::                    Handling new file extensions
* Multilibs::                   Support for multilibs.

When Automake Isn't Enough

* Extending::                   Adding new rules or overriding existing ones.
* Third-Party Makefiles::       Integrating Non-Automake @file{Makefile}s.

Frequently Asked Questions about Automake

* CVS::                         CVS and generated files
* maintainer-mode::             missing and AM_MAINTAINER_MODE
* wildcards::                   Why doesn't Automake support wildcards?
* distcleancheck::              Files left in build directory after distclean
* renamed objects::             Why are object files sometimes renamed?
* Multiple Outputs::            Writing rules for tools with many output files

Copying This Manual

* GNU Free Documentation License::  License for copying this manual

Indices

* Macro and Variable Index::    Index of Autoconf macros and Automake variables
* General Index::               General index

@end detailmenu
@end menu

@end ifnottex


@node Introduction
@chapter Introduction

Automake is a tool for automatically generating @file{Makefile.in}s from
files called @file{Makefile.am}.  Each @file{Makefile.am} is basically a
series of @code{make} variable definitions@footnote{These variables are
also called @dfn{make macros} in Make terminology, however in this
manual we reserve the term @dfn{macro} for Autoconf's macros.}, with
rules being thrown in occasionally.  The generated @file{Makefile.in}s
are compliant with the GNU Makefile standards.

@cindex GNU Makefile standards

The GNU Makefile Standards Document
(@pxref{Makefile Conventions, , , standards, The GNU Coding Standards})
is long, complicated, and subject to change.  The goal of Automake is to
remove the burden of Makefile maintenance from the back of the
individual GNU maintainer (and put it on the back of the Automake
maintainer).

The typical Automake input file is simply a series of variable definitions.
Each such file is processed to create a @file{Makefile.in}.  There
should generally be one @file{Makefile.am} per directory of a project.

@cindex Constraints of Automake
@cindex Automake constraints

Automake does constrain a project in certain ways; for instance it
assumes that the project uses Autoconf (@pxref{Top, , Introduction,
autoconf, The Autoconf Manual}), and enforces certain restrictions on
the @file{configure.ac} contents@footnote{Older Autoconf versions used
@file{configure.in}.  Autoconf 2.50 and greater promotes
@file{configure.ac} over @file{configure.in}.  The rest of this
documentation will refer to @file{configure.ac}, but Automake also
supports @file{configure.in} for backward compatibility.}.

@cindex Automake requirements
@cindex Requirements, Automake

Automake requires @code{perl} in order to generate the
@file{Makefile.in}s.  However, the distributions created by Automake are
fully GNU standards-compliant, and do not require @code{perl} in order
to be built.

@cindex BUGS, reporting
@cindex Reporting BUGS
@cindex E-mail, bug reports

Mail suggestions and bug reports for Automake to
@email{bug-automake@@gnu.org}.


@node Generalities
@chapter General ideas

The following sections cover a few basic ideas that will help you
understand how Automake works.

@menu
* General Operation::           General operation of Automake
* Strictness::                  Standards conformance checking
* Uniform::                     The Uniform Naming Scheme
* Canonicalization::            How derived variables are named
* User Variables::              Variables reserved for the user
* Auxiliary Programs::          Programs automake might require
@end menu


@node General Operation
@section General Operation

Automake works by reading a @file{Makefile.am} and generating a
@file{Makefile.in}.  Certain variables and rules defined in the
@file{Makefile.am} instruct Automake to generate more specialized code;
for instance, a @samp{bin_PROGRAMS} variable definition will cause rules
for compiling and linking programs to be generated.

@cindex Non-standard targets
@cindex cvs-dist, non-standard example
@trindex cvs-dist

The variable definitions and rules in the @file{Makefile.am} are
copied verbatim into the generated file.  This allows you to add
arbitrary code into the generated @file{Makefile.in}.  For instance
the Automake distribution includes a non-standard rule for the
@code{cvs-dist} target, which the Automake maintainer uses to make
distributions from his source control system.

@cindex GNU make extensions

Note that most GNU make extensions are not recognized by Automake.  Using
such extensions in a @file{Makefile.am} will lead to errors or confusing
behavior.

@cindex Append operator
A special exception is that the GNU make append operator, @samp{+=}, is
supported.  This operator appends its right hand argument to the variable
specified on the left.  Automake will translate the operator into
an ordinary @samp{=} operator; @samp{+=} will thus work with any make program.

Automake tries to keep comments grouped with any adjoining rules or
variable definitions.

@cindex Make targets, overriding
@cindex Make rules, overriding
@cindex Overriding make rules
@cindex Overriding make targets

A rule defined in @file{Makefile.am} generally overrides any such
rule of a similar name that would be automatically generated by
@code{automake}.  Although this is a supported feature, it is generally
best to avoid making use of it, as sometimes the generated rules are
very particular.

@cindex Variables, overriding
@cindex Overriding make variables

Similarly, a variable defined in @file{Makefile.am} or
@code{AC_SUBST}'ed from @file{configure.ac} will override any
definition of the variable that @code{automake} would ordinarily
create.  This feature is more often useful than the ability to
override a rule.  Be warned that many of the variables generated by
@code{automake} are considered to be for internal use only, and their
names might change in future releases.

@cindex Recursive operation of Automake
@cindex Automake, recursive operation
@cindex Example of recursive operation

When examining a variable definition, Automake will recursively examine
variables referenced in the definition.  For example, if Automake is
looking at the content of @code{foo_SOURCES} in this snippet

@example
xs = a.c b.c
foo_SOURCES = c.c $(xs)
@end example

it would use the files @file{a.c}, @file{b.c}, and @file{c.c} as the
contents of @code{foo_SOURCES}.

@cindex ## (special Automake comment)
@cindex Special Automake comment
@cindex Comment, special to Automake

Automake also allows a form of comment which is @emph{not} copied into
the output; all lines beginning with @samp{##} (leading spaces allowed)
are completely ignored by Automake.

It is customary to make the first line of @file{Makefile.am} read:

@cindex Makefile.am, first line
@cindex First line of Makefile.am

@example
## Process this file with automake to produce Makefile.in
@end example

@c FIXME discuss putting a copyright into Makefile.am here?  I would but
@c I don't know quite what to say.

@c FIXME document customary ordering of Makefile.am here!


@node Strictness
@section Strictness

@cindex Non-GNU packages

While Automake is intended to be used by maintainers of GNU packages, it
does make some effort to accommodate those who wish to use it, but do
not want to use all the GNU conventions.

@cindex Strictness, defined
@cindex Strictness, foreign
@cindex foreign strictness
@cindex Strictness, gnu
@cindex gnu strictness
@cindex Strictness, gnits
@cindex gnits strictness

To this end, Automake supports three levels of @dfn{strictness}---the
strictness indicating how stringently Automake should check standards
conformance.

The valid strictness levels are:

@table @samp
@item foreign
Automake will check for only those things which are absolutely
required for proper operations.  For instance, whereas GNU standards
dictate the existence of a @file{NEWS} file, it will not be required in
this mode.  The name comes from the fact that Automake is intended to be
used for GNU programs; these relaxed rules are not the standard mode of
operation.

@item gnu
Automake will check---as much as possible---for compliance to the GNU
standards for packages.  This is the default.

@item gnits
Automake will check for compliance to the as-yet-unwritten @dfn{Gnits
standards}.  These are based on the GNU standards, but are even more
detailed.  Unless you are a Gnits standards contributor, it is
recommended that you avoid this option until such time as the Gnits
standard is actually published (which may never happen).
@end table

For more information on the precise implications of the strictness
level, see @ref{Gnits}.

Automake also has a special ``cygnus'' mode which is similar to
strictness but handled differently.  This mode is useful for packages
which are put into a ``Cygnus'' style tree (e.g., the GCC tree).  For
more information on this mode, see @ref{Cygnus}.


@node Uniform
@section The Uniform Naming Scheme

@cindex Uniform naming scheme

Automake variables generally follow a @dfn{uniform naming scheme} that
makes it easy to decide how programs (and other derived objects) are
built, and how they are installed.  This scheme also supports
@code{configure} time determination of what should be built.

@cindex _PROGRAMS primary variable
@cindex PROGRAMS primary variable
@cindex Primary variable, PROGRAMS
@cindex Primary variable, defined

At @code{make} time, certain variables are used to determine which
objects are to be built.  The variable names are made of several pieces
which are concatenated together.

The piece which tells automake what is being built is commonly called
the @dfn{primary}.  For instance, the primary @code{PROGRAMS} holds a
list of programs which are to be compiled and linked.
@vindex PROGRAMS

@cindex pkglibdir, defined
@cindex pkgincludedir, defined
@cindex pkgdatadir, defined

@vindex pkglibdir
@vindex pkgincludedir
@vindex pkgdatadir

A different set of names is used to decide where the built objects
should be installed.  These names are prefixes to the primary which
indicate which standard directory should be used as the installation
directory.  The standard directory names are given in the GNU standards
(@pxref{Directory Variables, , , standards, The GNU Coding Standards}).
Automake extends this list with @code{pkglibdir}, @code{pkgincludedir},
and @code{pkgdatadir}; these are the same as the non-@samp{pkg}
versions, but with @samp{$(PACKAGE)} appended.  For instance,
@code{pkglibdir} is defined as @code{$(libdir)/$(PACKAGE)}.
@cvindex PACKAGE, directory

@cindex EXTRA_, prepending

For each primary, there is one additional variable named by prepending
@samp{EXTRA_} to the primary name.  This variable is used to list
objects which may or may not be built, depending on what
@code{configure} decides.  This variable is required because Automake
must statically know the entire list of objects that may be built in
order to generate a @file{Makefile.in} that will work in all cases.

@cindex EXTRA_PROGRAMS, defined
@cindex Example, EXTRA_PROGRAMS
@cindex cpio example

For instance, @code{cpio} decides at configure time which programs are
built.  Some of the programs are installed in @code{bindir}, and some
are installed in @code{sbindir}:

@example
EXTRA_PROGRAMS = mt rmt
bin_PROGRAMS = cpio pax
sbin_PROGRAMS = $(MORE_PROGRAMS)
@end example

Defining a primary without a prefix as a variable, e.g.,
@code{PROGRAMS}, is an error.

Note that the common @samp{dir} suffix is left off when constructing the
variable names; thus one writes @samp{bin_PROGRAMS} and not
@samp{bindir_PROGRAMS}.

Not every sort of object can be installed in every directory.  Automake
will flag those attempts it finds in error.
Automake will also diagnose obvious misspellings in directory names.

@cindex Extending list of installation directories
@cindex Installation directories, extending list

Sometimes the standard directories---even as augmented by Automake---
are not enough.  In particular it is sometimes useful, for clarity, to
install objects in a subdirectory of some predefined directory.  To this
end, Automake allows you to extend the list of possible installation
directories.  A given prefix (e.g. @samp{zar}) is valid if a variable of
the same name with @samp{dir} appended is defined (e.g. @code{zardir}).

@cindex HTML installation, example

For instance, installation of HTML files is part of Automake, you could
use this to install raw HTML documentation:

@example
htmldir = $(prefix)/html
html_DATA = automake.html
@end example

@cindex noinst primary prefix, definition

The special prefix @samp{noinst} indicates that the objects in question
should be built but not installed at all.  This is usually used for
objects required to build the rest of your package, for instance static
libraries (@pxref{A Library}), or helper scripts.

@cindex check primary prefix, definition

The special prefix @samp{check} indicates that the objects in question
should not be built until the @code{make check} command is run.  Those
objects are not installed either.

The current primary names are @samp{PROGRAMS}, @samp{LIBRARIES},
@samp{LISP}, @samp{PYTHON}, @samp{JAVA}, @samp{SCRIPTS}, @samp{DATA},
@samp{HEADERS}, @samp{MANS}, and @samp{TEXINFOS}.
@vindex PROGRAMS
@vindex LIBRARIES
@vindex LISP
@vindex PYTHON
@vindex JAVA
@vindex SCRIPTS
@vindex DATA
@vindex HEADERS
@vindex MANS
@vindex TEXINFOS

Some primaries also allow additional prefixes which control other
aspects of @code{automake}'s behavior.  The currently defined prefixes
are @samp{dist_}, @samp{nodist_}, and @samp{nobase_}.  These prefixes
are explained later (@pxref{Program and Library Variables}).


@node Canonicalization
@section How derived variables are named

@cindex canonicalizing Automake variables

Sometimes a Makefile variable name is derived from some text the
maintainer supplies.  For instance, a program name listed in
@samp{_PROGRAMS} is rewritten into the name of a @samp{_SOURCES}
variable.  In cases like this, Automake canonicalizes the text, so that
program names and the like do not have to follow Makefile variable naming
rules.  All characters in the name except for letters, numbers, the
strudel (@@), and the underscore are turned into underscores when making
variable references.

For example, if your program is named @code{sniff-glue}, the derived
variable name would be @code{sniff_glue_SOURCES}, not
@code{sniff-glue_SOURCES}.  Similarly the sources for a library named
@code{libmumble++.a} should be listed in the
@code{libmumble___a_SOURCES} variable.

The strudel is an addition, to make the use of Autoconf substitutions in
variable names less obfuscating.


@node User Variables
@section Variables reserved for the user

@cindex variables, reserved for the user
@cindex user variables

Some @code{Makefile} variables are reserved by the GNU Coding Standards
for the use of the ``user'' -- the person building the package.  For
instance, @code{CFLAGS} is one such variable.

Sometimes package developers are tempted to set user variables such as
@code{CFLAGS} because it appears to make their job easier.  However,
the package itself should never set a user variable, particularly not
to include switches which are required for proper compilation of the
package.  Since these variables are documented as being for the
package builder, that person rightfully expects to be able to override
any of these variables at build time.

To get around this problem, automake introduces an automake-specific
shadow variable for each user flag variable.  (Shadow variables are not
introduced for variables like @code{CC}, where they would make no
sense.)  The shadow variable is named by prepending @samp{AM_} to the
user variable's name.  For instance, the shadow variable for
@code{YFLAGS} is @code{AM_YFLAGS}.


@node Auxiliary Programs
@section Programs automake might require

@cindex Programs, auxiliary
@cindex Auxiliary programs

Automake sometimes requires helper programs so that the generated
@file{Makefile} can do its work properly.  There are a fairly large
number of them, and we list them here.

@table @code
@item ansi2knr.c
@itemx ansi2knr.1
These two files are used by the automatic de-ANSI-fication support
(@pxref{ANSI}).

@item compile
This is a wrapper for compilers which don't accept both @samp{-c} and
@samp{-o} at the same time.  It is only used when absolutely required.
Such compilers are rare.

@item config.guess
@itemx config.sub
These programs compute the canonical triplets for the given build, host,
or target architecture.  These programs are updated regularly to support
new architectures and fix probes broken by changes in new kernel
versions.  You are encouraged to fetch the latest versions of these
files from @url{ftp://ftp.gnu.org/gnu/config/} before making a release.

@item depcomp
This program understands how to run a compiler so that it will generate
not only the desired output but also dependency information which is
then used by the automatic dependency tracking feature.

@item elisp-comp
This program is used to byte-compile Emacs Lisp code.

@item install-sh
This is a replacement for the @code{install} program which works on
platforms where @code{install} is unavailable or unusable.

@item mdate-sh
This script is used to generate a @file{version.texi} file.  It examines
a file and prints some date information about it.

@item missing
This wraps a number of programs which are typically only required by
maintainers.  If the program in question doesn't exist, @code{missing}
prints an informative warning and attempts to fix things so that the
build can continue.

@item mkinstalldirs
This script used to be a wrapper around @code{mkdir -p}, which is not
portable.  Now we use prefer to use @code{install-sh -d} when configure
finds that @code{mkdir -p} does not work, this makes one less script to
distribute.

For backward compatibility @code{mkinstalldirs} is still used and
distributed when @code{automake} finds it in a package.  But it is no
longer installed automatically, and it should be safe to remove it.

@item py-compile
This is used to byte-compile Python scripts.

@item texinfo.tex
Not a program, this file is required for @code{make dvi}, @code{make ps}
and @code{make pdf} to work when Texinfo sources are in the package.

@item ylwrap
This program wraps @code{lex} and @code{yacc} and ensures that, for
instance, multiple @code{yacc} instances can be invoked in a single
directory in parallel.

@end table


@node Examples
@chapter Some example packages

@menu
* Complete::                    A simple example, start to finish
* Hello::                       A classic program
* true::                        Building true and false
@end menu


@node Complete
@section A simple example, start to finish

@cindex Complete example

Let's suppose you just finished writing @code{zardoz}, a program to make
your head float from vortex to vortex.  You've been using Autoconf to
provide a portability framework, but your @file{Makefile.in}s have been
ad-hoc.  You want to make them bulletproof, so you turn to Automake.

@cindex AM_INIT_AUTOMAKE, example use

The first step is to update your @file{configure.ac} to include the
commands that @code{automake} needs.  The way to do this is to add an
@code{AM_INIT_AUTOMAKE} call just after @code{AC_INIT}:

@example
AC_INIT(zardoz, 1.0)
AM_INIT_AUTOMAKE
@dots{}
@end example

Since your program doesn't have any complicating factors (e.g., it
doesn't use @code{gettext}, it doesn't want to build a shared library),
you're done with this part.  That was easy!

@cindex aclocal program, introduction
@cindex aclocal.m4, preexisting
@cindex acinclude.m4, defined

Now you must regenerate @file{configure}.  But to do that, you'll need
to tell @code{autoconf} how to find the new macro you've used.  The
easiest way to do this is to use the @code{aclocal} program to generate
your @file{aclocal.m4} for you.  But wait@dots{} maybe you already have an
@file{aclocal.m4}, because you had to write some hairy macros for your
program.  The @code{aclocal} program lets you put your own macros into
@file{acinclude.m4}, so simply rename and then run:

@example
mv aclocal.m4 acinclude.m4
aclocal
autoconf
@end example

@cindex zardoz example

Now it is time to write your @file{Makefile.am} for @code{zardoz}.
Since @code{zardoz} is a user program, you want to install it where the
rest of the user programs go: @code{bindir}.  Additionally,
@code{zardoz} has some Texinfo documentation.  Your @file{configure.ac}
script uses @code{AC_REPLACE_FUNCS}, so you need to link against
@samp{$(LIBOBJS)}.  So here's what you'd write:

@example
bin_PROGRAMS = zardoz
zardoz_SOURCES = main.c head.c float.c vortex9.c gun.c
zardoz_LDADD = $(LIBOBJS)

info_TEXINFOS = zardoz.texi
@end example

Now you can run @code{automake --add-missing} to generate your
@file{Makefile.in} and grab any auxiliary files you might need, and
you're done!


@node Hello
@section A classic program

@cindex Example, GNU Hello
@cindex Hello example
@cindex GNU Hello, example

@uref{ftp://prep.ai.mit.edu/pub/gnu/hello-1.3.tar.gz, GNU hello} is
renowned for its classic simplicity and versatility.  This section shows
how Automake could be used with the GNU Hello package.  The examples
below are from the latest beta version of GNU Hello, but with all of the
maintainer-only code stripped out, as well as all copyright comments.

Of course, GNU Hello is somewhat more featureful than your traditional
two-liner.  GNU Hello is internationalized, does option processing, and
has a manual and a test suite.

@cindex configure.ac, from GNU Hello
@cindex GNU Hello, configure.ac
@cindex Hello, configure.ac

Here is the @file{configure.ac} from GNU Hello.
@strong{Please note:} The calls to @code{AC_INIT} and @code{AM_INIT_AUTOMAKE}
in this example use a deprecated syntax.  For the current approach,
see the description of @code{AM_INIT_AUTOMAKE} in @ref{Public macros}.

@c FIXME: This definitely requires an update, e.g. to GNU Hello 2.1.1.

@example
dnl Process this file with autoconf to produce a configure script.
AC_INIT(src/hello.c)
AM_INIT_AUTOMAKE(hello, 1.3.11)
AM_CONFIG_HEADER(config.h)

dnl Set of available languages.
ALL_LINGUAS="de fr es ko nl no pl pt sl sv"

dnl Checks for programs.
AC_PROG_CC
AC_ISC_POSIX

dnl Checks for libraries.

dnl Checks for header files.
AC_STDC_HEADERS
AC_HAVE_HEADERS(string.h fcntl.h sys/file.h sys/param.h)

dnl Checks for library functions.
AC_FUNC_ALLOCA

dnl Check for st_blksize in struct stat
AC_ST_BLKSIZE

dnl internationalization macros
AM_GNU_GETTEXT
AC_OUTPUT([Makefile doc/Makefile intl/Makefile po/Makefile.in \
           src/Makefile tests/Makefile tests/hello],
   [chmod +x tests/hello])
@end example

The @samp{AM_} macros are provided by Automake (or the Gettext library);
the rest are standard Autoconf macros.


The top-level @file{Makefile.am}:

@example
EXTRA_DIST = BUGS ChangeLog.O
SUBDIRS = doc intl po src tests
@end example

As you can see, all the work here is really done in subdirectories.

The @file{po} and @file{intl} directories are automatically generated
using @code{gettextize}; they will not be discussed here.

@cindex Texinfo file handling example
@cindex Example, handling Texinfo files

In @file{doc/Makefile.am} we see:

@example
info_TEXINFOS = hello.texi
hello_TEXINFOS = gpl.texi
@end example

This is sufficient to build, install, and distribute the GNU Hello
manual.

@cindex Regression test example
@cindex Example, regression test

Here is @file{tests/Makefile.am}:

@example
TESTS = hello
EXTRA_DIST = hello.in testdata
@end example

The script @file{hello} is generated by @code{configure}, and is the
only test case.  @code{make check} will run this test.

@cindex INCLUDES, example usage

Last we have @file{src/Makefile.am}, where all the real work is done:
@c FIXME: As all the Hello World excerpts in this manual, this
@c shows deprecated features (here: $(INCLUDES)).

@example
bin_PROGRAMS = hello
hello_SOURCES = hello.c version.c getopt.c getopt1.c getopt.h system.h
hello_LDADD = $(INTLLIBS) $(ALLOCA)
localedir = $(datadir)/locale
INCLUDES = -I../intl -DLOCALEDIR=\"$(localedir)\"
@end example


@node true
@section Building true and false

@cindex Example, false and true
@cindex false Example
@cindex true Example

Here is another, trickier example.  It shows how to generate two
programs (@code{true} and @code{false}) from the same source file
(@file{true.c}).  The difficult part is that each compilation of
@file{true.c} requires different @code{cpp} flags.

@example
bin_PROGRAMS = true false
false_SOURCES =
false_LDADD = false.o

true.o: true.c
        $(COMPILE) -DEXIT_CODE=0 -c true.c

false.o: true.c
        $(COMPILE) -DEXIT_CODE=1 -o false.o -c true.c
@end example

Note that there is no @code{true_SOURCES} definition.  Automake will
implicitly assume that there is a source file named @file{true.c}, and
define rules to compile @file{true.o} and link @file{true}.  The
@code{true.o: true.c} rule supplied by the above @file{Makefile.am},
will override the Automake generated rule to build @file{true.o}.

@code{false_SOURCES} is defined to be empty---that way no implicit value
is substituted.  Because we have not listed the source of
@file{false}, we have to tell Automake how to link the program.  This is
the purpose of the @code{false_LDADD} line.  A @code{false_DEPENDENCIES}
variable, holding the dependencies of the @file{false} target will be
automatically generated by Automake from the content of
@code{false_LDADD}.

The above rules won't work if your compiler doesn't accept both
@samp{-c} and @samp{-o}.  The simplest fix for this is to introduce a
bogus dependency (to avoid problems with a parallel @code{make}):

@example
true.o: true.c false.o
        $(COMPILE) -DEXIT_CODE=0 -c true.c

false.o: true.c
        $(COMPILE) -DEXIT_CODE=1 -c true.c && mv true.o false.o
@end example

Also, these explicit rules do not work if the de-ANSI-fication feature
is used (@pxref{ANSI}).  Supporting de-ANSI-fication requires a little
more work:

@example
true_.o: true_.c false_.o
        $(COMPILE) -DEXIT_CODE=0 -c true_.c

false_.o: true_.c
        $(COMPILE) -DEXIT_CODE=1 -c true_.c && mv true_.o false_.o
@end example

As it turns out, there is also a much easier way to do this same task.
Some of the above techniques are useful enough that we've kept the
example in the manual.  However if you were to build @code{true} and
@code{false} in real life, you would probably use per-program
compilation flags, like so:

@example
bin_PROGRAMS = false true

false_SOURCES = true.c
false_CPPFLAGS = -DEXIT_CODE=1

true_SOURCES = true.c
true_CPPFLAGS = -DEXIT_CODE=0
@end example

In this case Automake will cause @file{true.c} to be compiled twice,
with different flags.  De-ANSI-fication will work automatically.  In
this instance, the names of the object files would be chosen by
automake; they would be @file{false-true.o} and @file{true-true.o}.
(The name of the object files rarely matters.)


@node Invoking Automake
@chapter Creating a @file{Makefile.in}

@cindex Multiple configure.ac files
@cindex Invoking Automake
@cindex Automake, invoking

To create all the @file{Makefile.in}s for a package, run the
@code{automake} program in the top level directory, with no arguments.
@code{automake} will automatically find each appropriate
@file{Makefile.am} (by scanning @file{configure.ac}; @pxref{configure})
and generate the corresponding @file{Makefile.in}.  Note that
@code{automake} has a rather simplistic view of what constitutes a
package; it assumes that a package has only one @file{configure.ac}, at
the top.  If your package has multiple @file{configure.ac}s, then you
must run @code{automake} in each directory holding a
@file{configure.ac}.  (Alternatively, you may rely on Autoconf's
@code{autoreconf}, which is able to recurse your package tree and run
@code{automake} where appropriate.)

You can optionally give @code{automake} an argument; @file{.am} is
appended to the argument and the result is used as the name of the input
file.  This feature is generally only used to automatically rebuild an
out-of-date @file{Makefile.in}.  Note that @code{automake} must always
be run from the topmost directory of a project, even if being used to
regenerate the @file{Makefile.in} in some subdirectory.  This is
necessary because @code{automake} must scan @file{configure.ac}, and
because @code{automake} uses the knowledge that a @file{Makefile.in} is
in a subdirectory to change its behavior in some cases.

@vindex AUTOCONF
Automake will run @code{autoconf} to scan @file{configure.ac} and its
dependencies (@file{aclocal.m4}), therefore @code{autoconf} must be in
your @code{PATH}.  If there is an @code{AUTOCONF} variable in your
environment it will be used instead of @code{autoconf}, this allows you
to select a particular version of Autoconf.  By the way, don't
misunderstand this paragraph: Automake runs @code{autoconf} to
@strong{scan} your @file{configure.ac}, this won't build
@file{configure} and you still have to run @code{autoconf} yourself for
this purpose.

@cindex Automake options
@cindex Options, Automake
@cindex Strictness, command line

@code{automake} accepts the following options:

@cindex Extra files distributed with Automake
@cindex Files distributed with Automake
@cindex config.guess

@table @samp
@item -a
@itemx --add-missing
@opindex -a
@opindex --add-missing
Automake requires certain common files to exist in certain situations;
for instance @file{config.guess} is required if @file{configure.ac} runs
@code{AC_CANONICAL_HOST}.  Automake is distributed with several of these
files (@pxref{Auxiliary Programs}); this option will cause the missing
ones to be automatically added to the package, whenever possible.  In
general if Automake tells you a file is missing, try using this option.
By default Automake tries to make a symbolic link pointing to its own
copy of the missing file; this can be changed with @code{--copy}.

Many of the potentially-missing files are common scripts whose
location may be specified via the @code{AC_CONFIG_AUX_DIR} macro.
Therefore, @code{AC_CONFIG_AUX_DIR}'s setting affects whether a
file is considered missing, and where the missing file is added
(@pxref{Optional}).

@item --libdir=@var{dir}
@opindex --libdir
Look for Automake data files in directory @var{dir} instead of in the
installation directory.  This is typically used for debugging.

@item -c
@opindex -c
@itemx --copy
@opindex --copy
When used with @code{--add-missing}, causes installed files to be
copied.  The default is to make a symbolic link.

@item --cygnus
@opindex --cygnus
Causes the generated @file{Makefile.in}s to follow Cygnus rules, instead
of GNU or Gnits rules.  For more information, see @ref{Cygnus}.

@item -f
@opindex -f
@itemx --force-missing
@opindex --force-missing
When used with @code{--add-missing}, causes standard files to be reinstalled
even if they already exist in the source tree.  This involves removing
the file from the source tree before creating the new symlink (or, with
@code{--copy}, copying the new file).

@item --foreign
@opindex --foreign
Set the global strictness to @samp{foreign}.  For more information, see
@ref{Strictness}.

@item --gnits
@opindex --gnits
Set the global strictness to @samp{gnits}.  For more information, see
@ref{Gnits}.

@item --gnu
@opindex --gnu
Set the global strictness to @samp{gnu}.  For more information, see
@ref{Gnits}.  This is the default strictness.

@item --help
@opindex --help
Print a summary of the command line options and exit.

@item -i
@itemx --ignore-deps
@opindex -i
This disables the dependency tracking feature in generated
@file{Makefile}s; see @ref{Dependencies}.

@item --include-deps
@opindex --include-deps
This enables the dependency tracking feature.  This feature is enabled
by default.  This option is provided for historical reasons only and
probably should not be used.

@item --no-force
@opindex --no-force
Ordinarily @code{automake} creates all @file{Makefile.in}s mentioned in
@file{configure.ac}.  This option causes it to only update those
@file{Makefile.in}s which are out of date with respect to one of their
dependents.

@item -o @var{dir}
@itemx --output-dir=@var{dir}
@opindex -o
@opindex --output-dir
Put the generated @file{Makefile.in} in the directory @var{dir}.
Ordinarily each @file{Makefile.in} is created in the directory of the
corresponding @file{Makefile.am}.  This option is deprecated and will be
removed in a future release.

@item -v
@itemx --verbose
@opindex -v
@opindex --verbose
Cause Automake to print information about which files are being read or
created.

@item --version
@opindex --version
Print the version number of Automake and exit.

@item -W CATEGORY
@item --warnings=@var{category}
@opindex -W
@opindex --warnings
Output warnings falling in @var{category}.  @var{category} can be
one of:
@table @samp
@item gnu
warnings related to the GNU Coding Standards
(@pxref{Top, , , standards, The GNU Coding Standards}).
@item obsolete
obsolete features or constructions
@item override
user redefinitions of Automake rules or variables
@item portability
portability issues (e.g., use of Make features which are known not portable)
@item syntax
weird syntax, unused variables, typos
@item unsupported
unsupported or incomplete features
@item all
all the warnings
@item none
turn off all the warnings
@item error
treat warnings as errors
@end table

A category can be turned off by prefixing its name with @samp{no-}.  For
instance @samp{-Wno-syntax} will hide the warnings about unused
variables.

The categories output by default are @samp{syntax} and
@samp{unsupported}.  Additionally, @samp{gnu} is enabled in @samp{--gnu} and
@samp{--gnits} strictness.

@samp{portability} warnings are currently disabled by default, but they
will be enabled in @samp{--gnu} and @samp{--gnits} strictness in a
future release.

@vindex WARNINGS
The environment variable @samp{WARNINGS} can contain a comma separated
list of categories to enable.  It will be taken into account before the
command-line switches, this way @samp{-Wnone} will also ignore any
warning category enabled by @samp{WARNINGS}.  This variable is also used
by other tools like @command{autoconf}; unknown categories are ignored
for this reason.

@end table


@node configure
@chapter Scanning @file{configure.ac}

@cindex configure.ac, scanning
@cindex Scanning configure.ac

Automake scans the package's @file{configure.ac} to determine certain
information about the package.  Some @code{autoconf} macros are required
and some variables must be defined in @file{configure.ac}.  Automake
will also use information from @file{configure.ac} to further tailor its
output.

Automake also supplies some Autoconf macros to make the maintenance
easier.  These macros can automatically be put into your
@file{aclocal.m4} using the @code{aclocal} program.

@menu
* Requirements::                Configuration requirements
* Optional::                    Other things Automake recognizes
* Invoking aclocal::            Auto-generating aclocal.m4
* aclocal options::             aclocal command line arguments
* Macro search path::           Modifying aclocal's search path
* Macros::                      Autoconf macros supplied with Automake
* Extending aclocal::           Writing your own aclocal macros
* Local Macros::                Organizing local macros
* Future of aclocal::           aclocal's scheduled death
@end menu


@node Requirements
@section Configuration requirements

@cindex Automake requirements
@cindex Requirements of Automake

The one real requirement of Automake is that your @file{configure.ac}
call @code{AM_INIT_AUTOMAKE}.  This macro does several things which are
required for proper Automake operation (@pxref{Macros}).
@cvindex AM_INIT_AUTOMAKE

Here are the other macros which Automake requires but which are not run
by @code{AM_INIT_AUTOMAKE}:

@table @code
@item AC_CONFIG_FILES
@itemx AC_OUTPUT
Automake uses these to determine which files to create (@pxref{Output, ,
Creating Output Files, autoconf, The Autoconf Manual}).  A listed file
is considered to be an Automake generated @file{Makefile} if there
exists a file with the same name and the @file{.am} extension appended.
Typically, @code{AC_CONFIG_FILES([foo/Makefile])} will cause Automake to
generate @file{foo/Makefile.in} if @file{foo/Makefile.am} exists.

When using @code{AC_CONFIG_FILES} with multiple input files, as in
@code{AC_CONFIG_FILES([Makefile:top.in:Makefile.in:bot.in])}, Automake
will generate the first @file{.in} input file for which a @file{.am}
file exists.  If no such file exists the output file is not considered
to be Automake generated.

Files created by @code{AC_CONFIG_FILES} are removed by @code{make distclean}.
@cvindex AC_CONFIG_FILES
@cvindex AC_OUTPUT
@end table


@node Optional
@section Other things Automake recognizes

@cindex Macros Automake recognizes
@cindex Recognized macros by Automake

Every time Automake is run it calls Autoconf to trace
@file{configure.ac}.  This way it can recognize the use of certain
macros and tailor the generated @file{Makefile.in} appropriately.
Currently recognized macros and their effects are:

@table @code
@item AC_CONFIG_HEADERS
Automake will generate rules to rebuild these headers.  Older versions
of Automake required the use of @code{AM_CONFIG_HEADER}
(@pxref{Macros}); this is no longer the case today.
@cvindex AC_CONFIG_HEADERS

@item AC_CONFIG_LINKS
Automake will generate rules to remove @file{configure} generated links on
@code{make distclean} and to distribute named source files as part of
@code{make dist}.
@cvindex AC_CONFIG_LINKS

@item AC_CONFIG_AUX_DIR
Automake will look for various helper scripts, such as
@file{install-sh}, in the directory named in this macro invocation.
@c This list is accurate relative to version 1.8
(The full list of scripts is: @file{config.guess}, @file{config.sub},
@file{depcomp}, @file{elisp-comp}, @file{compile}, @file{install-sh},
@file{ltmain.sh}, @file{mdate-sh}, @file{missing}, @file{mkinstalldirs},
@file{py-compile}, @file{texinfo.tex}, and @file{ylwrap}.)  Not all
scripts are always searched for; some scripts will only be sought if the
generated @file{Makefile.in} requires them.
@cvindex AC_CONFIG_AUX_DIR

If @code{AC_CONFIG_AUX_DIR} is not given, the scripts are looked for in
their @samp{standard} locations.  For @file{mdate-sh},
@file{texinfo.tex}, and @file{ylwrap}, the standard location is the
source directory corresponding to the current @file{Makefile.am}.  For
the rest, the standard location is the first one of @file{.}, @file{..},
or @file{../..} (relative to the top source directory) that provides any
one of the helper scripts.  @xref{Input, , Finding `configure' Input,
autoconf, The Autoconf Manual}.

Required files from @code{AC_CONFIG_AUX_DIR} are automatically
distributed, even if there is no @file{Makefile.am} in this directory.

@item AC_CANONICAL_HOST
Automake will ensure that @file{config.guess} and @file{config.sub}
exist.  Also, the @file{Makefile} variables @samp{host_alias} and
@samp{host_triplet} are introduced.  See @ref{Canonicalizing, ,
Getting the Canonical System Type, autoconf, The Autoconf Manual}.
@cvindex AC_CANONICAL_HOST
@vindex host_alias
@vindex host_triplet

@item AC_CANONICAL_SYSTEM
This is similar to @code{AC_CANONICAL_HOST}, but also defines the
@file{Makefile} variables @samp{build_alias} and @samp{target_alias}.
@xref{Canonicalizing, , Getting the Canonical System Type, autoconf, The
Autoconf Manual}.
@cvindex AC_CANONICAL_SYSTEM
@vindex build_alias
@vindex target_alias

@item AC_LIBSOURCE
@itemx AC_LIBSOURCES
@itemx AC_LIBOBJ
Automake will automatically distribute any file listed in
@code{AC_LIBSOURCE} or @code{AC_LIBSOURCES}.

Note that the @code{AC_LIBOBJ} macro calls @code{AC_LIBSOURCE}.  So if
an Autoconf macro is documented to call @code{AC_LIBOBJ([file])}, then
@file{file.c} will be distributed automatically by Automake.  This
encompasses many macros like @code{AC_FUNC_ALLOCA},
@code{AC_FUNC_MEMCMP}, @code{AC_REPLACE_FUNCS}, and others.
@cvindex AC_LIBOBJ
@cvindex AC_LIBSOURCE
@cvindex AC_LIBSOURCES

By the way, direct assignments to @code{LIBOBJS} are no longer
supported.  You should always use @code{AC_LIBOBJ} for this purpose.
@xref{AC_LIBOBJ vs LIBOBJS, , @code{AC_LIBOBJ} vs. @code{LIBOBJS},
autoconf, The Autoconf Manual}.
@cvindex LIBOBJS

@item AC_PROG_RANLIB
This is required if any libraries are built in the package.
@xref{Particular Programs, , Particular Program Checks, autoconf, The
Autoconf Manual}.
@cvindex AC_PROG_RANLIB

@item AC_PROG_CXX
This is required if any C++ source is included.  @xref{Particular
Programs, , Particular Program Checks, autoconf, The Autoconf Manual}.
@cvindex AC_PROG_CXX

@item AC_PROG_F77
This is required if any Fortran 77 source is included.  This macro is
distributed with Autoconf version 2.13 and later.  @xref{Particular
Programs, , Particular Program Checks, autoconf, The Autoconf Manual}.
@cvindex AC_PROG_F77

@item AC_F77_LIBRARY_LDFLAGS
This is required for programs and shared libraries that are a mixture of
languages that include Fortran 77 (@pxref{Mixing Fortran 77 With C and
C++}).  @xref{Macros, , Autoconf macros supplied with Automake}.
@cvindex AC_F77_LIBRARY_LDFLAGS

@item AC_PROG_FC
This is required if any Fortran 90/95 source is included.  This macro is
distributed with Autoconf version 2.58 and later.  @xref{Particular
Programs, , Particular Program Checks, autoconf, The Autoconf Manual}.
@cvindex AC_PROG_FC

@item AC_PROG_LIBTOOL
Automake will turn on processing for @code{libtool} (@pxref{Top, ,
Introduction, libtool, The Libtool Manual}).
@cvindex AC_PROG_LIBTOOL

@item AC_PROG_YACC
If a Yacc source file is seen, then you must either use this macro or
define the variable @samp{YACC} in @file{configure.ac}.  The former is
preferred (@pxref{Particular Programs, , Particular Program Checks,
autoconf, The Autoconf Manual}).
@cvindex AC_PROG_YACC
@cvindex YACC

@item AC_PROG_LEX
If a Lex source file is seen, then this macro must be used.
@xref{Particular Programs, , Particular Program Checks, autoconf, The
Autoconf Manual}.
@cvindex AC_PROG_LEX

@item AC_SUBST
@cvindex AC_SUBST
The first argument is automatically defined as a variable in each
generated @file{Makefile.in}.  @xref{Setting Output Variables, , Setting
Output Variables, autoconf, The Autoconf Manual}.

If the Autoconf manual says that a macro calls @code{AC_SUBST} for
@var{var}, or defines the output variable @var{var} then @var{var} will
be defined in each @file{Makefile.in} generated by Automake.
E.g. @code{AC_PATH_XTRA} defines @code{X_CFLAGS} and @code{X_LIBS}, so
you can use these variables in any @file{Makefile.am} if
@code{AC_PATH_XTRA} is called.

@item AM_C_PROTOTYPES
This is required when using automatic de-ANSI-fication; see @ref{ANSI}.
@cvindex AM_C_PROTOTYPES

@item AM_GNU_GETTEXT
This macro is required for packages which use GNU gettext
(@pxref{gettext}).  It is distributed with gettext.  If Automake sees
this macro it ensures that the package meets some of gettext's
requirements.
@cvindex AM_GNU_GETTEXT

@item AM_MAINTAINER_MODE
@opindex --enable-maintainer-mode
This macro adds a @samp{--enable-maintainer-mode} option to
@code{configure}.  If this is used, @code{automake} will cause
@samp{maintainer-only} rules to be turned off by default in the
generated @file{Makefile.in}s. This macro defines the
@samp{MAINTAINER_MODE} conditional, which you can use in your own
@file{Makefile.am}.
@cvindex AM_MAINTAINER_MODE

@item m4_include
@cvindex m4_include
Files included by @file{configure.ac} using this macro will be
detected by Automake and automatically distributed.  They will also
appear as dependencies in @file{Makefile} rules.

@code{m4_include} is seldom used by @file{configure.ac} authors, but
can appear in @file{aclocal.m4} when @command{aclocal} detects that
some required macros come from files local to your package (as
opposed to macros installed in a system-wide directory, see
@ref{Invoking aclocal}).

@end table


@node Invoking aclocal
@section Auto-generating aclocal.m4

@cindex Invoking aclocal
@cindex aclocal, Invoking

Automake includes a number of Autoconf macros which can be used in
your package (@pxref{Macros}); some of them are actually required by
Automake in certain situations.  These macros must be defined in your
@file{aclocal.m4}; otherwise they will not be seen by
@command{autoconf}.

The @command{aclocal} program will automatically generate
@file{aclocal.m4} files based on the contents of @file{configure.ac}.
This provides a convenient way to get Automake-provided macros,
without having to search around.  The @command{aclocal} mechanism
allows other packages to supply their own macros (@pxref{Extending
aclocal}).  You can also use it to maintain your own set of custom
macros (@pxref{Local Macros}).

At startup, @command{aclocal} scans all the @file{.m4} files it can
find, looking for macro definitions (@pxref{Macro search path}).  Then
it scans @file{configure.ac}.  Any mention of one of the macros found
in the first step causes that macro, and any macros it in turn
requires, to be put into @file{aclocal.m4}.

@emph{Putting} the file that contains the macro definition into
@file{aclocal.m4} is usually done by copying the entire text of this
file, including unused macro definitions as well as both @samp{#} and
@samp{dnl} comments.  If you want to make a comment which will be
completely ignored by @command{aclocal}, use @samp{##} as the comment
leader.

When a file selected by @command{aclocal} is located in a subdirectory
specified as a relative search path with @command{aclocal}'s @code{-I}
argument, @command{aclocal} assumes the file belongs to the package
and uses @code{m4_include} instead of copying it into
@file{aclocal.m4}.  This makes the package smaller, eases dependency
tracking, and cause the file to be distributed automatically.
(@pxref{Local Macros} for an example.)  Any macro which is found in a
system-wide directory, or via an absolute search path will be copied.
So use @code{-I `pwd`/reldir} instead of @code{-I reldir} whenever
some relative directory need to be considered outside the package.

The contents of @file{acinclude.m4}, if this file exists, are also
automatically included in @file{aclocal.m4}.  We recommend against
using @file{acinclude.m4} in new packages (@pxref{Local Macros}).

@vindex AUTOM4TE
While computing @file{aclocal.m4}, @code{aclocal} runs @code{autom4te}
(@pxref{Using autom4te, , Using @code{Autom4te}, autoconf, The
Autoconf Manual}) in order to trace the macros which are really used,
and omit from @file{aclocal.m4} all macros which are mentioned but
otherwise unexpanded (this can happen when a macro is called
conditionally).  @code{autom4te} is expected to be in the @code{PATH},
just as @code{autoconf}.  Its location can be overridden using the
@code{AUTOM4TE} environment variable.

@menu
* aclocal options::             Options supported by aclocal
* Macro search path::           How aclocal finds .m4 files
@end menu

@node aclocal options
@section aclocal options

@cindex aclocal, Options
@cindex Options, aclocal

@code{aclocal} accepts the following options:

@table @code
@item --acdir=@var{dir}
@opindex --acdir
Look for the macro files in @var{dir} instead of the installation
directory.  This is typically used for debugging.

@item --help
@opindex --help
Print a summary of the command line options and exit.

@item -I @var{dir}
@opindex -I
Add the directory @var{dir} to the list of directories searched for
@file{.m4} files.

@item --force
@opindex --force
Always overwrite the output file.  The default is to overwrite the output
file only when really needed, i.e., when its contents changes or if one
of its dependencies is younger.

@item --output=@var{file}
@opindex --output
Cause the output to be put into @var{file} instead of @file{aclocal.m4}.

@item --print-ac-dir
@opindex --print-ac-dir
Prints the name of the directory which @code{aclocal} will search to
find third-party @file{.m4} files.  When this option is given, normal
processing is suppressed.  This option can be used by a package to
determine where to install a macro file.

@item --verbose
@opindex --verbose
Print the names of the files it examines.

@item --version
@opindex --version
Print the version number of Automake and exit.
@end table

@node Macro search path
@section Macro search path

@cindex Macro search path
@cindex aclocal search path

By default, @command{aclocal} searches for @file{.m4} files in the following
directories, in this order:

@table @code
@item @var{acdir-APIVERSION}
This is where the @file{.m4} macros distributed with automake itself
are stored.  @var{APIVERSION} depends on the automake release used;
for automake 1.6.x, @var{APIVERSION} = @code{1.6}.

@item @var{acdir}
This directory is intended for third party @file{.m4} files, and is
configured when @command{automake} itself is built.  This is
@file{@@datadir@@/aclocal/}, which typically
expands to @file{$@{prefix@}/share/aclocal/}.  To find the compiled-in
value of @var{acdir}, use the @code{--print-ac-dir} option
(@pxref{aclocal options}).
@end table

As an example, suppose that automake-1.6.2 was configured with
@code{--prefix=/usr/local}.  Then, the search path would be:

@enumerate
@item @file{/usr/local/share/aclocal-1.6/}
@item @file{/usr/local/share/aclocal/}
@end enumerate

As explained in (@pxref{aclocal options}), there are several options that
can be used to change or extend this search path.

@subsection Modifying the macro search path: @code{--acdir}

The most obvious option to modify the search path is
@code{--acdir=@var{dir}}, which changes default directory and
drops the @var{APIVERSION} directory.  For example, if one specifies
@code{--acdir=/opt/private/}, then the search path becomes:

@enumerate
@item @file{/opt/private/}
@end enumerate

Note that this option, @code{--acdir}, is intended for use
by the internal automake test suite only; it is not ordinarily
needed by end-users.

@subsection Modifying the macro search path: @code{-I @var{dir}}

Any extra directories specified using @code{-I} options
(@pxref{aclocal options}) are @emph{prepended} to this search list.  Thus,
@code{aclocal -I /foo -I /bar} results in the following search path:

@enumerate
@item @file{/foo}
@item @file{/bar}
@item @var{acdir}-@var{APIVERSION}
@item @var{acdir}
@end enumerate

@subsection Modifying the macro search path: @file{dirlist}
@cindex @file{dirlist}

There is a third mechanism for customizing the search path.  If a
@file{dirlist} file exists in @var{acdir}, then that file is assumed to
contain a list of directories, one per line, to be added to the search
list.  These directories are searched @emph{after} all other
directories.

For example, suppose
@file{@var{acdir}/dirlist} contains the following:

@example
/test1
/test2
@end example

@noindent
and that @code{aclocal} was called with the @code{-I /foo -I /bar} options.
Then, the search path would be

@enumerate
@item @file{/foo}
@item @file{/bar}
@item @var{acdir}-@var{APIVERSION}
@item @var{acdir}
@item @file{/test1}
@item @file{/test2}
@end enumerate

If the @code{--acdir=@var{dir}} option is used, then @command{aclocal}
will search for the @file{dirlist} file in @var{dir}.  In the
@code{--acdir=/opt/private/} example above, @command{aclocal} would look
for @file{/opt/private/dirlist}.  Again, however, the @code{--acdir}
option is intended for use by the internal automake test suite only;
@code{--acdir} is not ordinarily needed by end-users.

@file{dirlist} is useful in the following situation: suppose that
@code{automake} version @code{1.6.2} is installed with
$prefix=/usr by the system vendor. Thus, the default search
directories are

@enumerate
@item @file{/usr/share/aclocal-1.6/}
@item @file{/usr/share/aclocal/}
@end enumerate

However, suppose further that many packages have been manually
installed on the system, with $prefix=/usr/local, as is typical.
In that case, many of these ``extra'' @file{.m4} files are in
@file{/usr/local/share/aclocal}.  The only way to force
@file{/usr/bin/aclocal} to find these ``extra'' @file{.m4} files
is to always call @code{aclocal -I /usr/local/share/aclocal}.
This is inconvenient.  With @file{dirlist}, one may create the file

@file{/usr/share/aclocal/dirlist}

@noindent
which contains only the single line

@file{/usr/local/share/aclocal}

Now, the ``default'' search path on the affected system is

@enumerate
@item @file{/usr/share/aclocal-1.6/}
@item @file{/usr/share/aclocal/}
@item @file{/usr/local/share/aclocal/}
@end enumerate

without the need for @code{-I} options; @code{-I} options can be reserved
for project-specific needs (@file{my-source-dir/m4/}), rather than
using it to work around local system-dependent tool installation
directories.

Similarly, @file{dirlist} can be handy if you have installed a local
copy Automake on your account and want @command{aclocal} to look for
macros installed at other places on the system.


@node Macros
@section Autoconf macros supplied with Automake

Automake ships with several Autoconf macros that you can use from your
@file{configure.ac}.  When you use one of them it will be included by
@code{aclocal} in @file{aclocal.m4}.

@menu
* Public macros::               Macros that you can use.
* Private macros::              Macros that you should not use.
@end menu

@c consider generating the following subsections automatically from m4 files.

@node Public macros
@subsection Public macros

@table @code
@item AM_CONFIG_HEADER
Automake will generate rules to automatically regenerate the config
header.  This obsolete macro is a synonym of @code{AC_CONFIG_HEADERS}
today (@pxref{Optional}).
@cvindex AM_CONFIG_HEADER

@item AM_ENABLE_MULTILIB
This is used when a ``multilib'' library is being built.  The first
optional argument is the name of the @file{Makefile} being generated; it
defaults to @samp{Makefile}.  The second option argument is used to find
the top source directory; it defaults to the empty string (generally
this should not be used unless you are familiar with the internals).
@xref{Multilibs}.

@item AM_C_PROTOTYPES
Check to see if function prototypes are understood by the compiler.  If
so, define @samp{PROTOTYPES} and set the output variables @samp{U} and
@samp{ANSI2KNR} to the empty string.  Otherwise, set @samp{U} to
@samp{_} and @samp{ANSI2KNR} to @samp{./ansi2knr}.  Automake uses these
values to implement automatic de-ANSI-fication.
@cvindex AM_C_PROTOTYPES

@item AM_HEADER_TIOCGWINSZ_NEEDS_SYS_IOCTL
If the use of @code{TIOCGWINSZ} requires @file{<sys/ioctl.h>}, then
define @code{GWINSZ_IN_SYS_IOCTL}.  Otherwise @code{TIOCGWINSZ} can be
found in @file{<termios.h>}.
@cvindex AM_HEADER_TIOCGWINSZ_NEEDS_SYS_IOCTL

@item AM_INIT_AUTOMAKE([OPTIONS])
@itemx AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
Runs many macros required for proper operation of the generated Makefiles.

This macro has two forms, the first of which is preferred.
In this form, @code{AM_INIT_AUTOMAKE} is called with a
single argument --- a space-separated list of Automake options which should
be applied to every @file{Makefile.am} in the tree.  The effect is as if
each option were listed in @code{AUTOMAKE_OPTIONS}.

The second, deprecated, form of @code{AM_INIT_AUTOMAKE} has two required
arguments: the package and the version number.  This form is
obsolete because the @var{package} and @var{version} can be obtained
from Autoconf's @code{AC_INIT} macro (which itself has an old and a new
form).

If your @file{configure.ac} has:
@example
AC_INIT(src/foo.c)
AM_INIT_AUTOMAKE(mumble, 1.5)
@end example
you can modernize it as follows:
@example
AC_INIT(mumble, 1.5)
AC_CONFIG_SRCDIR(src/foo.c)
AM_INIT_AUTOMAKE
@end example

Note that if you're upgrading your @file{configure.ac} from an earlier
version of Automake, it is not always correct to simply move the package
and version arguments from @code{AM_INIT_AUTOMAKE} directly to
@code{AC_INIT}, as in the example above.  The first argument to
@code{AC_INIT} should be the name of your package (e.g. @samp{GNU Automake}),
not the tarball name (e.g. @samp{automake}) that you used to pass to
@code{AM_INIT_AUTOMAKE}.  Autoconf tries to derive a tarball name from
the package name, which should work for most but not all package names.
(If it doesn't work for yours, you can use the
four-argument form of @code{AC_INIT} --- supported in Autoconf versions
greater than 2.52g --- to provide the tarball name explicitly).

By default this macro @code{AC_DEFINE}'s @samp{PACKAGE} and
@samp{VERSION}.  This can be avoided by passing the @samp{no-define}
option, as in:
@example
AM_INIT_AUTOMAKE([gnits 1.5 no-define dist-bzip2])
@end example
or by passing a third non-empty argument to the obsolete form.

@cvindex PACKAGE, prevent definition
@cvindex VERSION, prevent definition


@item AM_PATH_LISPDIR
Searches for the program @code{emacs}, and, if found, sets the output
variable @code{lispdir} to the full path to Emacs' site-lisp directory.

Note that this test assumes the @code{emacs} found to be a version that
supports Emacs Lisp (such as @sc{gnu} Emacs or XEmacs).  Other emacsen
can cause this test to hang (some, like old versions of MicroEmacs,
start up in interactive mode, requiring @samp{C-x C-c} to exit, which
is hardly obvious for a non-emacs user).  In most cases, however, you
should be able to use @samp{C-c} to kill the test.  In order to avoid
problems, you can set @code{EMACS} to ``no'' in the environment, or
use the @samp{--with-lispdir} option to @command{configure} to
explicitly set the correct path (if you're sure you have an @code{emacs}
that supports Emacs Lisp.
@cvindex AM_PATH_LISPDIR

@item AM_PROG_AS
Use this macro when you have assembly code in your project.  This will
choose the assembler for you (by default the C compiler) and set
@code{CCAS}, and will also set @code{CCASFLAGS} if required.

@item AM_PROG_CC_C_O
This is like @code{AC_PROG_CC_C_O}, but it generates its results in the
manner required by automake.  You must use this instead of
@code{AC_PROG_CC_C_O} when you need this functionality.

@item AM_PROG_LEX
@cindex HP-UX 10, lex problems
@cindex lex problems with HP-UX 10
Like @code{AC_PROG_LEX} (@pxref{Particular Programs, , Particular
Program Checks, autoconf, The Autoconf Manual}), but uses the
@code{missing} script on systems that do not have @code{lex}.
@samp{HP-UX 10} is one such system.

@item AM_PROG_GCJ
This macro finds the @code{gcj} program or causes an error.  It sets
@samp{GCJ} and @samp{GCJFLAGS}.  @code{gcj} is the Java front-end to the
GNU Compiler Collection.
@cvindex AM_PROG_GCJ

@item AM_SYS_POSIX_TERMIOS
@cvindex am_cv_sys_posix_termios
@cindex POSIX termios headers
@cindex termios POSIX headers
Check to see if POSIX termios headers and functions are available on the
system.  If so, set the shell variable @code{am_cv_sys_posix_termios} to
@samp{yes}.  If not, set the variable to @samp{no}.

@item AM_WITH_DMALLOC
@cvindex WITH_DMALLOC
@cindex dmalloc, support for
@opindex --with-dmalloc
Add support for the
@uref{ftp://ftp.letters.com/src/dmalloc/dmalloc.tar.gz, dmalloc}
package.  If the user configures with @samp{--with-dmalloc}, then define
@code{WITH_DMALLOC} and add @samp{-ldmalloc} to @code{LIBS}.

@item AM_WITH_REGEX
@cvindex WITH_REGEX
@opindex --with-regex
@cindex regex package
@cindex rx package
Adds @samp{--with-regex} to the @code{configure} command line.  If
specified (the default), then the @samp{regex} regular expression
library is used, @file{regex.o} is put into @samp{LIBOBJS}, and
@samp{WITH_REGEX} is defined.  If @samp{--without-regex} is given, then
the @samp{rx} regular expression library is used, and @file{rx.o} is put
into @samp{LIBOBJS}.

@end table

@node Private macros
@subsection Private macros

The following macros are private macros you should not call directly.
They are called by the other public macros when appropriate.  Do not
rely on them, as they might be changed in a future version.  Consider
them as implementation details; or better, do not consider them at all:
skip this section!

@table @code
@item _AM_DEPENDENCIES
@itemx AM_SET_DEPDIR
@itemx AM_DEP_TRACK
@itemx AM_OUTPUT_DEPENDENCY_COMMANDS
These macros are used to implement Automake's automatic dependency
tracking scheme.  They are called automatically by automake when
required, and there should be no need to invoke them manually.

@item AM_MAKE_INCLUDE
This macro is used to discover how the user's @code{make} handles
@code{include} statements.  This macro is automatically invoked when
needed; there should be no need to invoke it manually.

@item AM_PROG_INSTALL_STRIP
This is used to find a version of @code{install} which can be used to
@code{strip} a program at installation time.  This macro is
automatically included when required.

@item AM_SANITY_CHECK
This checks to make sure that a file created in the build directory is
newer than a file in the source directory.  This can fail on systems
where the clock is set incorrectly.  This macro is automatically run
from @code{AM_INIT_AUTOMAKE}.

@end table


@node Extending aclocal
@section Writing your own aclocal macros

@cindex aclocal, extending
@cindex Extending aclocal

The @command{aclocal} program doesn't have any built-in knowledge of any
macros, so it is easy to extend it with your own macros.

This can be used by libraries which want to supply their own Autoconf
macros for use by other programs.  For instance the @command{gettext}
library supplies a macro @code{AM_GNU_GETTEXT} which should be used by
any package using @command{gettext}.  When the library is installed, it
installs this macro so that @command{aclocal} will find it.

A macro file's name should end in @file{.m4}.  Such files should be
installed in @file{$(datadir)/aclocal}.  This is as simple as writing:

@example
aclocaldir = $(datadir)/aclocal
aclocal_DATA = mymacro.m4 myothermacro.m4
@end example

A file of macros should be a series of properly quoted
@code{AC_DEFUN}'s (@pxref{Macro Definitions, , , autoconf, The
Autoconf Manual}).  The @command{aclocal} programs also understands
@code{AC_REQUIRE} (@pxref{Prerequisite Macros, , , autoconf, The
Autoconf Manual}), so it is safe to put each macro in a separate file.
Each file should have no side effects but macro definitions.
Especially, any call to @code{AC_PREREQ} should be done inside the
defined macro, not at the beginning of the file.

@cindex underquoted AC_DEFUN
@cvindex AC_DEFUN
@cvindex AC_PREREQ

Starting with Automake 1.8, @command{aclocal} will warn about all
underquoted calls to @code{AC_DEFUN}.  We realize this will annoy a
lot of people, because @command{aclocal} was not so strict in the past
and many third party macros are underquoted; and we have to apologize
for this temporary inconvenience.  The reason we have to be stricter
is that a future implementation of @command{aclocal} (@pxref{Future of
aclocal}) will have to temporary include all these third party
@file{.m4} files, maybe several times, even those which are not
actually needed.  Doing so should alleviate many problem of the
current implementation, however it requires a stricter style from the
macro authors.  Hopefully it is easy to revise the existing macros.
For instance
@example
# bad style
AC_PREREQ(2.57)
AC_DEFUN(AX_FOOBAR,
[AC_REQUIRE([AX_SOMETHING])dnl
AX_FOO
AX_BAR
])
@end example
@noindent
should be rewritten as
@example
AC_DEFUN([AX_FOOBAR],
[AC_PREREQ(2.57)dnl
AC_REQUIRE([AX_SOMETHING])dnl
AX_FOO
AX_BAR
])
@end example

Wrapping the @code{AC_PREREQ} call inside the macro ensures that
Autoconf 2.57 will not be required if @code{AX_FOOBAR} is not actually
used.  Most importantly, quoting the first argument of @code{AC_DEFUN}
allows the macro to be redefined or included twice (otherwise this
first argument would be expansed during the second definition).

If you have been directed here by the @command{aclocal} diagnostic but
are not the maintainer of the implicated macro, you will want to
contact the maintainer of that macro.  Please make sure you have the
last version of the macro and that the problem already hasn't been
reported before doing so: people tend to work faster when they aren't
flooded by mails.

Another situation where @command{aclocal} is commonly used is to
manage macros which are used locally by the package, @ref{Local
Macros}.

@node Local Macros
@section Handling Local Macros

Feature tests offered by Autoconf do not cover all needs.  People
often have to supplement existing tests with their own macros, or
with third-party macros.

There are two ways to organize custom macros in a package.

The first possibility (the historical practice) is to list all your
macros in @file{acinclude.m4}.  This file will be included in
@file{aclocal.m4} when you run @command{aclocal}, and its macro(s) will
henceforth be visible to @command{autoconf}.  However if it contains
numerous macros, it will rapidly become difficult to maintain, and it
will be almost impossible to share macros between packages.

@vindex ACLOCAL_AMFLAGS
The second possibility, which we do recommend, is to write each macro
in its own file and gather all these files in a directory.  This
directory is usually called @file{m4/}.  To build @file{aclocal.m4},
one should therefore instruct @command{aclocal} to scan @file{m4/}.
From the command line, this is done with @code{aclocal -I m4}.  The
top-level @file{Makefile.am} should also be updated to define

@example
 ACLOCAL_AMFLAGS = -I m4
@end example

@code{ACLOCAL_AMFLAGS} contains options to pass to @command{aclocal}
when @file{aclocal.m4} is to be rebuilt by @code{make}.  This line is
also used by @command{autoreconf} (@pxref{autoreconf Invocation, ,
Using @command{autoreconf} to Update @file{configure} Scripts,
autoconf, The Autoconf Manual}) to run @command{aclocal} with suitable
options, or by @command{autopoint} (@pxref{autopoint Invocation, ,
Invoking the @command{autopoint} Program, gettext, GNU gettext tools})
and @command{gettextize} (@pxref{gettextize Invocation, , Invoking the
@command{gettextize} Program, gettext, GNU gettext tools}) to locate
the place where Gettext's macros should be installed.  So even if you
do not really care about the rebuild rules, you should define
@code{ACLOCAL_AMFLAGS}.

When @code{aclocal -I m4} is run, it will build a @code{aclocal.m4}
that @code{m4_include}s any file from @file{m4/} that defines a
required macro.  Macros not found locally will still be searched in
system-wide directories, as explained in @ref{Macro search path}.

Custom macros should be distributed for the same reason that
@file{configure.ac} is: so that other people have all the sources of
your package if they want to work on it.  Actually, this distribution
happens automatically because all @code{m4_include}d files are
distributed.

However there is no consensus on the distribution of third-party
macros that your package may use.  Many libraries install their own
macro in the system-wide @command{aclocal} directory (@pxref{Extending
aclocal}).  For instance Guile ships with a file called
@file{guile.m4} that contains the macro @code{GUILE_FLAGS} which can
be used to define setup compiler and linker flags appropriate for
using Guile.  Using @code{GUILE_FLAGS} in @file{configure.ac} will
cause @command{aclocal} to copy @file{guile.m4} into
@file{aclocal.m4}, but as @file{guile.m4} is not part of the project,
it will not be distributed.  Technically, that means a user which
needs to rebuild @file{aclocal.m4} will have to install Guile first.
This is probably OK, if Guile already is a requirement to build the
package.  However, if Guile is only an optional feature, or if your
package might run on architectures where Guile cannot be installed,
this requirement will hinder development.  An easy solution is to copy
such third-party macros in your local @file{m4/} directory so they get
distributed.

@node Future of aclocal
@section The Future of @command{aclocal}
@cindex aclocal's scheduled death

@command{aclocal} is expected to disappear.  This feature really
should not be offered by Automake.  Automake should focus on generating
@file{Makefile}s; dealing with M4 macros really is Autoconf's job.
That some people install Automake just to use @command{aclocal}, but
do not use @command{automake} otherwise is an indication of how that
feature is misplaced.

The new implementation will probably be done slightly differently.
For instance it could enforce the @file{m4/}-style layout discussed in
@ref{Local Macros}, and take care of copying (and even updating)
third-party macros from @file{/usr/share/aclocal/} into the local
@file{m4/} directory.

We have no idea when and how this will happen.  This has been
discussed several times in the past, but someone still has to commit
itself to that non-trivial task.

From the user point of view, @command{aclocal}'s removal might turn
out to be painful.  There is a simple precaution that you may take to
make that switch more seamless: never call @command{aclocal} yourself.
Keep this guy under the exclusive control of @command{autoreconf} and
Automake's rebuild rules.  Hopefully you won't need to worry about
things breaking, when @command{aclocal} disappears, because everything
will have been taken care of.  If otherwise you used to call
@command{aclocal} directly yourself or from some script, you will
quickly notice the change.

Many packages come with a script called @file{bootstrap.sh} or
@file{autogen.sh}, that will just call @command{aclocal},
@command{libtoolize}, @command{gettextize} or @command{autopoint},
@command{autoconf}, @command{autoheader}, and @command{automake} in
the right order.  Actually this is precisely what @command{autoreconf}
can do for you.  If your package has such a @file{bootstrap.sh} or
@file{autogen.sh} script, consider using @command{autoreconf}.  That
should simplify its logic a lot (less things to maintain, yum!), it's
even likely you will not need the script anymore, and more to the point
you will not call @command{aclocal} directly anymore.

For the time being, third-party packages should continue to install
public macros into @code{/usr/share/aclocal/}.  If @command{aclocal}
is replaced by another tool it might make sense to rename the
directory, but supporting @code{/usr/share/aclocal/} for backward
compatibility should be really easy provided all macros are properly
written (@pxref{Extending aclocal}).



@node Directories
@chapter Directories

For simple projects that distributes all files in the same directory
it is enough to have a single @file{Makefile.am} that builds
everything in place.

In larger projects it is common to organize files in different
directories, in a tree.  For instance one directory per program, per
library or per module.  The traditional approach is to build these
subdirectory recursively: each directory contains its @file{Makefile}
(generated from @file{Makefile.am}), and when @command{make} is run
from the top level directory it enters each subdirectory in turn to
build its contents.

@menu
* Subdirectories::              Building subdirectories recursively
* Conditional Subdirectories::  Conditionally not building directories
* Alternative::                 Subdirectories without recursion
* Subpackages::                 Nesting packages
@end menu

@node Subdirectories
@section Recursing subdirectories

@cindex SUBDIRS, explained

In packages with subdirectories, the top level @file{Makefile.am} must
tell Automake which subdirectories are to be built.  This is done via
the @code{SUBDIRS} variable.
@vindex SUBDIRS

The @code{SUBDIRS} variable holds a list of subdirectories in which
building of various sorts can occur.  The rules for many targets
(e.g. @code{all}) in the generated @file{Makefile} will run commands
both locally and in all specified subdirectories.  Note that the
directories listed in @code{SUBDIRS} are not required to contain
@file{Makefile.am}s; only @file{Makefile}s (after configuration).
This allows inclusion of libraries from packages which do not use
Automake (such as @code{gettext}; see also @ref{Third-Party
Makefiles}).

In packages that use subdirectories, the top-level @file{Makefile.am} is
often very short.  For instance, here is the @file{Makefile.am} from the
GNU Hello distribution:

@example
EXTRA_DIST = BUGS ChangeLog.O README-alpha
SUBDIRS = doc intl po src tests
@end example

When Automake invokes @code{make} in a subdirectory, it uses the value
of the @code{MAKE} variable.  It passes the value of the variable
@code{AM_MAKEFLAGS} to the @code{make} invocation; this can be set in
@file{Makefile.am} if there are flags you must always pass to
@code{make}.
@vindex MAKE
@vindex AM_MAKEFLAGS

The directories mentioned in @code{SUBDIRS} are usually direct
children of the current directory, each subdirectory containing its
own @file{Makefile.am} with a @code{SUBDIRS} pointing to deeper
subdirectories.  Automake can be used to construct packages of
arbitrary depth this way.

By default, Automake generates @file{Makefiles} which work depth-first
in postfix order: the subdirectories are built before the current
directory.  However, it is possible to change this ordering.  You can
do this by putting @samp{.} into @code{SUBDIRS}.  For instance,
putting @samp{.}  first will cause a @samp{prefix} ordering of
directories.

Using

@example
SUBDIRS = lib src . test
@end example

@noindent
will cause @file{lib/} to be built before @file{src/}, then the
current directory will be built, finally the @file{test/} directory
will be built.  It is customary to arrange test directories to be
built after everything else since they are meant to test what have
been constructed.

All @samp{clean} rules are run in reverse order of build rules.

@node Conditional Subdirectories
@section Conditional Subdirectories
@cindex Subdirectories, building conditionally
@cindex Conditional subdirectories
@cindex @code{SUBDIRS}, conditional
@cindex Conditional @code{SUBDIRS}

It is possible to define the @code{SUBDIRS} variable conditionally if,
like in the case of GNU @code{Inetutils}, you want to only build a
subset of the entire package.

To illustrate how this works, let's assume we have two directories
@file{src/} and @file{opt/}.  @file{src/} should always be built, but we
want to decide in @code{./configure} whether @file{opt/} will be built
or not.  (For this example we will assume that @file{opt/} should be
built when the variable @code{$want_opt} was set to @code{yes}.)

Running @code{make} should thus recurse into @file{src/} always, and
then maybe in @file{opt/}.

However @code{make dist} should always recurse into both @file{src/}
and @file{opt/}.  Because @file{opt/} should be distributed even if it
is not needed in the current configuration. This means
@file{opt/Makefile} should be created @emph{unconditionally}.

There are two ways to setup a project like this.  You can use Automake
conditionals (@pxref{Conditionals}) or use Autoconf @code{AC_SUBST}
variables (@pxref{Setting Output Variables, , Setting Output
Variables, autoconf, The Autoconf Manual}).  Using Automake
conditionals is the preferred solution.  Before we illustrate these
two possibility, let's introduce @code{DIST_SUBDIRS}.

@subsection @code{SUBDIRS} vs. @code{DIST_SUBDIRS}
@cindex @code{DIST_SUBDIRS}, explained

Automake considers two sets of directories, defined by the variables
@code{SUBDIRS} and @code{DIST_SUBDIRS}.

@code{SUBDIRS} contains the subdirectories of the current directory
that must be built (@pxref{Subdirectories}).  It must be defined
manually; Automake will never guess a directory is to be built.  As we
will see in the next two sections, it is possible to define it
conditionally so that some directory will be omitted from the build.

@code{DIST_SUBDIRS} is used in rules that need to recurse in all
directories, even those which have been conditionally left out of the
build.  Recall our example where we may not want to build subdirectory
@file{opt/}, but yet we want to distribute it?  This is where
@code{DIST_SUBDIRS} come into play: @code{opt} may not appear in
@code{SUBDIRS}, but it must appear in @code{DIST_SUBDIRS}.

Precisely, @code{DIST_SUBDIRS} is used by @code{make dist}, @code{make
distclean}, and @code{make maintainer-clean}.  All other recursive
rules use @code{SUBDIRS}.

If @code{SUBDIRS} is defined conditionally using Automake
conditionals, Automake will define @code{DIST_SUBDIRS} automatically
from the possibles values of @code{SUBDIRS} in all conditions.

If @code{SUBDIRS} contains @code{AC_SUBST} variables,
@code{DIST_SUBDIRS} will not be defined correctly because Automake
does not know the possible values of these variables.  In this case
@code{DIST_SUBDIRS} needs to be defined manually.

@subsection Conditional subdirectories with @code{AM_CONDITIONAL}
@cindex @code{SUBDIRS} and @code{AM_CONDITIONAL}
@cindex @code{AM_CONDITIONAL} and @code{SUBDIRS}

@c The test case for the setup described here is
@c     test/subdircond2.test
@c Try to keep it in sync.

@file{configure} should output the @file{Makefile} for each directory
and define a condition into which @file{opt/} should be built.

@example
@dots{}
AM_CONDITIONAL([COND_OPT], [test "$want_opt" = yes])
AC_CONFIG_FILES([Makefile src/Makefile opt/Makefile])
@dots{}
@end example

Then @code{SUBDIRS} can be defined in the top-level @file{Makefile.am}
as follows.

@example
if COND_OPT
  MAYBE_OPT = opt
endif
SUBDIRS = src $(MAYBE_OPT)
@end example

As you can see, running @code{make} will rightly recurse into
@file{src/} and maybe @file{opt/}.

@vindex DIST_SUBDIRS
As you can't see, running @code{make dist} will recurse into both
@file{src/} and @file{opt/} directories because @code{make dist}, unlike
@code{make all}, doesn't use the @code{SUBDIRS} variable.  It uses the
@code{DIST_SUBDIRS} variable.

In this case Automake will define @code{DIST_SUBDIRS = src opt}
automatically because it knows that @code{MAYBE_OPT} can contain
@code{opt} in some condition.

@subsection Conditional Subdirectories with @code{AC_SUBST}
@cindex @code{SUBDIRS} and @code{AC_SUBST}
@cindex @code{AC_SUBST} and @code{SUBDIRS}

@c The test case for the setup described here is
@c     test/subdircond3.test
@c Try to keep it in sync.

Another possibility is to define @code{MAYBE_OPT} from
@file{./configure} using @code{AC_SUBST}:

@example
@dots{}
if test "$want_opt" = yes; then
  MAYBE_OPT=opt
else
  MAYBE_OPT=
fi
AC_SUBST([MAYBE_OPT])
AC_CONFIG_FILES([Makefile src/Makefile opt/Makefile])
@dots{}
@end example

In this case the top-level @file{Makefile.am} should look as follows.

@example
SUBDIRS = src $(MAYBE_OPT)
DIST_SUBDIRS = src opt
@end example

The drawback is that since Automake cannot guess what the possible
values of @code{MAYBE_OPT} are, it is necessary to define
@code{DIST_SUBDIRS}.

@subsection Non-configured Subdirectories

The semantic of @code{DIST_SUBDIRS} is often misunderstood by some
users that try to @emph{configure and build} subdirectories
conditionally.  Here by configuring we mean creating the
@file{Makefile} (it might also involve running a nested
@command{configure} script: this is a costly operation that explains
why people want to do it conditionally, but only the @file{Makefile}
is relevant to the discussion).

The above examples all assume that every @file{Makefile} is created,
even in directories that are not going to be built.  The simple reason
is that we want @code{make dist} to distribute even the directories
that are not being built (e.g. platform-dependent code), hence
@file{make dist} must recurse into the subdirectory, hence this
directory must be configured and appear in @code{DIST_SUBDIRS}.

Building packages that do not configure every subdirectory is a tricky
business, and we do not recommend it to the novice as it is easy to
produce an incomplete tarball by mistake.  We will not discuss this
topic in depth here, yet for the adventurous there are a few rules to
remember.

@cartouche
@itemize
@item @code{SUBDIRS} should always be a subset of @code{DIST_SUBDIRS}.

It makes little sense to have a directory in @code{SUBDIRS} that
is not in @code{DIST_SUBDIRS}.  Think of the former as a way to tell
which directories listed in the latter should be built.
@item Any directory listed in @code{DIST_SUBDIRS} and @code{SUBDIRS}
must be configured.

I.e., the @file{Makefile} must exists or the recursive @code{make}
rules will not be able to process the directory.
@item Any configured directory must be listed in @code{DIST_SUBDIRS}.

So that the cleaning rule remove the generated @file{Makefile}s.
It would be correct to see @code{DIST_SUBDIRS} as a variable that
lists all the directories that have been configured.
@end itemize
@end cartouche

In order to prevent recursion in some non-configured directory you
must therefore ensure that this directory do not appear in
@code{DIST_SUBDIRS} (and @code{SUBDIRS}).  For instance if you define
@code{SUBDIRS} conditionally using @code{AC_SUBST} and do not define
@code{DIST_SUBDIRS} explicitly, it will be default to
@code{$(SUBDIRS)}; another possibility is to force @code{DIST_SUBDIRS
= $(SUBDIRS)}.

@node Alternative
@section An Alternative Approach to Subdirectories

If you've ever read Peter Miller's excellent paper,
@uref{http://www.pcug.org.au/~millerp/rmch/recu-make-cons-harm.html,
Recursive Make Considered Harmful}, the preceding sections on the use of
subdirectories will probably come as unwelcome advice.  For those who
haven't read the paper, Miller's main thesis is that recursive
@code{make} invocations are both slow and error-prone.

Automake provides sufficient cross-directory support @footnote{We
believe.  This work is new and there are probably warts.
@xref{Introduction}, for information on reporting bugs.} to enable you
to write a single @file{Makefile.am} for a complex multi-directory
package.


By default an installable file specified in a subdirectory will have its
directory name stripped before installation.  For instance, in this
example, the header file will be installed as
@file{$(includedir)/stdio.h}:

@example
include_HEADERS = inc/stdio.h
@end example

@cindex nobase_
@cindex Path stripping, avoiding
@cindex Avoiding path stripping

However, the @samp{nobase_} prefix can be used to circumvent this path
stripping.  In this example, the header file will be installed as
@file{$(includedir)/sys/types.h}:

@example
nobase_include_HEADERS = sys/types.h
@end example

@cindex nobase_ and dist_ or nodist_
@cindex dist_ and nobase_
@cindex nodist_ and nobase_

@samp{nobase_} should be specified first when used in conjunction with
either @samp{dist_} or @samp{nodist_} (@pxref{Dist}).  For instance:

@example
nobase_dist_pkgdata_DATA = images/vortex.pgm
@end example


@node Subpackages
@section Nesting Packages
@cindex Nesting packages
@cindex Subpackages
@cvindex AC_CONFIG_SUBDIRS
@cvindex AC_CONFIG_AUX_DIR


In the GNU Build System, packages can be nested to arbitrary depth.
This means that a package can embedded other packages with their own
@file{configure}, @file{Makefile}s, etc.

These other packages should just appear as subdirectories of their
parent package.  They must be listed in @code{SUBDIRS} like other
ordinary directories.  However the subpackage's @file{Makefile}s
should be output by its own @file{configure} script, not by the
parent's @file{configure}.  This is achieved using the
@code{AC_CONFIG_SUBDIRS} Autoconf macro (@pxref{Subdirectories,
AC_CONFIG_SUBDIRS, Configuring Other Packages in Subdirectories,
autoconf, The Autoconf Manual}).

Here is an example package for an @code{arm} program that links with
an @code{hand} library that is a nested package in subdirectory
@file{hand/}.

@code{arm}'s @file{configure.ac}:

@example
AC_INIT([arm], [1.0])
AC_CONFIG_AUX_DIR([.])
AM_INIT_AUTOMAKE
AC_PROG_CC
AC_CONFIG_FILES([Makefile])
# Call hand's ./configure script recursively.
AC_CONFIG_SUBDIRS([hand])
AC_OUTPUT
@end example

@code{arm}'s @file{Makefile.am}:

@example
# Build the library in the hand subdirectory first.
SUBDIRS = hand

# Include hand's header when compiling this directory.
AM_CPPFLAGS = -I$(srcdir)/hand

bin_PROGRAMS = arm
arm_SOURCES = arm.c
# link with the hand library.
arm_LDADD = hand/libhand.a
@end example

Now here is @code{hand}'s @file{hand/configure.ac}:

@example
AC_INIT([hand], [1.2])
AC_CONFIG_AUX_DIR([.])
AM_INIT_AUTOMAKE
AC_PROG_CC
AC_PROG_RANLIB
AC_CONFIG_FILES([Makefile])
AC_OUTPUT
@end example

@noindent
and its @file{hand/Makefile.am}:

@example
lib_LIBRARIES = libhand.a
libhand_a_SOURCES = hand.c
@end example

When @code{make dist} is run from the top-level directory it will
create an archive @file{arm-1.0.tar.gz} that contains the @code{arm}
code as well as the @file{hand} subdirectory.  This package can be
built and installed like any ordinary package, with the usual
@code{./configure && make && make install} sequence (the @code{hand}
subpackage will be built and installed by the process).

When @code{make dist} is run from the hand directory, it will create a
self-contained @file{hand-1.2.tar.gz} archive.  So although it appears
to be embedded in another package, it can still be used separately.

The purpose of the @code{AC_CONFIG_AUX_DIR([.])} instruction is to
force Automake and Autoconf into search auxiliary script in the
current directory.  For instance this means that there will be two
copies of @file{install-sh}: one in the top-level of the @code{arm}
package, and another one in the @file{hand/} subdirectory for the
@code{hand} package.

The historical default is to search these auxiliary scripts in the
immediate parent and grand-parent directories.  So if the
@code{AC_CONFIG_AUX_DIR([.])} line was removed from
@file{hand/configure.ac}, that subpackage would share the auxiliary
script of the @code{arm} package.  This may looks like a gain in size
(a few kilobytes), but it is actually a loss of modularity as the
@code{hand} subpackage is no longer self-contained (@code{make dist}
in the subdirectory will not work anymore).

Packages that do not use Automake need more work to be integrated this
way.  @xref{Third-Party Makefiles}.

@node Programs
@chapter Building Programs and Libraries

A large part of Automake's functionality is dedicated to making it easy
to build programs and libraries.

@menu
* A Program::                   Building a program
* A Library::                   Building a library
* A Shared Library::            Building a Libtool library
* Program and Library Variables::  Variables controlling program and
                                library builds
* Default _SOURCES::            Default source files
* LIBOBJS::                     Special handling for LIBOBJS and ALLOCA
* Program variables::           Variables used when building a program
* Yacc and Lex::                Yacc and Lex support
* C++ Support::                 Compiling C++ sources
* Assembly Support::            Compiling assembly sources
* Fortran 77 Support::          Compiling Fortran 77 sources
* Fortran 9x Support::          Compiling Fortran 9x sources
* Java Support::                Compiling Java sources
* Support for Other Languages::  Compiling other languages
* ANSI::                        Automatic de-ANSI-fication
* Dependencies::                Automatic dependency tracking
* EXEEXT::                      Support for executable extensions
@end menu


@node A Program
@section Building a program

In order to build a program, you need to tell Automake which sources
are part of it, and which libraries it should be linked with.

This section also covers conditional compilation of sources or
programs.  Most of the comments about these also apply to libraries
(@pxref{A Library}) and libtool libraries (@pxref{A Shared Library}).

@menu
* Program Sources::             Defining program sources
* Linking::                     Linking with libraries or extra objects
* Conditional Sources::         Handling conditional sources
* Conditional Programs::        Building program conditionally
@end menu

@node Program Sources
@subsection Defining program sources

@cindex PROGRAMS, bindir
@vindex bin_PROGRAMS
@vindex sbin_PROGRAMS
@vindex libexec_PROGRAMS
@vindex pkglib_PROGRAMS
@vindex noinst_PROGRAMS
@vindex check_PROGRAMS

In a directory containing source that gets built into a program (as
opposed to a library or a script), the @samp{PROGRAMS} primary is used.
Programs can be installed in @code{bindir}, @code{sbindir},
@code{libexecdir}, @code{pkglibdir}, or not at all (@samp{noinst}).
They can also be built only for @code{make check}, in which case the
prefix is @samp{check}.

For instance:

@example
bin_PROGRAMS = hello
@end example

In this simple case, the resulting @file{Makefile.in} will contain code
to generate a program named @code{hello}.

Associated with each program are several assisting variables which are
named after the program.  These variables are all optional, and have
reasonable defaults.  Each variable, its use, and default is spelled out
below; we use the ``hello'' example throughout.

The variable @code{hello_SOURCES} is used to specify which source files
get built into an executable:

@example
hello_SOURCES = hello.c version.c getopt.c getopt1.c getopt.h system.h
@end example

This causes each mentioned @samp{.c} file to be compiled into the
corresponding @samp{.o}.  Then all are linked to produce @file{hello}.

@cindex _SOURCES primary, defined
@cindex SOURCES primary, defined
@cindex Primary variable, SOURCES

If @samp{hello_SOURCES} is not specified, then it defaults to the single
file @file{hello.c} (@pxref{Default _SOURCES}).
@vindex _SOURCES
@vindex SOURCES

Multiple programs can be built in a single directory.  Multiple programs
can share a single source file, which must be listed in each
@samp{_SOURCES} definition.

@cindex Header files in _SOURCES
@cindex _SOURCES and header files

Header files listed in a @samp{_SOURCES} definition will be included in
the distribution but otherwise ignored.  In case it isn't obvious, you
should not include the header file generated by @file{configure} in a
@samp{_SOURCES} variable; this file should not be distributed.  Lex
(@samp{.l}) and Yacc (@samp{.y}) files can also be listed; see @ref{Yacc
and Lex}.


@node Linking
@subsection Linking the program

If you need to link against libraries that are not found by
@code{configure}, you can use @code{LDADD} to do so.  This variable is
used to specify additional objects or libraries to link with; it is
inappropriate for specifying specific linker flags, you should use
@code{AM_LDFLAGS} for this purpose.
@vindex LDADD
@vindex AM_LDFLAGS

@cindex prog_LDADD, defined

Sometimes, multiple programs are built in one directory but do not share
the same link-time requirements.  In this case, you can use the
@samp{@var{prog}_LDADD} variable (where @var{prog} is the name of the
program as it appears in some @samp{_PROGRAMS} variable, and usually
written in lowercase) to override the global @code{LDADD}.  If this
variable exists for a given program, then that program is not linked
using @code{LDADD}.
@vindex _LDADD

For instance, in GNU cpio, @code{pax}, @code{cpio} and @code{mt} are
linked against the library @file{libcpio.a}.  However, @code{rmt} is
built in the same directory, and has no such link requirement.  Also,
@code{mt} and @code{rmt} are only built on certain architectures.  Here
is what cpio's @file{src/Makefile.am} looks like (abridged):

@example
bin_PROGRAMS = cpio pax $(MT)
libexec_PROGRAMS = $(RMT)
EXTRA_PROGRAMS = mt rmt

LDADD = ../lib/libcpio.a $(INTLLIBS)
rmt_LDADD =

cpio_SOURCES = @dots{}
pax_SOURCES = @dots{}
mt_SOURCES = @dots{}
rmt_SOURCES = @dots{}
@end example

@cindex _LDFLAGS, defined

@samp{@var{prog}_LDADD} is inappropriate for passing program-specific
linker flags (except for @samp{-l}, @samp{-L}, @samp{-dlopen} and
@samp{-dlpreopen}).  So, use the @samp{@var{prog}_LDFLAGS} variable for
this purpose.
@vindex _LDFLAGS

@cindex _DEPENDENCIES, defined

It is also occasionally useful to have a program depend on some other
target which is not actually part of that program.  This can be done
using the @samp{@var{prog}_DEPENDENCIES} variable.  Each program depends
on the contents of such a variable, but no further interpretation is
done.

If @samp{@var{prog}_DEPENDENCIES} is not supplied, it is computed by
Automake.  The automatically-assigned value is the contents of
@samp{@var{prog}_LDADD}, with most configure substitutions, @samp{-l},
@samp{-L}, @samp{-dlopen} and @samp{-dlpreopen} options removed.  The
configure substitutions that are left in are only @samp{$(LIBOBJS)} and
@samp{$(ALLOCA)}; these are left because it is known that they will not
cause an invalid value for @samp{@var{prog}_DEPENDENCIES} to be
generated.


@node Conditional Sources
@subsection Conditional compilation of sources

You can't put a configure substitution (e.g., @samp{@@FOO@@} or
@samp{$(FOO)} where @code{FOO} is defined via @code{AC_SUBST}) into a
@samp{_SOURCES} variable.  The reason for this is a bit hard to
explain, but suffice to say that it simply won't work.  Automake will
give an error if you try to do this.

Fortunately there are two other ways to achieve the same result.  One is
to use configure substitutions in @code{_LDADD} variables, the other is
to use an Automake conditional.

@subsubsection Conditional compilation using @code{_LDADD} substitutions

@cindex EXTRA_prog_SOURCES, defined

Automake must know all the source files that could possibly go into a
program, even if not all the files are built in every circumstance.  Any
files which are only conditionally built should be listed in the
appropriate @samp{EXTRA_} variable.  For instance, if
@file{hello-linux.c} or @file{hello-generic.c} were conditionally included
in @code{hello}, the @file{Makefile.am} would contain:

@example
bin_PROGRAMS = hello
hello_SOURCES = hello-common.c
EXTRA_hello_SOURCES = hello-linux.c hello-generic.c
hello_LDADD = $(HELLO_SYSTEM)
hello_DEPENDENCIES = $(HELLO_SYSTEM)
@end example

@noindent
You can then setup the @code{$(HELLO_SYSTEM)} substitution from
@file{configure.ac}:

@example
@dots{}
case $host in
  *linux*) HELLO_SYSTEM='hello-linux.$(OBJEXT)' ;;
  *)       HELLO_SYSTEM='hello-generic.$(OBJEXT)' ;;
esac
AC_SUBST([HELLO_SYSTEM])
@dots{}
@end example

In this case, @code{HELLO_SYSTEM} should be replaced by
@file{hello-linux.o} or @file{hello-generic.o}, and added to
@code{hello_DEPENDENCIES} and @code{hello_LDADD} in order to be built
and linked in.

@subsubsection Conditional compilation using Automake conditionals

An often simpler way to compile source files conditionally is to use
Automake conditionals.  For instance, you could use this
@file{Makefile.am} construct to build the same @file{hello} example:

@example
bin_PROGRAMS = hello
if LINUX
hello_SOURCES = hello-linux.c hello-common.c
else
hello_SOURCES = hello-generic.c hello-common.c
endif
@end example

In this case, your @file{configure.ac} should setup the @code{LINUX}
conditional using @code{AM_CONDITIONAL} (@pxref{Conditionals}).

When using conditionals like this you don't need to use the
@samp{EXTRA_} variable, because Automake will examine the contents of
each variable to construct the complete list of source files.

If your program uses a lot of files, you will probably prefer a
conditional @code{+=}.

@example
bin_PROGRAMS = hello
hello_SOURCES = hello-common.c
if LINUX
hello_SOURCES += hello-linux.c
else
hello_SOURCES += hello-generic.c
endif
@end example

@node Conditional Programs
@subsection Conditional compilation of programs
@cindex Conditional programs
@cindex Programs, conditional

Sometimes it is useful to determine the programs that are to be built
at configure time.  For instance, GNU @code{cpio} only builds
@code{mt} and @code{rmt} under special circumstances.  The means to
achieve conditional compilation of programs are the same you can use
to compile source files conditionally: substitutions or conditionals.

@subsubsection Conditional programs using @code{configure} substitutions

In this case, you must notify Automake of all the programs that can
possibly be built, but at the same time cause the generated
@file{Makefile.in} to use the programs specified by @code{configure}.
This is done by having @code{configure} substitute values into each
@samp{_PROGRAMS} definition, while listing all optionally built programs
in @code{EXTRA_PROGRAMS}.
@vindex EXTRA_PROGRAMS
@cindex EXTRA_PROGRAMS, defined

@example
bin_PROGRAMS = cpio pax $(MT)
libexec_PROGRAMS = $(RMT)
EXTRA_PROGRAMS = mt rmt
@end example

As explained in @ref{EXEEXT}, Automake will rewrite
@code{bin_PROGRAMS}, @code{libexec_PROGRAMS}, and
@code{EXTRA_PROGRAMS}, appending @code{$(EXEEXT)} to each binary.
Obviously it cannot rewrite values obtained at run-time through
@code{configure} substitutions, therefore you should take care of
appending @code{$(EXEEXT)} yourself, as in @code{AC_SUBST([MT],
['mt$@{EXEEXT@}'])}.

@subsubsection Conditional programs using Automake conditionals

You can also use Automake conditionals (@pxref{Conditionals}) to
select programs to be built.  In this case you don't have to worry
about @code{$(EXEEXT)} or @code{EXTRA_PROGRAMS}.

@example
bin_PROGRAMS = cpio pax
if WANT_MT
  bin_PROGRAMS += mt
endif
if WANT_RMT
  libexec_PROGRAMS = rmt
endif
@end example


@node A Library
@section Building a library

@cindex _LIBRARIES primary, defined
@cindex LIBRARIES primary, defined
@cindex Primary variable, LIBRARIES

@vindex lib_LIBRARIES
@vindex pkglib_LIBRARIES
@vindex noinst_LIBRARIES

Building a library is much like building a program.  In this case, the
name of the primary is @samp{LIBRARIES}.  Libraries can be installed in
@code{libdir} or @code{pkglibdir}.

@xref{A Shared Library}, for information on how to build shared
libraries using libtool and the @samp{LTLIBRARIES} primary.

Each @samp{_LIBRARIES} variable is a list of the libraries to be built.
For instance to create a library named @file{libcpio.a}, but not install
it, you would write:

@example
noinst_LIBRARIES = libcpio.a
@end example

The sources that go into a library are determined exactly as they are
for programs, via the @samp{_SOURCES} variables.  Note that the library
name is canonicalized (@pxref{Canonicalization}), so the @samp{_SOURCES}
variable corresponding to @file{liblob.a} is @samp{liblob_a_SOURCES},
not @samp{liblob.a_SOURCES}.

@cindex _LIBADD primary, defined
@cindex LIBADD primary, defined
@cindex Primary variable, LIBADD

Extra objects can be added to a library using the
@samp{@var{library}_LIBADD} variable.  This should be used for objects
determined by @code{configure}.  Again from @code{cpio}:
@vindex _LIBADD
@vindex LIBADD

@example
libcpio_a_LIBADD = $(LIBOBJS) $(ALLOCA)
@end example

In addition, sources for extra objects that will not exist until
configure-time must be added to the @code{BUILT_SOURCES} variable
(@pxref{Sources}).

Building a static library is done by compiling all object files, then
by invoking @code{$(AR) $(ARFLAGS)} followed by the name of the
library and the list of objects, and finally by calling
@code{$(RANLIB)} on that library.  You should call
@code{AC_PROG_RANLIB} from your @file{configure.ac} to define
@code{RANLIB} (Automake will complain otherwise).  @code{AR} and
@code{ARFLAGS} default to @code{ar} and @code{cru} respectively; you
can override these two variables my setting them in your
@file{Makefile.am}, by @code{AC_SUBST}ing them from your
@file{configure.ac}, or by defining a per-library @code{maude_AR}
variable (@pxref{Program and Library Variables}).

@node A Shared Library
@section Building a Shared Library

@cindex Shared libraries, support for

Building shared libraries portably is a relatively complex matter.
For this reason, GNU Libtool (@pxref{Top, , Introduction, libtool, The
Libtool Manual}) was created to help build shared libraries in a
platform-independent way.

@menu
* Libtool Concept::             Introducing Libtool
* Libtool Libraries::           Declaring Libtool Libraries
* Conditional Libtool Libraries::  Building Libtool Libraries Conditionally
* Conditional Libtool Sources::  Choosing Library Sources Conditionally
* Libtool Convenience Libraries::  Building Convenience Libtool Libraries
* Libtool Modules::             Building Libtool Modules
* Libtool Flags::               Using _LIBADD and _LDFLAGS
* LTLIBOBJ::                    Using $(LTLIBOBJ)
* Libtool Issues::              Common Issues Related to Libtool's Use
@end menu

@node Libtool Concept
@subsection The Libtool Concept

@cindex libtool, introduction
@cindex libtool library, definition
@cindex suffix .la, defined
@cindex .la suffix, defined

Libtool abstracts shared and static libraries into a unified
concept henceforth called @dfn{libtool libraries}.  Libtool libraries
are files using the @file{.la} suffix, and can designate a static
library, a shared library, or maybe both.  Their exact nature cannot
be determined until @file{./configure} is run: not all platforms
support all kinds of libraries, and users can explicitly select which
libraries should be built.  (However the package's maintainers can
tune the default, @xref{AC_PROG_LIBTOOL, , The @code{AC_PROG_LIBTOOL}
macro, libtool, The Libtool Manual}.)

@cindex suffix .lo, defined
Because object files for shared and static libraries must be compiled
differently, libtool is also used during compilation.  Object files
built by libtool are called @dfn{libtool objects}: these are files
using the @file{.lo} suffix.  Libtool libraries are built from these
libtool objects.

You should not assume anything about the structure of @file{.la} or
@file{.lo} files and how libtool constructs them: this is libtool's
concern, and the last thing one wants is to learn about libtool's
guts.  However the existence of these files matters, because they are
used as targets and dependencies in @file{Makefile}s rules when
building libtool libraries.  There are situations where you may have
to refer to these, for instance when expressing dependencies for
building source files conditionally (@pxref{Conditional Libtool
Sources}).

@cindex libltdl, introduction

People considering writing a plug-in system, with dynamically loaded
modules, should look into @file{libltdl}: libtool's dlopening library
(@pxref{Using libltdl, , Using libltdl, libtool, The Libtool Manual}).
This offers a portable dlopening facility to load libtool libraries
dynamically, and can also achieve static linking where unavoidable.

Before we discuss how to use libtool with Automake in details, it
should be noted that the libtool manual also has a section about how
to use Automake with libtool (@pxref{Using Automake, , Using Automake
with Libtool, libtool, The Libtool Manual}).

@node Libtool Libraries
@subsection Building Libtool Libraries

@cindex _LTLIBRARIES primary, defined
@cindex LTLIBRARIES primary, defined
@cindex Primary variable, LTLIBRARIES
@cindex Example of shared libraries
@vindex lib_LTLIBRARIES
@vindex pkglib_LTLIBRARIES

Automake uses libtool to build libraries declared with the
@samp{LTLIBRARIES} primary.  Each @samp{_LTLIBRARIES} variable is a
list of libtool libraries to build.  For instance, to create a libtool
library named @file{libgettext.la}, and install it in @samp{libdir},
write:

@example
lib_LTLIBRARIES = libgettext.la
libgettext_la_SOURCES = gettext.c gettext.h @dots{}
@end example

Automake predefines the variable @samp{pkglibdir}, so you can use
@code{pkglib_LTLIBRARIES} to install libraries in
@code{$(libdir)/@@PACKAGE@@/}.

@node Conditional Libtool Libraries
@subsection Building Libtool Libraries Conditionally
@cindex libtool libraries, conditional
@cindex conditional libtool libraries

Like conditional programs (@pxref{Conditional Programs}), there are
two main ways to build conditional libraries: using Automake
conditionals or using Autoconf @code{AC_SUBST}itutions.

The important implementation detail you have to be aware of is that
the place where a library will be installed matters to libtool: it
needs to be indicated @emph{at link-time} using the @code{-rpath}
option.

For libraries whose destination directory is known when Automake runs,
Automake will automatically supply the appropriate @samp{-rpath}
option to libtool. This is the case for libraries listed explicitly in
some installable @code{_LTLIBRARIES} variables such as
@code{lib_LTLIBRARIES}.

However, for libraries determined at configure time (and thus
mentioned in @code{EXTRA_LTLIBRARIES}), Automake does not know the
final installation directory.  For such libraries you must add the
@samp{-rpath} option to the appropriate @samp{_LDFLAGS} variable by
hand.

The examples below illustrate the differences between these two methods.

Here is an example where @code{$(WANTEDLIBS)} is an @code{AC_SUBST}ed
variable set at @file{./configure}-time to either @file{libfoo.la},
@file{libbar.la}, both, or none.  Although @code{$(WANTEDLIBS)}
appears in the @code{lib_LTLIBRARIES}, Automake cannot guess it
relates to @file{libfoo.la} or @file{libbar.la} by the time it creates
the link rule for these two libraries.  Therefore the @code{-rpath}
argument must be explicitly supplied.

@example
EXTRA_LTLIBRARIES = libfoo.la libbar.la
lib_LTLIBRARIES = $(WANTEDLIBS)
libfoo_la_SOURCES = foo.c @dots{}
libfoo_la_LDFLAGS = -rpath '$(libdir)'
libbar_la_SOURCES = bar.c @dots{}
libbar_la_LDFLAGS = -rpath '$(libdir)'
@end example

Here is how the same @file{Makefile.am} would look using Automake
conditionals named @code{WANT_LIBFOO} and @code{WANT_LIBBAR}.  Now
Automake is able to compute the @code{-rpath} setting itself, because
it's clear that both libraries will end up in @code{$(libdir)} if they
are installed.

@example
lib_LTLIBRARIES =
if WANT_LIBFOO
lib_LTLIBRARIES += libfoo.la
endif
if WANT_LIBBAR
lib_LTLIBRARIES += libbar.la
endif
libfoo_la_SOURCES = foo.c @dots{}
libbar_la_SOURCES = bar.c @dots{}
@end example

@node Conditional Libtool Sources
@subsection Libtool Libraries with Conditional Sources

Conditional compilation of sources in a library can be achieved in the
same way as conditional compilation of sources in a program
(@pxref{Conditional Sources}).  The only difference is that
@code{_LIBADD} should be used instead of @code{_LDADD} and that it
should mention libtool objects (@file{.lo} files).

So, to mimic the @file{hello} example from @ref{Conditional Sources},
we could build a @file{libhello.la} library using either
@file{hello-linux.c} or @file{hello-generic.c} with the following
@file{Makefile.am}.

@example
lib_LTLIBRARIES = libhello.la
libhello_la_SOURCES = hello-common.c
EXTRA_libhello_la_SOURCES = hello-linux.c hello-generic.c
libhello_la_LIBADD = $(HELLO_SYSTEM)
libhello_la_DEPENDENCIES = $(HELLO_SYSTEM)
@end example

@noindent
And make sure @code{$(HELLO_SYSTEM)} is set to either
@file{hello-linux.lo} or @file{hello-generic.lo} in
@file{./configure}.

Or we could simply use an Automake conditional as follows.

@example
lib_LTLIBRARIES = libhello.la
libhello_la_SOURCES = hello-common.c
if LINUX
libhello_la_SOURCES += hello-linux.c
else
libhello_la_SOURCES += hello-generic.c
endif
@end example

@node Libtool Convenience Libraries
@subsection Libtool Convenience Libraries
@cindex convenience libraries, libtool
@cindex libtool convenience libraries
@vindex noinst_LTLIBRARIES
@vindex check_LTLIBRARIES

Sometimes you want to build libtool libraries which should not be
installed.  These are called @dfn{libtool convenience libraries} and
are typically used to encapsulate many sublibraries, later gathered
into one big installed library.

Libtool convenience libraries are declared by
@code{noinst_LTLIBRARIES}, @code{check_LTLIBRARIES}, or even
@code{EXTRA_LTLIBRARIES}.  Unlike installed libtool libraries they do
not need an @code{-rpath} flag at link time (actually this is the only
difference).

Convenience libraries listed in @code{noinst_LTLIBRARIES} are always
built.  Those listed in @code{check_LTLIBRARIES} are built only upon
@code{make check}.  Finally, libraries listed in
@code{EXTRA_LTLIBRARIES} are never built explicitly: Automake outputs
rules to build them, but if the library does not appear as a Makefile
dependency anywhere it won't be built (this is why
@code{EXTRA_LTLIBRARIES} is used for conditional compilation).

Here is a sample setup merging libtool convenience libraries from
subdirectories into one main @file{libtop.la} library.

@example
# -- Top-level Makefile.am --
SUBDIRS = sub1 sub2 @dots{}
lib_LTLIBRARIES = libtop.la
libtop_la_SOURCES =
libtop_la_LIBADD = \
  sub1/libsub1.la \
  sub2/libsub2.la \
  @dots{}

# -- sub1/Makefile.am --
noinst_LTLIBRARIES = libsub1.la
libsub1_la_SOURCES = @dots{}

# -- sub2/Makefile.am --
# showing nested convenience libraries
SUBDIRS = sub2.1 sub2.2 @dots{}
noinst_LTLIBRARIES = libsub2.la
libsub2_la_SOURCES =
libsub2_la_LIBADD = \
  sub21/libsub21.la \
  sub22/libsub22.la \
  @dots{}
@end example

@node Libtool Modules
@subsection Libtool Modules
@cindex modules, libtool
@cindex libtool modules
@cindex -module, libtool

These are libtool libraries meant to be dlopened.  They are
indicated to libtool by passing @code{-module} at link-time.

@example
pkglib_LTLIBRARIES = mymodule.la
mymodule_la_SOURCES = doit.c
mymodule_la_LDFLAGS = -module
@end example

Ordinarily, Automake requires that a Library's name starts with
@samp{lib}.  However, when building a dynamically loadable module you
might wish to use a "nonstandard" name.

If @samp{mymodule_la_SOURCES} is not specified, then it defaults to the single
file @file{mymodule.c} (@pxref{Default _SOURCES}).

@node Libtool Flags
@subsection _LIBADD and _LDFLAGS
@cindex _LIBADD, libtool
@cindex _LDFLAGS, libtool

As shown in previous sections, the @samp{@var{library}_LIBADD}
variable should be used to list extra libtool objects (@file{.lo}
files) or libtool libraries (@file{.la}) to add to @var{library}.

The @samp{@var{library}_LDFLAGS} variable is the place to list
additional libtool flags, such as @samp{-version-info},
@samp{-static}, and a lot more.  See @xref{Link mode, , Using libltdl,
libtool, The Libtool Manual}.

@node LTLIBOBJ, Libtool Issues, Libtool Flags, A Shared Library
@subsection @code{LTLIBOBJS}
@cindex @code{LTLIBOBJS}, special handling
@vindex LTLIBOBJS
@vindex LIBOBJS
@cvindex AC_LIBOBJ

Where an ordinary library might include @code{$(LIBOBJS)}, a libtool
library must use @code{$(LTLIBOBJS)}.  This is required because the
object files that libtool operates on do not necessarily end in
@file{.o}.

Nowadays, the computation of @code{LTLIBOBJS} from @code{LIBOBJS} is
performed automatically by Autoconf (@pxref{AC_LIBOBJ vs LIBOBJS, ,
@code{AC_LIBOBJ} vs. @code{LIBOBJS}, autoconf, The Autoconf Manual}).

@node Libtool Issues
@subsection Common Issues Related to Libtool's Use

@subsubsection @code{required file `./ltmain.sh' not found}
@cindex ltmain.sh not found
@cindex libtoolize, no longer run by Automake
@cindex libtoolize and autoreconf
@cindex autoreconf and libtoolize
@cindex bootstrap.sh and autoreconf
@cindex autogen.sh and autoreconf

Libtool comes with a tool called @command{libtoolize} that will
install libtool's supporting files into a package.  Running this
command will install @file{ltmain.sh}.  You should execute it before
@command{aclocal} and @command{automake}.

People upgrading old packages to newer autotools are likely to face
this issue because older Automake versions used to call
@command{libtoolize}.  Therefore old build scripts do not call
@command{libtoolize}.

Since Automake 1.6, it has been decided that running
@command{libtoolize} was none of Automake's business.  Instead, that
functionality has been moved into the @command{autoreconf} command
(@pxref{autoreconf Invocation, , Using @command{autoreconf}, autoconf,
The Autoconf Manual}).  If you do not want to remember what to run and
when, just learn the @command{autoreconf} command.  Hopefully,
replacing existing @file{bootstrap.sh} or @file{autogen.sh} scripts by
a call to @command{autoreconf} should also free you from any similar
incompatible change in the future.

@subsubsection Objects @code{created with both libtool and without}

Sometimes, the same source file is used both to build a libtool
library and to build another non-libtool target (be it a program or
another library).

Let's consider the following @file{Makefile.am}.

@example
bin_PROGRAMS = prog
prog_SOURCES = prog.c foo.c @dots{}

lib_LTLIBRARIES = libfoo.la
libfoo_la_SOURCES = foo.c @dots{}
@end example

@noindent
(In this trivial case the issue could be avoided by linking
@file{libfoo.la} with @file{prog} instead of listing @file{foo.c} in
@code{prog_SOURCES}.  But let's assume we really want to keep
@file{prog} and @file{libfoo.la} separate.)

Technically, it means that we should build @file{foo.$(OBJEXT)} for
@file{prog}, and @file{foo.lo} for @file{libfoo.la}.  The problem is
that in the course of creating @file{foo.lo}, libtool may erase (or
replace) @file{foo.$(OBJEXT)} -- and this cannot be avoided.

Therefore, when Automake detects this situation it will complain
with a message such as
@example
object `foo.$(OBJEXT)' created both with libtool and without
@end example

A workaround for this issue is to ensure that these two objects get
different basenames.  As explained in @ref{renamed objects}, this
happens automatically when per-targets flags are used.

@example
bin_PROGRAMS = prog
prog_SOURCES = prog.c foo.c @dots{}
prog_CFLAGS = $(AM_CFLAGS)

lib_LTLIBRARIES = libfoo.la
libfoo_la_SOURCES = foo.c @dots{}
@end example

@noindent
Adding @code{prog_CFLAGS = $(AM_CFLAGS)} is almost a no-op, because
when the @code{prog_CFLAGS} is defined, it is used instead of
@code{AM_CFLAGS}.  However as a side effect it will cause
@file{prog.c} and @file{foo.c} to be compiled as
@file{prog-prog.$(OBJEXT)} and @file{prog-foo.$(OBJEXT)} which solves
the issue.

@node Program and Library Variables
@section Program and Library Variables

Associated with each program are a collection of variables which can be
used to modify how that program is built.  There is a similar list of
such variables for each library.  The canonical name of the program (or
library) is used as a base for naming these variables.

In the list below, we use the name ``maude'' to refer to the program or
library.  In your @file{Makefile.am} you would replace this with the
canonical name of your program.  This list also refers to ``maude'' as a
program, but in general the same rules apply for both static and dynamic
libraries; the documentation below notes situations where programs and
libraries differ.

@table @samp
@item maude_SOURCES
This variable, if it exists, lists all the source files which are
compiled to build the program.  These files are added to the
distribution by default.  When building the program, Automake will cause
each source file to be compiled to a single @file{.o} file (or
@file{.lo} when using libtool).  Normally these object files are named
after the source file, but other factors can change this.  If a file in
the @samp{_SOURCES} variable has an unrecognized extension, Automake
will do one of two things with it.  If a suffix rule exists for turning
files with the unrecognized extension into @file{.o} files, then
automake will treat this file as it will any other source file
(@pxref{Support for Other Languages}).  Otherwise, the file will be
ignored as though it were a header file.

The prefixes @samp{dist_} and @samp{nodist_} can be used to control
whether files listed in a @samp{_SOURCES} variable are distributed.
@samp{dist_} is redundant, as sources are distributed by default, but it
can be specified for clarity if desired.

It is possible to have both @samp{dist_} and @samp{nodist_} variants of
a given @samp{_SOURCES} variable at once; this lets you easily
distribute some files and not others, for instance:

@example
nodist_maude_SOURCES = nodist.c
dist_maude_SOURCES = dist-me.c
@end example

By default the output file (on Unix systems, the @file{.o} file) will be
put into the current build directory.  However, if the option
@code{subdir-objects} is in effect in the current directory then the
@file{.o} file will be put into the subdirectory named after the source
file.  For instance, with @code{subdir-objects} enabled,
@file{sub/dir/file.c} will be compiled to @file{sub/dir/file.o}.  Some
people prefer this mode of operation.  You can specify
@code{subdir-objects} in @code{AUTOMAKE_OPTIONS} (@pxref{Options}).
@cindex Subdirectory, objects in
@cindex Objects in subdirectory


@item EXTRA_maude_SOURCES
Automake needs to know the list of files you intend to compile
@emph{statically}.  For one thing, this is the only way Automake has of
knowing what sort of language support a given @file{Makefile.in}
requires.  @footnote{There are other, more obscure reasons for
this limitation as well.}  This means that, for example, you can't put a
configure substitution like @samp{@@my_sources@@} into a @samp{_SOURCES}
variable.  If you intend to conditionally compile source files and use
@file{configure} to substitute the appropriate object names into, e.g.,
@samp{_LDADD} (see below), then you should list the corresponding source
files in the @samp{EXTRA_} variable.

This variable also supports @samp{dist_} and @samp{nodist_} prefixes,
e.g., @samp{nodist_EXTRA_maude_SOURCES}.

@item maude_AR
A static library is created by default by invoking @code{$(AR)
$(ARFLAGS)} followed by the name of the library and then the objects
being put into the library.  You can override this by setting the
@samp{_AR} variable.  This is usually used with C++; some C++
compilers require a special invocation in order to instantiate all the
templates which should go into a library.  For instance, the SGI C++
compiler likes this variable set like so:
@example
libmaude_a_AR = $(CXX) -ar -o
@end example

@item maude_LIBADD
Extra objects can be added to a @emph{library} using the @samp{_LIBADD}
variable.  For instance this should be used for objects determined by
@code{configure} (@pxref{A Library}).

@item maude_LDADD
Extra objects can be added to a @emph{program} by listing them in the
@samp{_LDADD} variable.  For instance this should be used for objects
determined by @code{configure} (@pxref{Linking}).

@samp{_LDADD} and @samp{_LIBADD} are inappropriate for passing
program-specific linker flags (except for @samp{-l}, @samp{-L},
@samp{-dlopen} and @samp{-dlpreopen}).  Use the @samp{_LDFLAGS} variable
for this purpose.

For instance, if your @file{configure.ac} uses @code{AC_PATH_XTRA}, you
could link your program against the X libraries like so:

@example
maude_LDADD = $(X_PRE_LIBS) $(X_LIBS) $(X_EXTRA_LIBS)
@end example

@item maude_LDFLAGS
This variable is used to pass extra flags to the link step of a program
or a shared library.

@item maude_DEPENDENCIES
It is also occasionally useful to have a program depend on some other
target which is not actually part of that program.  This can be done
using the @samp{_DEPENDENCIES} variable.  Each program depends on the
contents of such a variable, but no further interpretation is done.

If @samp{_DEPENDENCIES} is not supplied, it is computed by Automake.
The automatically-assigned value is the contents of @samp{_LDADD} or
@samp{_LIBADD}, with most configure substitutions, @samp{-l}, @samp{-L},
@samp{-dlopen} and @samp{-dlpreopen} options removed.  The configure
substitutions that are left in are only @samp{$(LIBOBJS)} and
@samp{$(ALLOCA)}; these are left because it is known that they will not
cause an invalid value for @samp{_DEPENDENCIES} to be generated.

@item maude_LINK
You can override the linker on a per-program basis.  By default the
linker is chosen according to the languages used by the program.  For
instance, a program that includes C++ source code would use the C++
compiler to link.  The @samp{_LINK} variable must hold the name of a
command which can be passed all the @file{.o} file names as arguments.
Note that the name of the underlying program is @emph{not} passed to
@samp{_LINK}; typically one uses @samp{$@@}:

@example
maude_LINK = $(CCLD) -magic -o $@@
@end example

@item maude_CCASFLAGS
@itemx maude_CFLAGS
@itemx maude_CPPFLAGS
@itemx maude_CXXFLAGS
@itemx maude_FFLAGS
@itemx maude_GCJFLAGS
@itemx maude_LFLAGS
@itemx maude_OBJCFLAGS
@itemx maude_RFLAGS
@itemx maude_YFLAGS
@cindex per-target compilation flags, defined
Automake allows you to set compilation flags on a per-program (or
per-library) basis.  A single source file can be included in several
programs, and it will potentially be compiled with different flags for
each program.  This works for any language directly supported by
Automake.  These @dfn{per-target compilation flags} are
@samp{_CCASFLAGS},
@samp{_CFLAGS},
@samp{_CPPFLAGS},
@samp{_CXXFLAGS},
@samp{_FFLAGS},
@samp{_GCJFLAGS},
@samp{_LFLAGS},
@samp{_OBJCFLAGS},
@samp{_RFLAGS}, and
@samp{_YFLAGS}.

When using a per-target compilation flag, Automake will choose a
different name for the intermediate object files.  Ordinarily a file
like @file{sample.c} will be compiled to produce @file{sample.o}.
However, if the program's @samp{_CFLAGS} variable is set, then the
object file will be named, for instance, @file{maude-sample.o}.
(See also @ref{renamed objects}.)

In compilations with per-target flags, the ordinary @samp{AM_} form of
the flags variable is @emph{not} automatically included in the
compilation (however, the user form of the variable @emph{is} included).
So for instance, if you want the hypothetical @file{maude} compilations
to also use the value of @samp{AM_CFLAGS}, you would need to write:

@example
maude_CFLAGS = @dots{} your flags @dots{} $(AM_CFLAGS)
@end example


@item maude_SHORTNAME
On some platforms the allowable file names are very short.  In order to
support these systems and per-target compilation flags at the same
time, Automake allows you to set a ``short name'' which will influence
how intermediate object files are named.  For instance, in the following
example,

@example
bin_PROGRAMS = maude
maude_CPPFLAGS = -DSOMEFLAG
maude_SHORTNAME = m
maude_SOURCES = sample.c @dots{}
@end example

@noindent
the object file would be named @file{m-sample.o} rather than
@file{maude-sample.o}.

This facility is rarely needed in practice,
and we recommend avoiding it until you find it is required.
@end table

@node Default _SOURCES
@section Default @code{_SOURCES}

@vindex _SOURCES
@vindex SOURCES
@cindex @code{_SOURCES}, default
@cindex default @code{_SOURCES}

@code{_SOURCES} variables are used to specify source files of programs
(@pxref{A Program}), libraries (@pxref{A Library}), and Libtool
libraries (@pxref{A Shared Library}).

When no such variable is specified for a target, Automake will define
one itself.  The default is to compile a single C file whose base name
is the name of the target itself, with any extension replaced by
@file{.c}.  (Defaulting to C is terrible but we are stuck with it for
historical reasons.)

For example if you have the following somewhere in your
@file{Makefile.am} with no corresponding @samp{libfoo_a_SOURCES}:

@example
lib_LIBRARIES = libfoo.a sub/libc++.a
@end example

@noindent
@file{libfoo.a} will be built using a default source file named
@file{libfoo.c}, and @file{sub/libc++.a} will be built from
@file{sub/libc++.c}.  (In older versions @file{sub/libc++.a}
would be built from @file{sub_libc___a.c}, i.e., the default source
was the canonized name of the target, with @file{.c} appended.
We believe the new behavior is more sensible, but for backward
compatibility automake will use the old name if a file or a rule
with that name exist.)

@cindex @code{check_PROGRAMS} example
@vindex check_PROGRAMS
Default sources are mainly useful in test suites, when building many
tests programs each from a single source.  For instance in

@example
check_PROGRAMS = test1 test2 test3
@end example

@noindent
@file{test1}, @file{test2}, and @file{test3} will be built
from @file{test1.c}, @file{test2.c}, and @file{test3.c}.

@cindex Libtool modules, default source example
@cindex default source, Libtool modules example
Another case where is this convenient is building many Libtool modules
(@file{moduleN.la}), each defined in its own file (@file{moduleN.c}).

@example
AM_LDFLAGS = -module
lib_LTLIBRARIES = module1.la module2.la module3.la
@end example

@cindex empty @code{_SOURCES}
@cindex @code{_SOURCES}, empty
Finally, there is one situation where this default source computation
needs to be avoided: when a target should not be built from sources.
We already saw such an example in @ref{true}; this happens when all
the constituents of a target have already been compiled and need just
to be combined using a @code{_LDADD} variable.  Then it is necessary
to define an empty @code{_SOURCES} variable, so that automake does not
compute a default.

@example
bin_PROGRAMS = target
target_SOURCES =
target_LDADD = libmain.a libmisc.a
@end example

@node LIBOBJS
@section Special handling for LIBOBJS and ALLOCA

@cindex @code{LIBOBJS}, special handling
@cindex @code{ALLOCA}, special handling

Automake explicitly recognizes the use of @code{$(LIBOBJS)} and
@code{$(ALLOCA)}, and uses this information, plus the list of
@code{LIBOBJS} files derived from @file{configure.ac} to automatically
include the appropriate source files in the distribution (@pxref{Dist}).
These source files are also automatically handled in the
dependency-tracking scheme; see @xref{Dependencies}.

@code{$(LIBOBJS)} and @code{$(ALLOCA)} are specially recognized in any
@samp{_LDADD} or @samp{_LIBADD} variable.


@node Program variables
@section Variables used when building a program

Occasionally it is useful to know which @file{Makefile} variables
Automake uses for compilations; for instance you might need to do your
own compilation in some special cases.

Some variables are inherited from Autoconf; these are @code{CC},
@code{CFLAGS}, @code{CPPFLAGS}, @code{DEFS}, @code{LDFLAGS}, and
@code{LIBS}.
@vindex CC
@vindex CFLAGS
@vindex CPPFLAGS
@vindex DEFS
@vindex LDFLAGS
@vindex LIBS

There are some additional variables which Automake itself defines:

@vtable @code
@item AM_CPPFLAGS
The contents of this variable are passed to every compilation which invokes
the C preprocessor; it is a list of arguments to the preprocessor.  For
instance, @samp{-I} and @samp{-D} options should be listed here.

Automake already provides some @samp{-I} options automatically.  In
particular it generates @samp{-I$(srcdir)}, @samp{-I.}, and a @samp{-I}
pointing to the directory holding @file{config.h} (if you've used
@code{AC_CONFIG_HEADERS} or @code{AM_CONFIG_HEADER}).  You can disable
the default @samp{-I} options using the @samp{nostdinc} option.

@code{AM_CPPFLAGS} is ignored in preference to a per-executable (or
per-library) @code{_CPPFLAGS} variable if it is defined.

@item INCLUDES
This does the same job as @samp{AM_CPPFLAGS} (or any per-target
@samp{_CPPFLAGS} variable if it is used).  It is an older name for the
same functionality.  This variable is deprecated; we suggest using
@samp{AM_CPPFLAGS} and per-target @samp{_CPPFLAGS} instead.

@item AM_CFLAGS
This is the variable which the @file{Makefile.am} author can use to pass
in additional C compiler flags.  It is more fully documented elsewhere.
In some situations, this is not used, in preference to the
per-executable (or per-library) @code{_CFLAGS}.

@item COMPILE
This is the command used to actually compile a C source file.  The
filename is appended to form the complete command line.

@item AM_LDFLAGS
This is the variable which the @file{Makefile.am} author can use to pass
in additional linker flags.  In some situations, this is not used, in
preference to the per-executable (or per-library) @code{_LDFLAGS}.

@item LINK
This is the command used to actually link a C program.  It already
includes @samp{-o $@@} and the usual variable references (for instance,
@code{CFLAGS}); it takes as ``arguments'' the names of the object files
and libraries to link in.
@end vtable


@node Yacc and Lex
@section Yacc and Lex support

Automake has somewhat idiosyncratic support for Yacc and Lex.

Automake assumes that the @file{.c} file generated by @code{yacc} (or
@code{lex}) should be named using the basename of the input file.  That
is, for a yacc source file @file{foo.y}, Automake will cause the
intermediate file to be named @file{foo.c} (as opposed to
@file{y.tab.c}, which is more traditional).

The extension of a yacc source file is used to determine the extension
of the resulting @samp{C} or @samp{C++} file.  Files with the extension
@samp{.y} will be turned into @samp{.c} files; likewise, @samp{.yy} will
become @samp{.cc}; @samp{.y++}, @samp{c++}; and @samp{.yxx},
@samp{.cxx}.

Likewise, lex source files can be used to generate @samp{C} or
@samp{C++}; the extensions @samp{.l}, @samp{.ll}, @samp{.l++}, and
@samp{.lxx} are recognized.

You should never explicitly mention the intermediate (@samp{C} or
@samp{C++}) file in any @samp{SOURCES} variable; only list the source
file.

The intermediate files generated by @code{yacc} (or @code{lex}) will be
included in any distribution that is made.  That way the user doesn't
need to have @code{yacc} or @code{lex}.

If a @code{yacc} source file is seen, then your @file{configure.ac} must
define the variable @samp{YACC}.  This is most easily done by invoking
the macro @samp{AC_PROG_YACC} (@pxref{Particular Programs, , Particular
Program Checks, autoconf, The Autoconf Manual}).

When @code{yacc} is invoked, it is passed @samp{YFLAGS} and
@samp{AM_YFLAGS}.  The former is a user variable and the latter is
intended for the @file{Makefile.am} author.

@samp{AM_YFLAGS} is usually used to pass the @code{-d} option to
@code{yacc}.  Automake knows what this means and will automatically
adjust its rules to update and distribute the header file built by
@code{yacc -d}.  What Automake cannot guess, though, is where this
header will be used: it is up to you to ensure the header gets built
before it is first used.  Typically this is necessary in order for
dependency tracking to work when the header is included by another
file.  The common solution is listing the header file in
@code{BUILT_SOURCES} (@pxref{Sources}) as follows.

@example
BUILT_SOURCES = parser.h
AM_YFLAGS = -d
bin_PROGRAMS = foo
foo_SOURCES = @dots{} parser.y @dots{}
@end example

If a @code{lex} source file is seen, then your @file{configure.ac}
must define the variable @samp{LEX}.  You can use @samp{AC_PROG_LEX}
to do this (@pxref{Particular Programs, , Particular Program Checks,
autoconf, The Autoconf Manual}), but using @code{AM_PROG_LEX} macro
(@pxref{Macros}) is recommended.

When @code{lex} is invoked, it is passed @samp{LFLAGS} and
@samp{AM_LFLAGS}.  The former is a user variable and the latter is
intended for the @file{Makefile.am} author.



@cindex ylwrap
@cindex yacc, multiple parsers
@cindex Multiple yacc parsers
@cindex Multiple lex lexers
@cindex lex, multiple lexers


Automake makes it possible to include multiple @code{yacc} (or
@code{lex}) source files in a single program.  When there is more than
one distinct @code{yacc} (or @code{lex}) source file in a directory,
Automake uses a small program called @code{ylwrap} to run @code{yacc}
(or @code{lex}) in a subdirectory.  This is necessary because yacc's
output filename is fixed, and a parallel make could conceivably invoke
more than one instance of @code{yacc} simultaneously.  The @code{ylwrap}
program is distributed with Automake.  It should appear in the directory
specified by @samp{AC_CONFIG_AUX_DIR} (@pxref{Input, , Finding
`configure' Input, autoconf, The Autoconf Manual}), or the current
directory if that macro is not used in @file{configure.ac}.

For @code{yacc}, simply managing locking is insufficient.  The output of
@code{yacc} always uses the same symbol names internally, so it isn't
possible to link two @code{yacc} parsers into the same executable.

We recommend using the following renaming hack used in @code{gdb}:
@example
#define	yymaxdepth c_maxdepth
#define	yyparse	c_parse
#define	yylex	c_lex
#define	yyerror	c_error
#define	yylval	c_lval
#define	yychar	c_char
#define	yydebug	c_debug
#define	yypact	c_pact
#define	yyr1	c_r1
#define	yyr2	c_r2
#define	yydef	c_def
#define	yychk	c_chk
#define	yypgo	c_pgo
#define	yyact	c_act
#define	yyexca	c_exca
#define yyerrflag c_errflag
#define yynerrs	c_nerrs
#define	yyps	c_ps
#define	yypv	c_pv
#define	yys	c_s
#define	yy_yys	c_yys
#define	yystate	c_state
#define	yytmp	c_tmp
#define	yyv	c_v
#define	yy_yyv	c_yyv
#define	yyval	c_val
#define	yylloc	c_lloc
#define yyreds	c_reds
#define yytoks	c_toks
#define yylhs	c_yylhs
#define yylen	c_yylen
#define yydefred c_yydefred
#define yydgoto	c_yydgoto
#define yysindex c_yysindex
#define yyrindex c_yyrindex
#define yygindex c_yygindex
#define yytable	 c_yytable
#define yycheck	 c_yycheck
#define yyname   c_yyname
#define yyrule   c_yyrule
@end example

For each define, replace the @samp{c_} prefix with whatever you like.
These defines work for @code{bison}, @code{byacc}, and traditional
@code{yacc}s.  If you find a parser generator that uses a symbol not
covered here, please report the new name so it can be added to the list.


@node C++ Support
@section C++ Support

@cindex C++ support
@cindex Support for C++

Automake includes full support for C++.

Any package including C++ code must define the output variable
@samp{CXX} in @file{configure.ac}; the simplest way to do this is to use
the @code{AC_PROG_CXX} macro (@pxref{Particular Programs, , Particular
Program Checks, autoconf, The Autoconf Manual}).

A few additional variables are defined when a C++ source file is seen:

@vtable @code
@item CXX
The name of the C++ compiler.

@item CXXFLAGS
Any flags to pass to the C++ compiler.

@item AM_CXXFLAGS
The maintainer's variant of @code{CXXFLAGS}.

@item CXXCOMPILE
The command used to actually compile a C++ source file.  The file name
is appended to form the complete command line.

@item CXXLINK
The command used to actually link a C++ program.
@end vtable


@node Assembly Support
@section Assembly Support

Automake includes some support for assembly code.

The variable @code{CCAS} holds the name of the compiler used to build
assembly code.  This compiler must work a bit like a C compiler; in
particular it must accept @samp{-c} and @samp{-o}.  The value of
@code{CCASFLAGS} is passed to the compilation.
@vindex CCAS
@vindex CCASFLAGS

You are required to set @code{CCAS} and @code{CCASFLAGS} via
@file{configure.ac}.  The autoconf macro @code{AM_PROG_AS} will do this
for you.  Unless they are already set, it simply sets @code{CCAS} to the
C compiler and @code{CCASFLAGS} to the C compiler flags.

Only the suffixes @samp{.s} and @samp{.S} are recognized by
@code{automake} as being files containing assembly code.


@node Fortran 77 Support
@comment  node-name,  next,  previous,  up
@section Fortran 77 Support

@cindex Fortran 77 support
@cindex Support for Fortran 77

Automake includes full support for Fortran 77.

Any package including Fortran 77 code must define the output variable
@samp{F77} in @file{configure.ac}; the simplest way to do this is to use
the @code{AC_PROG_F77} macro (@pxref{Particular Programs, , Particular
Program Checks, autoconf, The Autoconf Manual}).

A few additional variables are defined when a Fortran 77 source file is
seen:

@vtable @code

@item F77
The name of the Fortran 77 compiler.

@item FFLAGS
Any flags to pass to the Fortran 77 compiler.

@item AM_FFLAGS
The maintainer's variant of @code{FFLAGS}.

@item RFLAGS
Any flags to pass to the Ratfor compiler.

@item AM_RFLAGS
The maintainer's variant of @code{RFLAGS}.

@item F77COMPILE
The command used to actually compile a Fortran 77 source file.  The file
name is appended to form the complete command line.

@item FLINK
The command used to actually link a pure Fortran 77 program or shared
library.

@end vtable

Automake can handle preprocessing Fortran 77 and Ratfor source files in
addition to compiling them@footnote{Much, if not most, of the
information in the following sections pertaining to preprocessing
Fortran 77 programs was taken almost verbatim from @ref{Catalogue of
Rules, , Catalogue of Rules, make, The GNU Make Manual}.}.  Automake
also contains some support for creating programs and shared libraries
that are a mixture of Fortran 77 and other languages (@pxref{Mixing
Fortran 77 With C and C++}).

These issues are covered in the following sections.

@menu
* Preprocessing Fortran 77::    Preprocessing Fortran 77 sources
* Compiling Fortran 77 Files::  Compiling Fortran 77 sources
* Mixing Fortran 77 With C and C++::  Mixing Fortran 77 With C and C++
@end menu


@node Preprocessing Fortran 77
@comment  node-name,  next,  previous,  up
@subsection Preprocessing Fortran 77

@cindex Preprocessing Fortran 77
@cindex Fortran 77, Preprocessing
@cindex Ratfor programs

@file{N.f} is made automatically from @file{N.F} or @file{N.r}.  This
rule runs just the preprocessor to convert a preprocessable Fortran 77
or Ratfor source file into a strict Fortran 77 source file.  The precise
command used is as follows:

@table @file

@item .F
@code{$(F77) -F $(DEFS) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_FFLAGS) $(FFLAGS)}

@item .r
@code{$(F77) -F $(AM_FFLAGS) $(FFLAGS) $(AM_RFLAGS) $(RFLAGS)}

@end table


@node Compiling Fortran 77 Files
@comment  node-name,  next,  previous,  up
@subsection Compiling Fortran 77 Files

@file{N.o} is made automatically from @file{N.f}, @file{N.F} or
@file{N.r} by running the Fortran 77 compiler.  The precise command used
is as follows:

@table @file

@item .f
@code{$(F77) -c $(AM_FFLAGS) $(FFLAGS)}

@item .F
@code{$(F77) -c $(DEFS) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_FFLAGS) $(FFLAGS)}

@item .r
@code{$(F77) -c $(AM_FFLAGS) $(FFLAGS) $(AM_RFLAGS) $(RFLAGS)}

@end table


@node Mixing Fortran 77 With C and C++
@comment  node-name,  next,  previous,  up
@subsection Mixing Fortran 77 With C and C++

@cindex Fortran 77, mixing with C and C++
@cindex Mixing Fortran 77 with C and C++
@cindex Linking Fortran 77 with C and C++
@cindex cfortran
@cindex Mixing Fortran 77 with C and/or C++

Automake currently provides @emph{limited} support for creating programs
and shared libraries that are a mixture of Fortran 77 and C and/or C++.
However, there are many other issues related to mixing Fortran 77 with
other languages that are @emph{not} (currently) handled by Automake, but
that are handled by other packages@footnote{For example,
@uref{http://www-zeus.desy.de/~burow/cfortran/, the cfortran package}
addresses all of these inter-language issues, and runs under nearly all
Fortran 77, C and C++ compilers on nearly all platforms.  However,
@code{cfortran} is not yet Free Software, but it will be in the next
major release.}.

@page
Automake can help in two ways:

@enumerate
@item
Automatic selection of the linker depending on which combinations of
source code.

@item
Automatic selection of the appropriate linker flags (e.g. @samp{-L} and
@samp{-l}) to pass to the automatically selected linker in order to link
in the appropriate Fortran 77 intrinsic and run-time libraries.

@cindex FLIBS, defined
These extra Fortran 77 linker flags are supplied in the output variable
@code{FLIBS} by the @code{AC_F77_LIBRARY_LDFLAGS} Autoconf macro
supplied with newer versions of Autoconf (Autoconf version 2.13 and
later).  @xref{Fortran 77 Compiler Characteristics, , , autoconf, The
Autoconf}.
@end enumerate

If Automake detects that a program or shared library (as mentioned in
some @code{_PROGRAMS} or @code{_LTLIBRARIES} primary) contains source
code that is a mixture of Fortran 77 and C and/or C++, then it requires
that the macro @code{AC_F77_LIBRARY_LDFLAGS} be called in
@file{configure.ac}, and that either @code{$(FLIBS)}
appear in the appropriate @code{_LDADD} (for programs) or @code{_LIBADD}
(for shared libraries) variables.  It is the responsibility of the
person writing the @file{Makefile.am} to make sure that @code{$(FLIBS)}
appears in the appropriate @code{_LDADD} or
@code{_LIBADD} variable.

@cindex Mixed language example
@cindex Example, mixed language

For example, consider the following @file{Makefile.am}:

@example
bin_PROGRAMS = foo
foo_SOURCES  = main.cc foo.f
foo_LDADD    = libfoo.la $(FLIBS)

pkglib_LTLIBRARIES = libfoo.la
libfoo_la_SOURCES  = bar.f baz.c zardoz.cc
libfoo_la_LIBADD   = $(FLIBS)
@end example

In this case, Automake will insist that @code{AC_F77_LIBRARY_LDFLAGS}
is mentioned in @file{configure.ac}.  Also, if @code{$(FLIBS)} hadn't
been mentioned in @code{foo_LDADD} and @code{libfoo_la_LIBADD}, then
Automake would have issued a warning.


@page
@menu
* How the Linker is Chosen::    Automatic linker selection
@end menu

@node How the Linker is Chosen
@comment  node-name,  next,  previous,  up
@subsubsection How the Linker is Chosen

@cindex Automatic linker selection
@cindex Selecting the linker automatically

The following diagram demonstrates under what conditions a particular
linker is chosen by Automake.

For example, if Fortran 77, C and C++ source code were to be compiled
into a program, then the C++ linker will be used.  In this case, if the
C or Fortran 77 linkers required any special libraries that weren't
included by the C++ linker, then they must be manually added to an
@code{_LDADD} or @code{_LIBADD} variable by the user writing the
@file{Makefile.am}.

@example
                     \              Linker
          source      \
           code        \     C        C++     Fortran
     -----------------  +---------+---------+---------+
                        |         |         |         |
     C                  |    x    |         |         |
                        |         |         |         |
                        +---------+---------+---------+
                        |         |         |         |
         C++            |         |    x    |         |
                        |         |         |         |
                        +---------+---------+---------+
                        |         |         |         |
               Fortran  |         |         |    x    |
                        |         |         |         |
                        +---------+---------+---------+
                        |         |         |         |
     C + C++            |         |    x    |         |
                        |         |         |         |
                        +---------+---------+---------+
                        |         |         |         |
     C +       Fortran  |         |         |    x    |
                        |         |         |         |
                        +---------+---------+---------+
                        |         |         |         |
         C++ + Fortran  |         |    x    |         |
                        |         |         |         |
                        +---------+---------+---------+
                        |         |         |         |
     C + C++ + Fortran  |         |    x    |         |
                        |         |         |         |
                        +---------+---------+---------+
@end example

@node Fortran 9x Support
@comment  node-name,  next,  previous,  up
@section Fortran 9x Support

@cindex Fortran 9x support
@cindex Support for Fortran 9x

Automake includes full support for Fortran 9x.

Any package including Fortran 9x code must define the output variable
@samp{FC} in @file{configure.ac}; the simplest way to do this is to use
the @code{AC_PROG_FC} macro (@pxref{Particular Programs, , Particular
Program Checks, autoconf, The Autoconf Manual}).

A few additional variables are defined when a Fortran 9x source file is
seen:

@vtable @code

@item FC
The name of the Fortran 9x compiler.

@item FCFLAGS
Any flags to pass to the Fortran 9x compiler.

@item AM_FCFLAGS
The maintainer's variant of @code{FCFLAGS}.

@item FCCOMPILE
The command used to actually compile a Fortran 9x source file.  The file
name is appended to form the complete command line.

@item FCLINK
The command used to actually link a pure Fortran 9x program or shared
library.

@end vtable

@menu
* Compiling Fortran 9x Files::  Compiling Fortran 9x sources
@end menu

@node Compiling Fortran 9x Files
@comment  node-name,  next,  previous,  up
@subsection Compiling Fortran 9x Files

@file{N.o} is made automatically from @file{N.f90} or @file{N.f95}
by running the Fortran 9x compiler.  The precise command used
is as follows:

@table @file

@item .f9x
@code{$(FC) -c $(AM_FCFLAGS) $(FCFLAGS)}

@end table

@node Java Support
@comment  node-name,  next,  previous,  up
@section Java Support

@cindex Java support
@cindex Support for Java

Automake includes support for compiled Java, using @code{gcj}, the Java
front end to the GNU Compiler Collection.

Any package including Java code to be compiled must define the output
variable @samp{GCJ} in @file{configure.ac}; the variable @samp{GCJFLAGS}
must also be defined somehow (either in @file{configure.ac} or
@file{Makefile.am}).  The simplest way to do this is to use the
@code{AM_PROG_GCJ} macro.

@vindex GCJFLAGS

By default, programs including Java source files are linked with
@code{gcj}.

As always, the contents of @samp{AM_GCJFLAGS} are passed to every
compilation invoking @code{gcj} (in its role as an ahead-of-time
compiler -- when invoking it to create @file{.class} files,
@samp{AM_JAVACFLAGS} is used instead).  If it is necessary to pass
options to @code{gcj} from @file{Makefile.am}, this variable, and not
the user variable @samp{GCJFLAGS}, should be used.

@vindex AM_GCJFLAGS

@code{gcj} can be used to compile @file{.java}, @file{.class},
@file{.zip}, or @file{.jar} files.

When linking, @code{gcj} requires that the main class be specified
using the @samp{--main=} option.  The easiest way to do this is to use
the @code{_LDFLAGS} variable for the program.


@node Support for Other Languages
@comment  node-name,  next,  previous,  up
@section Support for Other Languages

Automake currently only includes full support for C, C++ (@pxref{C++
Support}), Fortran 77 (@pxref{Fortran 77 Support}),
Fortran 9x (@pxref{Fortran 9x Support}),
and Java (@pxref{Java Support}).  There is only rudimentary support for other
languages, support for which will be improved based on user demand.

Some limited support for adding your own languages is available via the
suffix rule handling; see @ref{Suffixes}.


@node ANSI
@section Automatic de-ANSI-fication

@cindex de-ANSI-fication, defined

Although the GNU standards allow the use of ANSI C, this can have the
effect of limiting portability of a package to some older compilers
(notably the SunOS C compiler).

Automake allows you to work around this problem on such machines by
@dfn{de-ANSI-fying} each source file before the actual compilation takes
place.

@vindex AUTOMAKE_OPTIONS
@opindex ansi2knr

If the @file{Makefile.am} variable @code{AUTOMAKE_OPTIONS}
(@pxref{Options}) contains the option @code{ansi2knr} then code to
handle de-ANSI-fication is inserted into the generated
@file{Makefile.in}.

This causes each C source file in the directory to be treated as ANSI C@.
If an ANSI C compiler is available, it is used.  If no ANSI C compiler
is available, the @code{ansi2knr} program is used to convert the source
files into K&R C, which is then compiled.

The @code{ansi2knr} program is simple-minded.  It assumes the source
code will be formatted in a particular way; see the @code{ansi2knr} man
page for details.

Support for de-ANSI-fication requires the source files @file{ansi2knr.c}
and @file{ansi2knr.1} to be in the same package as the ANSI C source;
these files are distributed with Automake.  Also, the package
@file{configure.ac} must call the macro @code{AM_C_PROTOTYPES}
(@pxref{Macros}).
@cvindex AM_C_PROTOTYPES

Automake also handles finding the @code{ansi2knr} support files in some
other directory in the current package.  This is done by prepending the
relative path to the appropriate directory to the @code{ansi2knr}
option.  For instance, suppose the package has ANSI C code in the
@file{src} and @file{lib} subdirectories.  The files @file{ansi2knr.c} and
@file{ansi2knr.1} appear in @file{lib}.  Then this could appear in
@file{src/Makefile.am}:

@example
AUTOMAKE_OPTIONS = ../lib/ansi2knr
@end example

If no directory prefix is given, the files are assumed to be in the
current directory.

Note that automatic de-ANSI-fication will not work when the package is
being built for a different host architecture.  That is because automake
currently has no way to build @code{ansi2knr} for the build machine.

@c FIXME: this paragraph might be better moved to an `upgrading' section.
@cindex @code{LTLIBOBJS} and @code{ansi2knr}
@cindex @code{LIBOBJS} and @code{ansi2knr}
@cindex @code{ansi2knr} and @code{LTLIBOBJS}
@cindex @code{ansi2knr} and @code{LIBOBJS}
Using @code{LIBOBJS} with source de-ANSI-fication used to require
hand-crafted code in @file{configure} to append @code{$U} to basenames
in @code{LIBOBJS}.  This is no longer true today.  Starting with version
2.54, Autoconf takes care of rewriting @code{LIBOBJS} and
@code{LTLIBOBJS}.  (@pxref{AC_LIBOBJ vs LIBOBJS, , @code{AC_LIBOBJ}
vs. @code{LIBOBJS}, autoconf, The Autoconf Manual})

@node Dependencies
@section Automatic dependency tracking

As a developer it is often painful to continually update the
@file{Makefile.in} whenever the include-file dependencies change in a
project.  Automake supplies a way to automatically track dependency
changes.

@cindex Dependency tracking
@cindex Automatic dependency tracking

Automake always uses complete dependencies for a compilation, including
system headers.  Automake's model is that dependency computation should
be a side effect of the build.  To this end, dependencies are computed
by running all compilations through a special wrapper program called
@code{depcomp}.  @code{depcomp} understands how to coax many different C
and C++ compilers into generating dependency information in the format
it requires.  @code{automake -a} will install @code{depcomp} into your
source tree for you.  If @code{depcomp} can't figure out how to properly
invoke your compiler, dependency tracking will simply be disabled for
your build.

@cindex depcomp

Experience with earlier versions of Automake @footnote{See
@uref{http://sources.redhat.com/automake/dependencies.html} for more
information on the history and experiences with automatic dependency
tracking in Automake} taught us that it is not reliable to generate
dependencies only on the maintainer's system, as configurations vary too
much.  So instead Automake implements dependency tracking at build time.

Automatic dependency tracking can be suppressed by putting
@code{no-dependencies} in the variable @code{AUTOMAKE_OPTIONS}, or
passing @code{no-dependencies} as an argument to @code{AM_INIT_AUTOMAKE}
(this should be the preferred way).  Or, you can invoke @code{automake}
with the @code{-i} option.  Dependency tracking is enabled by default.

@vindex AUTOMAKE_OPTIONS
@opindex no-dependencies

The person building your package also can choose to disable dependency
tracking by configuring with @code{--disable-dependency-tracking}.

@cindex Disabling dependency tracking
@cindex Dependency tracking, disabling


@node EXEEXT
@section Support for executable extensions

@cindex Executable extension
@cindex Extension, executable
@cindex Windows

On some platforms, such as Windows, executables are expected to have an
extension such as @samp{.exe}.  On these platforms, some compilers (GCC
among them) will automatically generate @file{foo.exe} when asked to
generate @file{foo}.

Automake provides mostly-transparent support for this.  Unfortunately
@emph{mostly} doesn't yet mean @emph{fully}.  Until the English
dictionary is revised, you will have to assist Automake if your package
must support those platforms.

One thing you must be aware of is that, internally, Automake rewrites
something like this:

@example
bin_PROGRAMS = liver
@end example

to this:

@example
bin_PROGRAMS = liver$(EXEEXT)
@end example

The targets Automake generates are likewise given the @samp{$(EXEEXT)}
extension.  @code{EXEEXT}

However, Automake cannot apply this rewriting to @code{configure}
substitutions.  This means that if you are conditionally building a
program using such a substitution, then your @file{configure.ac} must
take care to add @samp{$(EXEEXT)} when constructing the output variable.

With Autoconf 2.13 and earlier, you must explicitly use @code{AC_EXEEXT}
to get this support.  With Autoconf 2.50, @code{AC_EXEEXT} is run
automatically if you configure a compiler (say, through
@code{AC_PROG_CC}).

Sometimes maintainers like to write an explicit link rule for their
program.  Without executable extension support, this is easy---you
simply write a rule whose target is the name of the program.  However,
when executable extension support is enabled, you must instead add the
@samp{$(EXEEXT)} suffix.

Unfortunately, due to the change in Autoconf 2.50, this means you must
always add this extension.  However, this is a problem for maintainers
who know their package will never run on a platform that has
executable extensions.  For those maintainers, the @code{no-exeext}
option (@pxref{Options}) will disable this feature.  This works in a
fairly ugly way; if @code{no-exeext} is seen, then the presence of a
rule for a target named @code{foo} in @file{Makefile.am} will override
an automake-generated rule for @code{foo$(EXEEXT)}.  Without
the @code{no-exeext} option, this use will give a diagnostic.


@node Other objects
@chapter Other Derived Objects

Automake can handle derived objects which are not C programs.  Sometimes
the support for actually building such objects must be explicitly
supplied, but Automake will still automatically handle installation and
distribution.

@menu
* Scripts::                     Executable scripts
* Headers::                     Header files
* Data::                        Architecture-independent data files
* Sources::                     Derived sources
@end menu


@node Scripts
@section Executable Scripts

@cindex _SCRIPTS primary, defined
@cindex SCRIPTS primary, defined
@cindex Primary variable, SCRIPTS

It is possible to define and install programs which are scripts.  Such
programs are listed using the @samp{SCRIPTS} primary name.  Automake
doesn't define any dependencies for scripts; the @file{Makefile.am}
should include the appropriate rules.
@vindex SCRIPTS

Automake does not assume that scripts are derived objects; such objects
must be deleted by hand (@pxref{Clean}).

The @code{automake} program itself is a Perl script that is generated
from @file{automake.in}.  Here is how this is handled:

@example
bin_SCRIPTS = automake
CLEANFILES = $(bin_SCRIPTS)

do_subst = sed -e 's,[@@]datadir[@@],$(datadir),g' \
            -e 's,[@@]PERL[@@],$(PERL),g' \
            -e 's,[@@]PACKAGE[@@],$(PACKAGE),g' \
            -e 's,[@@]VERSION[@@],$(VERSION),g' \
            @dots{}

automake: automake.in Makefile
        $(do_subst) < $(srcdir)/automake.in > automake
        chmod +x automake
@end example

Because---as we have just seen---scripts can be built, they are not
distributed by default.  Scripts that should be distributed can be
specified using a @code{dist_} prefix as in other primaries.  For
instance the following @file{Makefile.am} declares that
@file{my_script} should be distributed and installed in
@code{$(sbindir)}.

@example
dist_sbin_SCRIPTS = my_script
@end example

@cindex SCRIPTS, installation directories
@cindex Installing scripts

@vindex bin_SCRIPTS
@vindex sbin_SCRIPTS
@vindex libexec_SCRIPTS
@vindex pkgdata_SCRIPTS
@vindex noinst_SCRIPTS
@vindex check_SCRIPTS

Script objects can be installed in @code{bindir}, @code{sbindir},
@code{libexecdir}, or @code{pkgdatadir}.

Scripts that need not being installed can be listed in
@code{noinst_SCRIPTS}, and among them, those which are needed only by
@code{make check} should go in @code{check_SCRIPTS}.


@node Headers
@section Header files

@cindex _HEADERS primary, defined
@cindex HEADERS primary, defined
@cindex Primary variable, HEADERS

@vindex noinst_HEADERS
@cindex HEADERS, installation directories
@cindex Installing headers
@vindex include_HEADERS
@vindex oldinclude_HEADERS
@vindex pkginclude_HEADERS


Header files that must be installed are specified by the
@samp{HEADERS} family of variables.  Headers can be installed in
@code{includedir}, @code{oldincludedir}, @code{pkgincludedir} or any
other directory you may have defined (@pxref{Uniform}).  For instance

@example
include_HEADERS = foo.h bar/bar.h
@end example

@noindent
will install the two files as @file{$(includedir)/foo.h} and
@file{$(includedir)/bar.h}.

The @samp{nobase_} prefix is also supported,

@example
nobase_include_HEADERS = foo.h bar/bar.h
@end example

@noindent
will install the two files as @file{$(includedir)/foo.h} and
@file{$(includedir)/bar/bar.h} (@pxref{Alternative}).

@vindex noinst_HEADERS
Usually, only header files that accompany installed libraries need to
be installed.  Headers used by programs or convenience libraries are
not installed.  The @code{noinst_HEADERS} variable can be used for
such headers.  However when the header actually belongs to one
convenient library or program, we recommend listing it in the
program's or library's @samp{_SOURCES} variable (@pxref{Program
Sources}) instead of in @code{noinst_HEADERS}.  This is clearer for
the @file{Makefile.am} reader.  @code{noinst_HEADERS} would be the
right variable to use in a directory containing only headers and no
associated library or program.

All header files must be listed somewhere; in a @samp{_SOURCES}
variable or in a @samp{_HEADERS} variable.  Missing ones will not
appear in the distribution.

For header files that are built and must not be distributed, use the
@samp{nodist_} prefix as in @code{nodist_include_HEADERS} or
@code{nodist_prog_SOURCES}.  If these generated headers are needed
during the build, you must also ensure they exist before they are
used, see @xref{Sources}.


@node Data
@section Architecture-independent data files

@cindex _DATA primary, defined
@cindex DATA primary, defined
@cindex Primary variable, DATA

Automake supports the installation of miscellaneous data files using the
@samp{DATA} family of variables.
@vindex DATA

@vindex data_DATA
@vindex sysconf_DATA
@vindex sharedstate_DATA
@vindex localstate_DATA
@vindex pkgdata_DATA

Such data can be installed in the directories @code{datadir},
@code{sysconfdir}, @code{sharedstatedir}, @code{localstatedir}, or
@code{pkgdatadir}.

By default, data files are @emph{not} included in a distribution.  Of
course, you can use the @samp{dist_} prefix to change this on a
per-variable basis.

Here is how Automake declares its auxiliary data files:

@example
dist_pkgdata_DATA = clean-kr.am clean.am @dots{}
@end example


@node Sources
@section Built sources

Because Automake's automatic dependency tracking works as a side-effect
of compilation (@pxref{Dependencies}) there is a bootstrap issue: a
target should not be compiled before its dependencies are made, but
these dependencies are unknown until the target is first compiled.

Ordinarily this is not a problem, because dependencies are distributed
sources: they preexist and do not need to be built.  Suppose that
@file{foo.c} includes @file{foo.h}.  When it first compiles
@file{foo.o}, @command{make} only knows that @file{foo.o} depends on
@file{foo.c}.  As a side-effect of this compilation @code{depcomp}
records the @file{foo.h} dependency so that following invocations of
@command{make} will honor it.  In these conditions, it's clear there is
no problem: either @file{foo.o} doesn't exist and has to be built
(regardless of the dependencies), either accurate dependencies exist and
they can be used to decide whether @file{foo.o} should be rebuilt.

It's a different story if @file{foo.h} doesn't exist by the first
@command{make} run.  For instance there might be a rule to build
@file{foo.h}.  This time @file{file.o}'s build will fail because the
compiler can't find @file{foo.h}. @command{make} failed to trigger the
rule to build @file{foo.h} first by lack of dependency information.

@vindex BUILT_SOURCES
@cindex BUILT_SOURCES, defined

The @code{BUILT_SOURCES} variable is a workaround for this problem.  A
source file listed in @code{BUILT_SOURCES} is made on @code{make all}
or @code{make check} (or even @code{make install}) before other
targets are processed.  However, such a source file is not
@emph{compiled} unless explicitly requested by mentioning it in some
other @samp{_SOURCES} variable.

So, to conclude our introductory example, we could use
@code{BUILT_SOURCES = foo.h} to ensure @file{foo.h} gets built before
any other target (including @file{foo.o}) during @code{make all} or
@code{make check}.

@code{BUILT_SOURCES} is actually a bit of a misnomer, as any file which
must be created early in the build process can be listed in this
variable.  Moreover, all built sources do not necessarily have to be
listed in @code{BUILT_SOURCES}.  For instance a generated @file{.c} file
doesn't need to appear in @code{BUILT_SOURCES} (unless it is included by
another source), because it's a known dependency of the associated
object.

It might be important to emphasize that @code{BUILT_SOURCES} is
honored only by @code{make all}, @code{make check} and @code{make
install}.  This means you cannot build a specific target (e.g.,
@code{make foo}) in a clean tree if it depends on a built source.
However it will succeed if you have run @code{make all} earlier,
because accurate dependencies are already available.

The next section illustrates and discusses the handling of built sources
on a toy example.

@menu
* Built sources example::       Several ways to handle built sources.
@end menu

@node Built sources example
@subsection Built sources example

Suppose that @file{foo.c} includes @file{bindir.h}, which is
installation-dependent and not distributed: it needs to be built.  Here
@file{bindir.h} defines the preprocessor macro @code{bindir} to the
value of the @command{make} variable @code{bindir} (inherited from
@file{configure}).

We suggest several implementations below.  It's not meant to be an
exhaustive listing of all ways to handle built sources, but it will give
you a few ideas if you encounter this issue.

@unnumberedsubsec First try

This first implementation will illustrate the bootstrap issue mentioned
in the previous section (@pxref{Sources}).

Here is a tentative @file{Makefile.am}.

@example
# This won't work.
bin_PROGRAMS = foo
foo_SOURCES = foo.c
nodist_foo_SOURCES = bindir.h
CLEANFILES = bindir.h
bindir.h: Makefile
        echo '#define bindir "$(bindir)"' >$@@
@end example

This setup doesn't work, because Automake doesn't know that @file{foo.c}
includes @file{bindir.h}.  Remember, automatic dependency tracking works
as a side-effect of compilation, so the dependencies of @file{foo.o} will
be known only after @file{foo.o} has been compiled (@pxref{Dependencies}).
The symptom is as follows.

@example
% make
source='foo.c' object='foo.o' libtool=no \
depfile='.deps/foo.Po' tmpdepfile='.deps/foo.TPo' \
depmode=gcc /bin/sh ./depcomp \
gcc -I. -I. -g -O2 -c `test -f 'foo.c' || echo './'`foo.c
foo.c:2: bindir.h: No such file or directory
make: *** [foo.o] Error 1
@end example

In this example @file{bindir.h} is not distributed, not installed, and
it is not even being built on-time.  One may wonder what the
@code{nodist_foo_SOURCES = bindir.h} line has any use at all.  This
line simply states that @file{bindir.h} is a source of @code{foo}, so
for instance it should be inspected while generating tags
(@pxref{Tags}).  In other words, it does not help our present problem,
and the build would fail identically without it.

@unnumberedsubsec Using @code{BUILT_SOURCES}

A solution is to require @file{bindir.h} to be built before anything
else.  This is what @code{BUILT_SOURCES} is meant for (@pxref{Sources}).

@example
bin_PROGRAMS = foo
foo_SOURCES = foo.c
nodist_foo_SOURCES = bindir.h
BUILT_SOURCES = bindir.h
CLEANFILES = bindir.h
bindir.h: Makefile
        echo '#define bindir "$(bindir)"' >$@@
@end example

See how @file{bindir.h} get built first:

@example
% make
echo '#define bindir "/usr/local/bin"' >bindir.h
make  all-am
make[1]: Entering directory `/home/adl/tmp'
source='foo.c' object='foo.o' libtool=no \
depfile='.deps/foo.Po' tmpdepfile='.deps/foo.TPo' \
depmode=gcc /bin/sh ./depcomp \
gcc -I. -I. -g -O2 -c `test -f 'foo.c' || echo './'`foo.c
gcc  -g -O2   -o foo  foo.o
make[1]: Leaving directory `/home/adl/tmp'
@end example

However, as said earlier, @code{BUILT_SOURCES} applies only to the
@code{all}, @code{check}, and @code{install} targets.  It still fails
if you try to run @code{make foo} explicitly:

@example
% make clean
test -z "bindir.h" || rm -f bindir.h
test -z "foo" || rm -f foo
rm -f *.o
% : > .deps/foo.Po # Suppress previously recorded dependencies
% make foo
source='foo.c' object='foo.o' libtool=no \
depfile='.deps/foo.Po' tmpdepfile='.deps/foo.TPo' \
depmode=gcc /bin/sh ./depcomp \
gcc -I. -I. -g -O2 -c `test -f 'foo.c' || echo './'`foo.c
foo.c:2: bindir.h: No such file or directory
make: *** [foo.o] Error 1
@end example

@unnumberedsubsec Recording dependencies manually

Usually people are happy enough with @code{BUILT_SOURCES} because they
never build targets such as @code{make foo} before @code{make all}, as
in the previous example.  However if this matters to you, you can
avoid @code{BUILT_SOURCES} and record such dependencies explicitly in
the @file{Makefile.am}.

@example
bin_PROGRAMS = foo
foo_SOURCES = foo.c
nodist_foo_SOURCES = bindir.h
foo.$(OBJEXT): bindir.h
CLEANFILES = bindir.h
bindir.h: Makefile
        echo '#define bindir "$(bindir)"' >$@@
@end example

You don't have to list @emph{all} the dependencies of @code{foo.o}
explicitly, only those which might need to be built.  If a dependency
already exists, it will not hinder the first compilation and will be
recorded by the normal dependency tracking code.  (Note that after this
first compilation the dependency tracking code will also have recorded
the dependency between @code{foo.o} and @code{bindir.h}; so our explicit
dependency is really useful to the first build only.)

Adding explicit dependencies like this can be a bit dangerous if you are
not careful enough.  This is due to the way Automake tries not to
overwrite your rules (it assumes you know better than it).
@code{foo.$(OBJEXT): bindir.h} supersedes any rule Automake may want to
output to build @code{foo.$(OBJEXT)}.  It happens to work in this case
because Automake doesn't have to output any @code{foo.$(OBJEXT):}
target: it relies on a suffix rule instead (i.e., @code{.c.$(OBJEXT):}).
Always check the generated @file{Makefile.in} if you do this.

@unnumberedsubsec Build @file{bindir.h} from @file{configure}

It's possible to define this preprocessor macro from @file{configure},
either in @file{config.h} (@pxref{Defining Directories, , Defining
Directories, autoconf, The Autoconf Manual}), or by processing a
@file{bindir.h.in} file using @code{AC_CONFIG_FILES}
(@pxref{Configuration Actions, ,Configuration Actions, autoconf, The
Autoconf Manual}).

At this point it should be clear that building @file{bindir.h} from
@file{configure} work well for this example.  @file{bindir.h} will exist
before you build any target, hence will not cause any dependency issue.

The Makefile can be shrunk as follows.  We do not even have to mention
@file{bindir.h}.

@example
bin_PROGRAMS = foo
foo_SOURCES = foo.c
@end example

However, it's not always possible to build sources from
@file{configure}, especially when these sources are generated by a tool
that needs to be built first...

@unnumberedsubsec Build @file{bindir.c}, not @file{bindir.h}.

Another attractive idea is to define @code{bindir} as a variable or
function exported from @file{bindir.o}, and build @file{bindir.c}
instead of @file{bindir.h}.

@example
noinst_PROGRAMS = foo
foo_SOURCES = foo.c bindir.h
nodist_foo_SOURCES = bindir.c
CLEANFILES = bindir.c
bindir.c: Makefile
        echo 'const char bindir[] = "$(bindir)";' >$@
@end example

@file{bindir.h} contains just the variable's declaration and doesn't
need to be built, so it won't cause any trouble.  @file{bindir.o} is
always dependent on @file{bindir.c}, so @file{bindir.c} will get built
first.

@unnumberedsubsec Which is best?

There is no panacea, of course.  Each solution has its merits and
drawbacks.

You cannot use @code{BUILT_SOURCES} if the ability to run @code{make
foo} on a clean tree is important to you.

You won't add explicit dependencies if you are leery of overriding
an Automake rule by mistake.

Building files from @file{./configure} is not always possible, neither
is converting @file{.h} files into @file{.c} files.


@node Other GNU Tools
@chapter Other GNU Tools

Since Automake is primarily intended to generate @file{Makefile.in}s for
use in GNU programs, it tries hard to interoperate with other GNU tools.

@menu
* Emacs Lisp::                  Emacs Lisp
* gettext::                     Gettext
* Libtool::                     Libtool
* Java::                        Java
* Python::                      Python
@end menu


@node Emacs Lisp
@section Emacs Lisp

@cindex _LISP primary, defined
@cindex LISP primary, defined
@cindex Primary variable, LISP

@vindex LISP
@vindex lisp_LISP
@vindex noinst_LISP

Automake provides some support for Emacs Lisp.  The @samp{LISP} primary
is used to hold a list of @file{.el} files.  Possible prefixes for this
primary are @samp{lisp_} and @samp{noinst_}.  Note that if
@code{lisp_LISP} is defined, then @file{configure.ac} must run
@code{AM_PATH_LISPDIR} (@pxref{Macros}).

Automake will byte-compile all Emacs Lisp source files using the Emacs
found by @code{AM_PATH_LISPDIR}, if any was found.

Byte-compiled Emacs Lisp files are not portable among all versions of
Emacs, so it makes sense to turn this off if you expect sites to have
more than one version of Emacs installed.  Furthermore, many packages
don't actually benefit from byte-compilation.  Still, we recommend
that you byte-compile your Emacs Lisp sources.  It is probably better
for sites with strange setups to cope for themselves than to make the
installation less nice for everybody else.

There are two ways to avoid byte-compiling.  Historically, we have
recommended the following construct.
@example
lisp_LISP = file1.el file2.el
ELCFILES =
@end example
@noindent
@code{ELCFILES} is an internal Automake variable that normally lists
all @file{.elc} files that must be byte-compiled.  Automake defines
@code{ELCFILES} automatically from @code{lisp_LISP}.  Emptying this
variable explicitly prevents byte-compilation to occur.

Since Automake 1.8, we now recommend using @code{lisp_DATA} instead.  As
in
@example
lisp_DATA = file1.el file2.el
@end example

Note that these two constructs are not equivalent.  @code{_LISP} will
not install a file if Emacs is not installed, while @code{_DATA} will
always install its files.

@node gettext
@section Gettext

@cindex GNU Gettext support
@cindex Gettext support
@cindex Support for GNU Gettext

If @code{AM_GNU_GETTEXT} is seen in @file{configure.ac}, then Automake
turns on support for GNU gettext, a message catalog system for
internationalization
(@pxref{GNU Gettext, , , gettext, GNU gettext utilities}).

The @code{gettext} support in Automake requires the addition of two
subdirectories to the package, @file{intl} and @file{po}.  Automake
insures that these directories exist and are mentioned in
@code{SUBDIRS}.

@vindex dist_lisp_LISP
@vindex dist_noinst_LISP
Lisp sources are not distributed by default.  You can prefix the
@code{LISP} primary with @code{dist_}, as in @code{dist_lisp_LISP} or
@code{dist_noinst_LISP}, to indicate that these files should be
distributed.

@node Libtool
@section Libtool

Automake provides support for GNU Libtool (@pxref{Top, , Introduction,
libtool, The Libtool Manual}) with the @samp{LTLIBRARIES} primary.
@xref{A Shared Library}.


@node Java
@section Java

@cindex _JAVA primary, defined
@cindex JAVA primary, defined
@cindex Primary variable, JAVA

Automake provides some minimal support for Java compilation with the
@samp{JAVA} primary.

Any @file{.java} files listed in a @samp{_JAVA} variable will be
compiled with @code{JAVAC} at build time.  By default, @file{.class}
files are not included in the distribution.

@cindex JAVA restrictions
@cindex Restrictions for JAVA

Currently Automake enforces the restriction that only one @samp{_JAVA}
primary can be used in a given @file{Makefile.am}.  The reason for this
restriction is that, in general, it isn't possible to know which
@file{.class} files were generated from which @file{.java} files -- so
it would be impossible to know which files to install where.  For
instance, a @file{.java} file can define multiple classes; the resulting
@file{.class} file names cannot be predicted without parsing the
@file{.java} file.

There are a few variables which are used when compiling Java sources:

@vtable @code
@item JAVAC
The name of the Java compiler.  This defaults to @samp{javac}.

@item JAVACFLAGS
The flags to pass to the compiler.  This is considered to be a user
variable (@pxref{User Variables}).

@item AM_JAVACFLAGS
More flags to pass to the Java compiler.  This, and not
@code{JAVACFLAGS}, should be used when it is necessary to put Java
compiler flags into @file{Makefile.am}.

@item JAVAROOT
The value of this variable is passed to the @samp{-d} option to
@code{javac}.  It defaults to @samp{$(top_builddir)}.

@item CLASSPATH_ENV
This variable is an @code{sh} expression which is used to set the
@code{CLASSPATH} environment variable on the @code{javac} command line.
(In the future we will probably handle class path setting differently.)
@end vtable


@node Python
@section Python

@cindex _PYTHON primary, defined
@cindex PYTHON primary, defined
@cindex Primary variable, PYTHON


Automake provides support for Python compilation with the @samp{PYTHON}
primary.

Any files listed in a @samp{_PYTHON} variable will be byte-compiled with
@code{py-compile} at install time.  @code{py-compile} actually creates
both standard (@file{.pyc}) and byte-compiled (@file{.pyo}) versions of
the source files.  Note that because byte-compilation occurs at install
time, any files listed in @samp{noinst_PYTHON} will not be compiled.
Python source files are included in the distribution by default.

Automake ships with an Autoconf macro called @code{AM_PATH_PYTHON} which
will determine some Python-related directory variables (see below).  If
you have called @code{AM_PATH_PYTHON} from @file{configure.ac}, then you
may use the following variables to list you Python source files in your
variables: @samp{python_PYTHON}, @samp{pkgpython_PYTHON},
@samp{pyexecdir_PYTHON}, @samp{pkgpyexecdir_PYTHON}, depending where you
want your files installed.

@code{AM_PATH_PYTHON([@var{VERSION}], [@var{ACTION-IF-FOUND}],
[@var{ACTION-IF-NOT-FOUND}])} takes three optional arguments.  It will
search a Python interpreter on the system.  The first argument, if
present, is the minimum version of Python required for this package:
@code{AM_PATH_PYTHON} will skip any Python interpreter which is older
than @var{VERSION}.  If an interpreter is found and satisfies
@var{VERSION}, then @var{ACTION-IF-FOUND} is run.  Otherwise,
@var{ACTION-IF-NOT-FOUND} is run.

If @var{ACTION-IF-NOT-FOUND} is not specified, the default is to abort
configure.  This is fine when Python is an absolute requirement for the
package.  Therefore if Python >= 2.2 is only @emph{optional} to the
package, @code{AM_PATH_PYTHON} could be called as follows.

@example
  AM_PATH_PYTHON(2.2,, :)
@end example

@code{AM_PATH_PYTHON} creates several output variables based on the
Python installation found during configuration.

@vtable @code
@item PYTHON
The name of the Python executable, or @code{:} if no suitable
interpreter could be found.

Assuming @var{ACTION-IF-NOT-FOUND} is used (otherwise @file{./configure}
will abort if Python is absent), the value of @code{PYTHON} can be used
to setup a conditional in order to disable the relevant part of a build
as follows.

@example
  AM_PATH_PYTHON(,, :)
  AM_CONDITIONAL([HAVE_PYTHON], [test "$PYTHON" != :])
@end example


If the @var{ACTION-IF-NOT-FOUND}
is specified

@item PYTHON_VERSION
The Python version number, in the form @var{major}.@var{minor}
(e.g. @samp{1.5}).  This is currently the value of
@code{sys.version[:3]}.

@item PYTHON_PREFIX
The string @code{$@{prefix@}}.  This term may be used in future work
which needs the contents of Python's @code{sys.prefix}, but general
consensus is to always use the value from configure.

@item PYTHON_EXEC_PREFIX
The string @code{$@{exec_prefix@}}.  This term may be used in future work
which needs the contents of Python's @code{sys.exec_prefix}, but general
consensus is to always use the value from configure.

@item PYTHON_PLATFORM
The canonical name used by Python to describe the operating system, as
given by @code{sys.platform}.  This value is sometimes needed when
building Python extensions.

@item pythondir
The directory name for the @file{site-packages} subdirectory of the
standard Python install tree.

@item pkgpythondir
This is is the directory under @code{pythondir} which is named after the
package.  That is, it is @samp{$(pythondir)/$(PACKAGE)}.  It is provided
as a convenience.

@item pyexecdir
This is the directory where Python extension modules (shared libraries)
should be installed.

@item pkgpyexecdir
This is a convenience variable which is defined as
@samp{$(pyexecdir)/$(PACKAGE)}.
@end vtable

All these directory variables have values that start with either
@code{$@{prefix@}} or @code{$@{exec_prefix@}} unexpanded.  This works
fine in @file{Makefiles}, but it makes these variables hard to use in
@file{configure}.  This is mandated by the GNU coding standards, so
that the user can run @code{make prefix=/foo install}.  The Autoconf
manual has a section with more details on this topic
(@pxref{Installation Directory Variables, , Installation Directory
Variables, autoconf, The Autoconf Manual}).


@node Documentation
@chapter Building documentation

Currently Automake provides support for Texinfo and man pages.

@menu
* Texinfo::                     Texinfo
* Man pages::                   Man pages
@end menu


@node Texinfo
@section Texinfo

@cindex _TEXINFOS primary, defined
@cindex TEXINFOS primary, defined
@cindex Primary variable, TEXINFOS
@cindex HTML output using Texinfo
@cindex PDF output using Texinfo
@cindex PS output using Texinfo
@cindex DVI output using Texinfo

If the current directory contains Texinfo source, you must declare it
with the @samp{TEXINFOS} primary.  Generally Texinfo files are converted
into info, and thus the @code{info_TEXINFOS} variable is most commonly used
here.  Any Texinfo source file must end in the @file{.texi},
@file{.txi}, or @file{.texinfo} extension.  We recommend @file{.texi}
for new manuals.
@vindex TEXINFOS
@vindex info_TEXINFOS

Automake generates rules to build @file{.info}, @file{.dvi}, @file{.ps},
@file{.pdf} and @file{.html} files from your Texinfo sources.
The @file{.info} files are built by @code{make all} and installed
by @code{make install} (unless you use @code{no-installinfo}, see below).
The other files can be built on request by @code{make dvi}, @code{make ps},
@code{make pdf} and @code{make html}.

@cindex Texinfo flag, VERSION
@cindex Texinfo flag, UPDATED
@cindex Texinfo flag, EDITION
@cindex Texinfo flag, UPDATED-MONTH

@cindex VERSION Texinfo flag
@cindex UPDATED Texinfo flag
@cindex EDITION Texinfo flag
@cindex UPDATED-MONTH Texinfo flag

@cindex mdate-sh

If the @file{.texi} file @code{@@include}s @file{version.texi}, then
that file will be automatically generated.  The file @file{version.texi}
defines four Texinfo flag you can reference using
@code{@@value@{EDITION@}}, @code{@@value@{VERSION@}},
@code{@@value@{UPDATED@}}, and @code{@@value@{UPDATED-MONTH@}}.

@table @code
@item EDITION
@itemx VERSION
Both of these flags hold the version number of your program.  They are
kept separate for clarity.

@item UPDATED
This holds the date the primary @file{.texi} file was last modified.

@item UPDATED-MONTH
This holds the name of the month in which the primary @file{.texi} file
was last modified.
@end table

The @file{version.texi} support requires the @code{mdate-sh} program;
this program is supplied with Automake and automatically included when
@code{automake} is invoked with the @code{--add-missing} option.

If you have multiple Texinfo files, and you want to use the
@file{version.texi} feature, then you have to have a separate version
file for each Texinfo file.  Automake will treat any include in a
Texinfo file that matches @samp{vers*.texi} just as an automatically
generated version file.

Sometimes an info file actually depends on more than one @file{.texi}
file.  For instance, in GNU Hello, @file{hello.texi} includes the file
@file{gpl.texi}.  You can tell Automake about these dependencies using
the @code{@var{texi}_TEXINFOS} variable.  Here is how GNU Hello does it:
@vindex TEXINFOS
@vindex _TEXINFOS

@example
info_TEXINFOS = hello.texi
hello_TEXINFOS = gpl.texi
@end example

@cindex texinfo.tex

By default, Automake requires the file @file{texinfo.tex} to appear in
the same directory as the Texinfo source (this can be changed using the
@code{TEXINFO_TEX} variable, see below).  However, if you used
@code{AC_CONFIG_AUX_DIR} in @file{configure.ac} (@pxref{Input, , Finding
`configure' Input, autoconf, The Autoconf Manual}), then
@file{texinfo.tex} is looked for there.  Automake supplies
@file{texinfo.tex} if @samp{--add-missing} is given.

@opindex no-texinfo.tex

The option @samp{no-texinfo.tex} can be used to eliminate the
requirement for @file{texinfo.tex}.  Use of the variable
@code{TEXINFO_TEX} is preferable, however, because that allows the
@code{dvi}, @code{ps}, and @code{pdf} targets to still work.

@cindex Rule, install-info
@cindex Rule, noinstall-info
@cindex Target, install-info
@cindex Target, noinstall-info
@cindex install-info target
@cindex noinstall-info target

@opindex no-installinfo
@trindex install-info

Automake generates an @code{install-info} rule; some people apparently
use this.  By default, info pages are installed by @samp{make install}.
This can be prevented via the @code{no-installinfo} option.

The following variables are used by the Texinfo build rules.

@vtable @code
@item MAKEINFO
The name of the program invoked to build @file{.info} files.  This
variable is defined by Automake.  If the @code{makeinfo} program is
found on the system then it will be used by default; otherwise
@code{missing} will be used instead.

@item MAKEINFOHTML
The command invoked to build @file{.html} files.  Automake
defines this to @code{$(MAKEINFO) --html}.

@item MAKEINFOFLAGS
User flags passed to each invocation of @code{$(MAKEINFO)} and
@code{$(MAKEINFOHTML)}.  This user variable (@pxref{User Variables}) is
not expected to be defined in any @file{Makefile}; it can be used by
users to pass extra flags to suit their needs.

@item AM_MAKEINFOFLAGS
@itemx AM_MAKEINFOHTMLFLAGS
Maintainer flags passed to each @code{makeinfo} invocation.  These
are maintainer variables that can be overridden in @file{Makefile.am}.
@code{$(AM_MAKEINFOFLAGS)} is passed to @code{makeinfo} when building
@file{.info} files; and @code{$(AM_MAKEINFOHTMLFLAGS)} is used when
building @file{.html} files.

For instance the following setting can be used to obtain one single
@file{.html} file per manual, without node separators.
@example
AM_MAKEINFOHTMLFLAGS = --no-headers --no-split
@end example

By default, @code{$(AM_MAKEINFOHTMLFLAGS)} is set to
@code{$(AM_MAKEINFOFLAGS)}.  This means that defining
@code{$(AM_MAKEINFOFLAGS)} without defining
@code{$(AM_MAKEINFOHTMLFLAGS)} will impact builds of both @file{.info}
and @file{.html} files.

@item TEXI2DVI
The name of the command that converts a @file{.texi} file into a
@file{.dvi} file.  This defaults to @code{texi2dvi}, a script that ships
with the Texinfo package.

@item TEXI2PDF
The name of the command that translates a @file{.texi} file into a
@file{.pdf} file.  This defaults to @code{$(TEXI2DVI) --pdf --batch}.

@item DVIPS
The name of the command that build a @file{.ps} file out of a
@file{.dvi} file.  This defaults to @code{dvips}.

@item TEXINFO_TEX

If your package has Texinfo files in many directories, you can use the
variable @code{TEXINFO_TEX} to tell Automake where to find the canonical
@file{texinfo.tex} for your package.  The value of this variable should
be the relative path from the current @file{Makefile.am} to
@file{texinfo.tex}:

@example
TEXINFO_TEX = ../doc/texinfo.tex
@end example
@end vtable


@node Man pages
@section Man pages

@cindex _MANS primary, defined
@cindex MANS primary, defined
@cindex Primary variable, MANS

A package can also include man pages (but see the GNU standards on this
matter, @ref{Man Pages, , , standards, The GNU Coding Standards}.)  Man
pages are declared using the @samp{MANS} primary.  Generally the
@code{man_MANS} variable is used.  Man pages are automatically installed in
the correct subdirectory of @code{mandir}, based on the file extension.
@vindex MANS
@vindex man_MANS

File extensions such as @samp{.1c} are handled by looking for the valid
part of the extension and using that to determine the correct
subdirectory of @code{mandir}.  Valid section names are the digits
@samp{0} through @samp{9}, and the letters @samp{l} and @samp{n}.

Sometimes developers prefer to name a man page something like
@file{foo.man} in the source, and then rename it to have the correct
suffix, e.g. @file{foo.1}, when installing the file.  Automake also
supports this mode.  For a valid section named @var{SECTION}, there is a
corresponding directory named @samp{man@var{SECTION}dir}, and a
corresponding @samp{_MANS} variable.  Files listed in such a variable
are installed in the indicated section.  If the file already has a
valid suffix, then it is installed as-is; otherwise the file suffix is
changed to match the section.

For instance, consider this example:
@example
man1_MANS = rename.man thesame.1 alsothesame.1c
@end example

In this case, @file{rename.man} will be renamed to @file{rename.1} when
installed, but the other files will keep their names.

@cindex Rule, install-man
@cindex Rule, noinstall-man
@cindex Target, install-man
@cindex Target, noinstall-man
@cindex install-man target
@cindex noinstall-man target

@c Use @samp{make install} per documentation: (texi)code.
By default, man pages are installed by @samp{make install}.  However,
since the GNU project does not require man pages, many maintainers do
not expend effort to keep the man pages up to date.  In these cases, the
@code{no-installman} option will prevent the man pages from being
installed by default.  The user can still explicitly install them via
@samp{make install-man}.
@opindex no-installman
@trindex install-man

Here is how the man pages are handled in GNU @code{cpio} (which includes
both Texinfo documentation and man pages):

@example
man_MANS = cpio.1 mt.1
EXTRA_DIST = $(man_MANS)
@end example

Man pages are not currently considered to be source, because it is not
uncommon for man pages to be automatically generated.  Therefore they
are not automatically included in the distribution.  However, this can
be changed by use of the @samp{dist_} prefix.

The @samp{nobase_} prefix is meaningless for man pages and is
disallowed.


@node Install
@chapter What Gets Installed

@cindex Installation support
@cindex make install support

@section Basics of installation

Naturally, Automake handles the details of actually installing your
program once it has been built.  All files named by the various
primaries are automatically installed in the appropriate places when the
user runs @code{make install}.

A file named in a primary is installed by copying the built file into
the appropriate directory.  The base name of the file is used when
installing.

@example
bin_PROGRAMS = hello subdir/goodbye
@end example

In this example, both @samp{hello} and @samp{goodbye} will be installed
in @code{$(bindir)}.

Sometimes it is useful to avoid the basename step at install time.  For
instance, you might have a number of header files in subdirectories of
the source tree which are laid out precisely how you want to install
them.  In this situation you can use the @samp{nobase_} prefix to
suppress the base name step.  For example:

@example
nobase_include_HEADERS = stdio.h sys/types.h
@end example

Will install @file{stdio.h} in @code{$(includedir)} and @file{types.h}
in @code{$(includedir)/sys}.

@section The two parts of install

Automake generates separate @code{install-data} and @code{install-exec}
rules, in case the installer is installing on multiple machines which
share directory structure---these targets allow the machine-independent
parts to be installed only once.  @code{install-exec} installs
platform-dependent files, and @code{install-data} installs
platform-independent files.  The @code{install} target depends on both
of these targets.  While Automake tries to automatically segregate
objects into the correct category, the @file{Makefile.am} author is, in
the end, responsible for making sure this is done correctly.
@trindex install-data
@trindex install-exec
@trindex install
@cindex Install, two parts of

Variables using the standard directory prefixes @samp{data},
@samp{info}, @samp{man}, @samp{include}, @samp{oldinclude},
@samp{pkgdata}, or @samp{pkginclude} (e.g. @samp{data_DATA}) are
installed by @samp{install-data}.

Variables using the standard directory prefixes @samp{bin}, @samp{sbin},
@samp{libexec}, @samp{sysconf}, @samp{localstate}, @samp{lib}, or
@samp{pkglib} (e.g. @samp{bin_PROGRAMS}) are installed by
@samp{install-exec}.

Any variable using a user-defined directory prefix with @samp{exec} in
the name (e.g. @samp{myexecbin_PROGRAMS} is installed by
@samp{install-exec}.  All other user-defined prefixes are installed by
@samp{install-data}.

@section Extending installation

It is possible to extend this mechanism by defining an
@code{install-exec-local} or @code{install-data-local} rule.  If these
rules exist, they will be run at @samp{make install} time.  These
rules can do almost anything; care is required.
@trindex install-exec-local
@trindex install-data-local

Automake also supports two install hooks, @code{install-exec-hook} and
@code{install-data-hook}.  These hooks are run after all other install
rules of the appropriate type, exec or data, have completed.  So, for
instance, it is possible to perform post-installation modifications
using an install hook.
@cindex Install hook

@section Staged installs

@vindex DESTDIR
Automake generates support for the @samp{DESTDIR} variable in all
install rules.  @samp{DESTDIR} is used during the @samp{make install}
step to relocate install objects into a staging area.  Each object and
path is prefixed with the value of @samp{DESTDIR} before being copied
into the install area.  Here is an example of typical DESTDIR usage:

@example
mkdir /tmp/staging &&
make DESTDIR=/tmp/staging install
@end example

The @command{mkdir} command avoids a security problem if the attacker
creates a symbolic link from @file{/tmp/staging} to a victim area;
then @command{make} places install objects in a directory tree built under
@file{/tmp/staging}.  If @file{/gnu/bin/foo} and
@file{/gnu/share/aclocal/foo.m4} are to be installed, the above command
would install @file{/tmp/staging/gnu/bin/foo} and
@file{/tmp/staging/gnu/share/aclocal/foo.m4}.

This feature is commonly used to build install images and packages.  For
more information, see @ref{Makefile Conventions, , , standards, The GNU
Coding Standards}.

Support for @samp{DESTDIR} is implemented by coding it directly into the
install rules.  If your @file{Makefile.am} uses a local install rule
(e.g., @code{install-exec-local}) or an install hook, then you must
write that code to respect @samp{DESTDIR}.

@section Rules for the user

Automake also generates rules for targets @code{uninstall},
@code{installdirs}, and @code{install-strip}.
@trindex uninstall
@trindex installdirs
@trindex install-strip

Automake supports @code{uninstall-local} and @code{uninstall-hook}.
There is no notion of separate uninstalls for ``exec'' and ``data'', as
these features would not provide additional functionality.

Note that @code{uninstall} is not meant as a replacement for a real
packaging tool.


@node Clean
@chapter What Gets Cleaned

@cindex make clean support

The GNU Makefile Standards specify a number of different clean rules.
See @xref{Standard Targets, , Standard Targets for Users, standards,
The GNU Coding Standards}.

Generally the files that can be cleaned are determined automatically by
Automake.  Of course, Automake also recognizes some variables that can
be defined to specify additional files to clean.  These variables are
@code{MOSTLYCLEANFILES}, @code{CLEANFILES}, @code{DISTCLEANFILES}, and
@code{MAINTAINERCLEANFILES}.
@vindex MOSTLYCLEANFILES
@vindex CLEANFILES
@vindex DISTCLEANFILES
@vindex MAINTAINERCLEANFILES

As the GNU Standards aren't always explicit as to which files should be
removed by which rule, we've adopted a heuristic which we believe was
first formulated by Fran@,{c}ois Pinard:

@itemize @bullet
@item
If @code{make} built it, and it is commonly something that one would
want to rebuild (for instance, a @file{.o} file), then
@code{mostlyclean} should delete it.

@item
Otherwise, if @code{make} built it, then @code{clean} should delete it.

@item
If @code{configure} built it, then @code{distclean} should delete it.

@item
If the maintainer built it (for instance, a @file{.info} file), then
@code{maintainer-clean} should delete it.  However
@code{maintainer-clean} should not delete anything that needs to exist
in order to run @code{./configure && make}.
@end itemize

We recommend that you follow this same set of heuristics in your
@file{Makefile.am}.


@node Dist
@chapter What Goes in a Distribution

@section Basics of distribution

@cindex make dist

The @code{dist} rule in the generated @file{Makefile.in} can be used
to generate a gzip'd @code{tar} file and other flavors of archive for
distribution.  The files is named based on the @samp{PACKAGE} and
@samp{VERSION} variables defined by @code{AM_INIT_AUTOMAKE}
(@pxref{Macros}); more precisely the gzip'd @code{tar} file is named
@samp{@var{package}-@var{version}.tar.gz}.
@cvindex PACKAGE
@cvindex VERSION
@trindex dist
You can use the @code{make} variable @samp{GZIP_ENV} to control how gzip
is run.  The default setting is @samp{--best}.

For the most part, the files to distribute are automatically found by
Automake: all source files are automatically included in a distribution,
as are all @file{Makefile.am}s and @file{Makefile.in}s.  Automake also
has a built-in list of commonly used files which are automatically
included if they are found in the current directory (either physically,
or as the target of a @file{Makefile.am} rule).  This list is printed by
@samp{automake --help}.  Also, files which are read by @code{configure}
(i.e. the source files corresponding to the files specified in various
Autoconf macros such as @code{AC_CONFIG_FILES} and siblings) are
automatically distributed.  Files included in @file{Makefile.am}s (using
@code{include}) or in @file{configure.ac} (using @code{m4_include}), and
helper scripts installed with @samp{automake --add-missing} are also
distributed.

@cvindex m4_include, distribution

Still, sometimes there are files which must be distributed, but which
are not covered in the automatic rules.  These files should be listed in
the @code{EXTRA_DIST} variable.  You can mention files from
subdirectories in @code{EXTRA_DIST}.

You can also mention a directory in @code{EXTRA_DIST}; in this case the
entire directory will be recursively copied into the distribution.
Please note that this will also copy @emph{everything} in the directory,
including CVS/RCS version control files.  We recommend against using
this feature.
@vindex EXTRA_DIST

If you define @code{SUBDIRS}, Automake will recursively include the
subdirectories in the distribution.  If @code{SUBDIRS} is defined
conditionally (@pxref{Conditionals}), Automake will normally include
all directories that could possibly appear in @code{SUBDIRS} in the
distribution.  If you need to specify the set of directories
conditionally, you can set the variable @code{DIST_SUBDIRS} to the
exact list of subdirectories to include in the distribution
(@pxref{Conditional Subdirectories}).
@vindex DIST_SUBDIRS


@section Fine-grained distribution control

Sometimes you need tighter control over what does @emph{not} go into the
distribution; for instance you might have source files which are
generated and which you do not want to distribute.  In this case
Automake gives fine-grained control using the @samp{dist} and
@samp{nodist} prefixes.  Any primary or @samp{_SOURCES} variable can be
prefixed with @samp{dist_} to add the listed files to the distribution.
Similarly, @samp{nodist_} can be used to omit the files from the
distribution.
@vindex dist_
@vindex nodist_

As an example, here is how you would cause some data to be distributed
while leaving some source code out of the distribution:

@example
dist_data_DATA = distribute-this
bin_PROGRAMS = foo
nodist_foo_SOURCES = do-not-distribute.c
@end example

@section The dist hook

@trindex dist-hook

Occasionally it is useful to be able to change the distribution before
it is packaged up.  If the @code{dist-hook} rule exists, it is run
after the distribution directory is filled, but before the actual tar
(or shar) file is created.  One way to use this is for distributing
files in subdirectories for which a new @file{Makefile.am} is overkill:

@example
dist-hook:
        mkdir $(distdir)/random
        cp -p $(srcdir)/random/a1 $(srcdir)/random/a2 $(distdir)/random
@end example

Another way to to use this is for removing unnecessary files that get
recursively included by specifying a directory in EXTRA_DIST:

@example
EXTRA_DIST = doc

dist-hook:
	rm -rf `find $(distdir)/doc -name CVS`
@end example

@vindex distdir
@vindex top_distdir
Two variables that come handy when writing @code{dist-hook} rules are
@code{$(distdir)} and @code{$(top_distdir)}.

@code{$(distdir)} points to the directory where the @code{dist} rule
will copy files from the current directory before creating the
tarball.  If you are at the top-level directory, then @code{distdir =
$(PACKAGE)-$(VERSION)}.  When used from subdirectory named
@file{foo/}, then @code{distdir = ../$(PACKAGE)-$(VERSION)/foo}.
@code{$(distdir)} can be a relative or absolute path, do not assume
any form.

@code{$(top_distdir)} always points to the root directory of the
distributed tree.  At the top-level it's equal to @code{$(distdir)}.
In the @file{foo/} subdirectory
@code{top_distdir = ../$(PACKAGE)-$(VERSION)}.
@code{$(top_distdir)} too can be a relative or absolute path.

Note that when packages are nested using @code{AC_CONFIG_SUBDIRS}
(@pxref{Subpackages}), then @code{$(distdir)} and
@code{$(top_distdir)} are relative to the package where @code{make
dist} was run, not to any sub-packages involved.

@section Checking the distribution

@cindex make distcheck
@cindex make distcleancheck
@vindex distcleancheck_listfiles
@cindex make distuninstallcheck
@vindex distuninstallcheck_listfiles

Automake also generates a @code{distcheck} rule which can be of help
to ensure that a given distribution will actually work.
@code{distcheck} makes a distribution, then tries to do a @code{VPATH}
build, run the test suite, and finally make another tarfile to ensure the
distribution is self-contained.
@trindex distcheck

Building the package involves running @code{./configure}.  If you need
to supply additional flags to @code{configure}, define them in the
@code{DISTCHECK_CONFIGURE_FLAGS} variable, either in your top-level
@file{Makefile.am}, or on the command line when invoking @code{make}.
@vindex DISTCHECK_CONFIGURE_FLAGS

If the @code{distcheck-hook} rule is defined in your top-level
@file{Makefile.am}, then it will be invoked by @code{distcheck} after
the new distribution has been unpacked, but before the unpacked copy
is configured and built.  Your @code{distcheck-hook} can do almost
anything, though as always caution is advised.  Generally this hook is
used to check for potential distribution errors not caught by the
standard mechanism.  Note that @code{distcheck-hook} as well as
@code{DISTCHECK_CONFIGURE_FLAGS} are not honored in a subpackage
@file{Makefile.am}, but the @code{DISTCHECK_CONFIGURE_FLAGS} are
passed down to the @code{configure} script of the subpackage.


Speaking about potential distribution errors, @code{distcheck} will also
ensure that the @code{distclean} rule actually removes all built
files.  This is done by running @code{make distcleancheck} at the end of
the @code{VPATH} build.  By default, @code{distcleancheck} will run
@code{distclean} and then make sure the build tree has been emptied by
running @code{$(distcleancheck_listfiles)}.  Usually this check will
find generated files that you forgot to add to the @code{DISTCLEANFILES}
variable (@pxref{Clean}).
@trindex distcleancheck

The @code{distcleancheck} behavior should be OK for most packages,
otherwise you have the possibility to override the definition of
either the @code{distcleancheck} rule, or the
@code{$(distcleancheck_listfiles)} variable.  For instance to disable
@code{distcleancheck} completely, add the following rule to your
top-level @file{Makefile.am}:
@vindex distcleancheck_listfiles

@example
distcleancheck:
        @@:
@end example

If you want @code{distcleancheck} to ignore built files which have not
been cleaned because they are also part of the distribution, add the
following definition instead:

@example
distcleancheck_listfiles = \
  find -type f -exec sh -c 'test -f $(srcdir)/@{@} || echo @{@}' ';'
@end example

The above definition is not the default because it's usually an error if
your Makefiles cause some distributed files to be rebuilt when the user
build the package.  (Think about the user missing the tool required to
build the file; or if the required tool is built by your package,
consider the cross-compilation case where it can't be run.)  There is
a FAQ entry about this (@pxref{distcleancheck}), make sure you read it
before playing with @code{distcleancheck_listfiles}.

@code{distcheck} also checks that the @code{uninstall} rule works
properly, both for ordinary and @samp{DESTDIR} builds.  It does this
by invoking @code{make uninstall}, and then it checks the install tree
to see if any files are left over.  This check will make sure that you
correctly coded your @code{uninstall}-related rules.

By default, the checking is done by the @code{distuninstallcheck} rule,
and the list of files in the install tree is generated by
@code{$(distuninstallcheck_listfiles}) (this is a variable whose value is
a shell command to run that prints the list of files to stdout).

Either of these can be overridden to modify the behavior of
@code{distcheck}.  For instance, to disable this check completely, you
would write:

@example
distuninstallcheck:
        @@:
@end example

@section The types of distributions

Automake generates rules to provide archives of the project for
distributions in various formats.  Their targets are:

@table @asis
@item @code{dist-bzip2}
Generate a bzip2 tar archive of the distribution.  bzip2 archives are
frequently smaller than gzipped archives.
@trindex dist-bzip2

@item @code{dist-gzip}
Generate a gzip tar archive of the distribution.
@trindex dist-gzip

@item @code{dist-shar}
Generate a shar archive of the distribution.
@trindex dist-shar

@item @code{dist-zip}
Generate a zip archive of the distribution.
@trindex dist-zip

@item @code{dist-tarZ}
Generate a compressed tar archive of
the distribution.
@trindex dist-tarZ
@end table

The rule @code{dist} (and its historical synonym @code{dist-all}) will
create archives in all the enabled formats, @ref{Options}.  By
default, only the @code{dist-gzip} target is hooked to @code{dist}.


@node Tests
@chapter Support for test suites

@cindex Test suites
@cindex make check

Automake supports two forms of test suites.

@section Simple Tests

If the variable @code{TESTS} is defined, its value is taken to be a list
of programs to run in order to do the testing.  The programs can either
be derived objects or source objects; the generated rule will look both
in @code{srcdir} and @file{.}.  Programs needing data files should look
for them in @code{srcdir} (which is both an environment variable and a
make variable) so they work when building in a separate directory
(@pxref{Build Directories, , Build Directories , autoconf, The Autoconf
Manual}), and in particular for the @code{distcheck} rule
(@pxref{Dist}).

@cindex Exit status 77, special interpretation

The number of failures will be printed at the end of the run.  If a
given test program exits with a status of 77, then its result is ignored
in the final count.  This feature allows non-portable tests to be
ignored in environments where they don't make sense.

The variable @code{TESTS_ENVIRONMENT} can be used to set environment
variables for the test run; the environment variable @code{srcdir} is
set in the rule.  If all your test programs are scripts, you can also
set @code{TESTS_ENVIRONMENT} to an invocation of the shell (e.g.
@samp{$(SHELL) -x}); this can be useful for debugging the tests.
@vindex TESTS
@vindex TESTS_ENVIRONMENT

@cindex Tests, expected failure
@cindex Expected test failure

You may define the variable @code{XFAIL_TESTS} to a list of tests
(usually a subset of @code{TESTS}) that are expected to fail.  This will
reverse the result of those tests.
@vindex XFAIL_TESTS

Automake ensures that each program listed in @code{TESTS} is built
before any tests are run; you can list both source and derived programs
in @code{TESTS}.  For instance, you might want to run a C program as a
test.  To do this you would list its name in @code{TESTS} and also in
@code{check_PROGRAMS}, and then specify it as you would any other
program.

@section DejaGnu Tests

If @uref{ftp://ftp.gnu.org/gnu/dejagnu/, @samp{dejagnu}} appears in
@code{AUTOMAKE_OPTIONS}, then a @code{dejagnu}-based test suite is
assumed.  The variable @code{DEJATOOL} is a list of names which are
passed, one at a time, as the @code{--tool} argument to @code{runtest}
invocations; it defaults to the name of the package.

The variable @code{RUNTESTDEFAULTFLAGS} holds the @code{--tool} and
@code{--srcdir} flags that are passed to dejagnu by default; this can be
overridden if necessary.
@vindex RUNTESTDEFAULTFLAGS

The variables @code{EXPECT} and @code{RUNTEST} can
also be overridden to provide project-specific values.  For instance,
you will need to do this if you are testing a compiler toolchain,
because the default values do not take into account host and target
names.
@opindex dejagnu
@vindex DEJATOOL
@vindex EXPECT
@vindex RUNTEST

The contents of the variable @code{RUNTESTFLAGS} are passed to the
@code{runtest} invocation.  This is considered a ``user variable''
(@pxref{User Variables}).  If you need to set @code{runtest} flags in
@file{Makefile.am}, you can use @code{AM_RUNTESTFLAGS} instead.
@vindex RUNTESTFLAGS
@vindex AM_RUNTESTFLAGS

@cindex @file{site.exp}
Automake will generate rules to create a local @file{site.exp} file,
defining various variables detected by @code{./configure}.  This file
is automatically read by DejaGnu.  It is OK for the user of a package
to edit this file in order to tune the test suite.  However this is
not the place where the test suite author should define new variables:
this should be done elsewhere in the real test suite code.
Especially, @file{site.exp} should not be distributed.

For more information regarding DejaGnu test suites, see @xref{Top, , ,
dejagnu, The DejaGnu Manual}.

In either case, the testing is done via @samp{make check}.

@section Install Tests

The @code{installcheck} target is available to the user as a way to
run any tests after the package has been installed.  You can add tests
to this by writing an @code{installcheck-local} rule.


@node Rebuilding
@chapter Rebuilding Makefiles
@cindex rebuild rules

Automake generates rules to automatically rebuild @file{Makefile}s,
@file{configure}, and other derived files like @file{Makefile.in}.

@cvindex AM_MAINTAINER_MODE
If you are using @code{AM_MAINTAINER_MODE} in @file{configure.ac}, then
these automatic rebuilding rules are only enabled in maintainer mode.

@vindex ACLOCAL_AMFLAGS
Sometimes you need to run @code{aclocal} with an argument like @code{-I}
to tell it where to find @file{.m4} files.  Since sometimes @code{make}
will automatically run @code{aclocal}, you need a way to specify these
arguments.  You can do this by defining @code{ACLOCAL_AMFLAGS}; this
holds arguments which are passed verbatim to @code{aclocal}.  This variable
is only useful in the top-level @file{Makefile.am}.

@vindex CONFIG_STATUS_DEPENDENCIES
@vindex CONFIGURE_DEPENDENCIES
@cindex @file{version.sh}, example
@cindex @file{version.m4}, example

Sometimes it is convenient to supplement the rebuild rules for
@file{configure} or @file{config.status} with additional dependencies.
The variables @code{CONFIGURE_DEPENDENCIES} and
@code{CONFIG_STATUS_DEPENDENCIES} can be used to list these extra
dependencies.  These variable should be defined in all
@file{Makefile}s of the tree (because these two rebuild rules are
output in all them), so it is safer and easier to @code{AC_SUBST} them
from @file{configure.ac}.  For instance the following statement will
cause @file{configure} to be rerun each time @file{version.sh} is
changed.
@example
AC_SUBST([CONFIG_STATUS_DEPENDENCIES], ['$(top_srcdir)/version.sh'])
@end example
@noindent
Note the @code{$(top_srcdir)/} in the filename.  Since this variable
is to be used in all @file{Makefile}s, its value must be sensible at
any level in the build hierarchy.

Beware not to mistake @code{CONFIGURE_DEPENDENCIES} for
@code{CONFIG_STATUS_DEPENDENCIES}.

@code{CONFIGURE_DEPENDENCIES} adds dependencies to the
@file{configure} rule, whose effect is to run @code{autoconf}.  This
variable should be seldom used, because @code{automake} already tracks
@code{m4_include}d files.  However it can be useful when playing
tricky games with @code{m4_esyscmd} or similar non-recommendable
macros with side effects.

@code{CONFIG_STATUS_DEPENDENCIES} adds dependencies to the
@file{config.status} rule, whose effect is to run @file{configure}.
This variable should therefore carry any non-standard source that may
be read as a side effect of running configure, like @file{version.sh}
in the example above.

Speaking of @file{version.sh} scripts, we recommend against them
today.  They are mainly used when the version of a package is updated
automatically by a script (e.g., in daily builds).  Here is what some
old-style @file{configure.ac}s may look like:
@example
AC_INIT
. $srcdir/version.sh
AM_INIT_AUTOMAKE([name], $VERSION_NUMBER)
@dots{}
@end example
@noindent
Here, @file{version.sh} is a shell fragment that sets
@code{VERSION_NUMBER}.  The problem with this example is that
@code{automake} cannot track dependencies (listing @file{version.sh}
in @code{CONFIG_STATUS_DEPENDENCIES}, and distributing this file is up
to the user), and that it uses the obsolete form of @code{AC_INIT} and
@code{AM_INIT_AUTOMAKE}.  Upgrading to the new syntax is not
straightforward, because shell variables are not allowed in
@code{AC_INIT}'s arguments.  We recommend that @file{version.sh} be
replaced by an M4 file that is included by @file{configure.ac}:
@example
m4_include([version.m4])
AC_INIT([name], VERSION_NUMBER)
AM_INIT_AUTOMAKE
@dots{}
@end example
@noindent
Here @file{version.m4} could contain something like
@code{m4_define([VERSION_NUMBER], [1.2])}.  The advantage of this
second form is that @code{automake} will take care of the dependencies
when defining the rebuild rule, and will also distribute the file
automatically.  An inconvenience is that @code{autoconf} will now be
rerun each time the version number is bumped, when only
@file{configure} had to be rerun in the previous setup.


@node Options
@chapter Changing Automake's Behavior

Various features of Automake can be controlled by options in the
@file{Makefile.am}.  Such options are applied on a per-@file{Makefile}
basis when listed in a special @file{Makefile} variable named
@code{AUTOMAKE_OPTIONS}.  They are applied globally to all processed
@file{Makefiles} when listed in the first argument of
@code{AM_INIT_AUTOMAKE} in @file{configure.ac}.  Currently understood
options are:
@vindex AUTOMAKE_OPTIONS

@table @asis
@item @code{gnits}
@itemx @code{gnu}
@itemx @code{foreign}
@itemx @code{cygnus}
@cindex Option, gnits
@cindex Option, gnu
@cindex Option, foreign
@cindex Option, cygnus

Set the strictness as appropriate.  The @code{gnits} option also implies
@code{readme-alpha} and @code{check-news}.

@item @code{ansi2knr}
@itemx @code{@var{path}/ansi2knr}
@cindex Option, ansi2knr
Turn on automatic de-ANSI-fication.  @xref{ANSI}.  If preceded by a
path, the generated @file{Makefile.in} will look in the specified
directory to find the @file{ansi2knr} program.  The path should be a
relative path to another directory in the same distribution (Automake
currently does not check this).

@item @code{check-news}
@cindex Option, check-news
Cause @code{make dist} to fail unless the current version number appears
in the first few lines of the @file{NEWS} file.

@item @code{dejagnu}
@cindex Option, dejagnu
Cause @code{dejagnu}-specific rules to be generated.  @xref{Tests}.

@item @code{dist-bzip2}
@cindex Option, dist-bzip2
Hook @code{dist-bzip2} to @code{dist}.
@trindex dist-bzip2

@item @code{dist-shar}
@cindex Option, dist-shar
Hook @code{dist-shar} to @code{dist}.
@trindex dist-shar

@item @code{dist-zip}
@cindex Option, dist-zip
Hook @code{dist-zip} to @code{dist}.
@trindex dist-zip

@item @code{dist-tarZ}
@cindex Option, dist-tarZ
Hook @code{dist-tarZ} to @code{dist}.
@trindex dist-tarZ

@item @code{filename-length-max=99}
@cindex Option, filename-length-max=99
@trindex filename-length-max=99
Abort if filenames longer than 99 characters are found during
@code{make dist}.  Such long filenames are generally considered not to
be portable in tarballs.  See the @code{tar-v7} and @code{tar-ustar}
options below.  This option should be used in the top-level
@file{Makefile.am} or as an argument of @code{AM_INIT_AUTOMAKE} in
@file{configure.ac}, it will be ignored otherwise.

@item @code{no-define}
@cindex Option, no-define
This options is meaningful only when passed as an argument to
@code{AM_INIT_AUTOMAKE}.  It will prevent the @code{PACKAGE} and
@code{VERSION} variables to be @code{AC_DEFINE}d.

@item @code{no-dependencies}
@cindex Option, no-dependencies
This is similar to using @samp{--include-deps} on the command line, but
is useful for those situations where you don't have the necessary bits
to make automatic dependency tracking work @xref{Dependencies}.  In this
case the effect is to effectively disable automatic dependency tracking.

@item @code{no-dist}
@cindex Option, no-dist
Don't emit any code related to @code{dist} target.  This is useful
when a package has its own method for making distributions.

@item @code{no-dist-gzip}
@cindex Option, no-dist-gzip
Do not hook @code{dist-gzip} to @code{dist}.
@trindex no-dist-gzip

@item @code{no-exeext}
@cindex Option, no-exeext
If your @file{Makefile.am} defines a rule for target @samp{foo}, it
will override a rule for a target named @samp{foo$(EXEEXT)}.  This is
necessary when @code{EXEEXT} is found to be empty.  However, by
default automake will generate an error for this use.  The
@code{no-exeext} option will disable this error.  This is intended for
use only where it is known in advance that the package will not be
ported to Windows, or any other operating system using extensions on
executables.

@item @code{no-installinfo}
@cindex Option, no-installinfo
The generated @file{Makefile.in} will not cause info pages to be built
or installed by default.  However, @code{info} and @code{install-info}
targets will still be available.  This option is disallowed at
@samp{GNU} strictness and above.
@trindex info
@trindex install-info

@item @code{no-installman}
@cindex Option, no-installman
The generated @file{Makefile.in} will not cause man pages to be
installed by default.  However, an @code{install-man} target will still
be available for optional installation.  This option is disallowed at
@samp{GNU} strictness and above.
@trindex install-man

@item @code{nostdinc}
@cindex Option, nostdinc
This option can be used to disable the standard @samp{-I} options which
are ordinarily automatically provided by Automake.

@item @code{no-texinfo.tex}
@cindex Option, no-texinfo
Don't require @file{texinfo.tex}, even if there are texinfo files in
this directory.

@item @code{readme-alpha}
@cindex Option, readme-alpha
If this release is an alpha release, and the file @file{README-alpha}
exists, then it will be added to the distribution.  If this option is
given, version numbers are expected to follow one of two forms.  The
first form is @samp{@var{MAJOR}.@var{MINOR}.@var{ALPHA}}, where each
element is a number; the final period and number should be left off for
non-alpha releases.  The second form is
@samp{@var{MAJOR}.@var{MINOR}@var{ALPHA}}, where @var{ALPHA} is a
letter; it should be omitted for non-alpha releases.

@item @code{std-options}
@cindex Options, std-options
@cindex make installcheck
Make the @code{installcheck} rule check that installed scripts and
programs support the @code{--help} and @code{--version} options.
This also provides a basic check that the program's
run-time dependencies are satisfied after installation.

@vindex AM_INSTALLCHECK_STD_OPTIONS_EXEMPT
In a few situations, programs (or scripts) have to be exempted from this
test.  For instance @command{false} (from GNU sh-utils) is never
successful, even for @code{--help} or @code{--version}.  You can list
such programs in the variable @code{AM_INSTALLCHECK_STD_OPTIONS_EXEMPT}.
Programs (not scripts) listed in this variable should be suffixed by
@code{$(EXEEXT)} for the sake of Win32 or OS/2.  For instance suppose we
build @code{false} as a program but @code{true.sh} as a script, and that
neither of them support @code{--help} or @code{--version}:

@example
AUTOMAKE_OPTIONS = std-options
bin_PROGRAMS = false ...
bin_SCRIPTS = true.sh ...
AM_INSTALLCHECK_STD_OPTIONS_EXEMPT = false$(EXEEXT) true.sh
@end example

@item @code{subdir-objects}
If this option is specified, then objects are placed into the
subdirectory of the build directory corresponding to the subdirectory of
the source file.  For instance if the source file is
@file{subdir/file.cxx}, then the output file would be
@file{subdir/file.o}.

@item @code{tar-v7}
@itemx @code{tar-ustar}
@itemx @code{tar-pax}
@cindex Option, tar-v7
@cindex Option, tar-ustar
@cindex Option, tar-pax
@cindex tar formats
@cindex v7 tar format
@cindex ustar format
@cindex pax format
@trindex tar-v7
@trindex tar-ustar
@trindex tar-pax

These three mutually exclusive options select the tar format to use
when generating tarballs with @code{make dist}.  (The tar file created
is then compressed according to the set of @code{no-dist-gzip},
@code{dist-bzip2} and @code{dist-tarZ} options in use.)

These options must be passed as argument to @code{AM_INIT_AUTOMAKE}
(@pxref{Macros}) because they can causes new configure check to be
performed.  Automake will complain if it sees such option in a
@code{AUTOMAKE_OPTIONS} variable.

@code{tar-v7} selects the old V7 tar format.  This is the historical
default.  This antiquated format is understood by all tar
implementations and supports filenames with up to 99 characters. When
given longer filenames some tar implementations will diagnose the
problem while other will generate broken tarballs or use non-portable
extensions.  Furthermore, the V7 format cannot store empty
directories.  When using this format, consider using the
@code{filename-length-max=99} option to catch filenames too long.

@code{tar-ustar} selects the ustar format defined by POSIX
1003.1-1988.  This format is believed to be old enough to be portable.
It fully supports empty directories.  It can stores filenames with up
to 256 characters, provided that the filename can be split at
directory separator in two parts, first of them being at most 155
bytes long. So, in most cases the maximum file name length will be
shorter than 256 characters.  However you may run against broken tar
implementations that incorrectly handle filenames longer than 99
characters (please report them to @email{bug-automake@@gnu.org} so we
can document this accurately).

@code{tar-pax} selects the new pax interchange format defined by POSIX
1003.1-2001.  It does not limit the length of filenames.  However,
this format is very young and should probably be restricted to
packages which target only very modern platforms.  There are moves to
change the pax format in an upward-compatible way, so this option may
refer to a more recent version in the future.

@xref{Formats, , Controlling the Archive Format, tar, GNU Tar}, for
further discussion about tar formats.

@code{configure} knows several ways to construct these formats.  It
will not abort if it cannot find a tool up to the task (so that the
package can still be built), but @code{make dist} will fail.

@item @var{version}
@cindex Option, version
A version number (e.g. @samp{0.30}) can be specified.  If Automake is not
newer than the version specified, creation of the @file{Makefile.in}
will be suppressed.

@item @code{-W@var{category}} or @code{--warnings=@var{category}}
@cindex Option, warnings
These options behave exactly like their command-line counterpart
(@pxref{Invoking Automake}).  This allows you to enable or disable some
warning categories on a per-file basis.  You can also setup some warnings
for your entire project; for instance try @code{AM_INIT_AUTOMAKE([-Wall])}
in your @file{configure.ac}.

@end table

Unrecognized options are diagnosed by @code{automake}.

If you want an option to apply to all the files in the tree, you can use
the @code{AM_INIT_AUTOMAKE} macro in @file{configure.ac}.
@xref{Macros}.


@node Miscellaneous
@chapter Miscellaneous Rules

There are a few rules and variables that didn't fit anywhere else.

@menu
* Tags::                        Interfacing to etags and mkid
* Suffixes::                    Handling new file extensions
* Multilibs::                   Support for multilibs.
@end menu


@node Tags
@section Interfacing to @code{etags}

@cindex TAGS support

Automake will generate rules to generate @file{TAGS} files for use with
GNU Emacs under some circumstances.

@trindex tags
If any C, C++ or Fortran 77 source code or headers are present, then
@code{tags} and @code{TAGS} rules will be generated for the directory.
All files listed using the @code{_SOURCES}, @code{_HEADERS}, and
@code{_LISP} primaries will be used to generate tags.  Note that
generated source files that are not distributed must be declared in
variables like @code{nodist_noinst_HEADERS} or
@code{nodist_@var{prog}_SOURCES} or they will be ignored.

At the topmost directory of a multi-directory package, a @code{tags}
rule will be output which, when run, will generate a @file{TAGS} file
that includes by reference all @file{TAGS} files from subdirectories.

The @code{tags} rule will also be generated if the variable
@code{ETAGS_ARGS} is defined.  This variable is intended for use in
directories which contain taggable source that @code{etags} does not
understand.  The user can use the @code{ETAGSFLAGS} to pass additional
flags to @code{etags}; @code{AM_ETAGSFLAGS} is also available for use
in @file{Makefile.am}.
@vindex ETAGS_ARGS
@vindex ETAGSFLAGS
@vindex AM_ETAGSFLAGS

Here is how Automake generates tags for its source, and for nodes in its
Texinfo file:

@example
ETAGS_ARGS = automake.in --lang=none \
 --regex='/^@@node[ \t]+\([^,]+\)/\1/' automake.texi
@end example

If you add filenames to @samp{ETAGS_ARGS}, you will probably also
want to set @samp{TAGS_DEPENDENCIES}.  The contents of this variable
are added directly to the dependencies for the @code{tags} rule.
@vindex TAGS_DEPENDENCIES

Automake also generates a @code{ctags} rule which can be used to
build @command{vi}-style @file{tags} files.  The variable @code{CTAGS}
is the name of the program to invoke (by default @samp{ctags});
@code{CTAGSFLAGS} can be used by the user to pass additional flags,
and @code{AM_CTAGSFLAGS} can be used by the @file{Makefile.am}.

Automake will also generate an @code{ID} rule which will run
@code{mkid} on the source.  This is only supported on a
directory-by-directory basis.
@trindex id

Automake also supports the @uref{http://www.gnu.org/software/global/,
GNU Global Tags program}.  The @code{GTAGS} rule runs Global Tags
automatically and puts the result in the top build directory.  The
variable @code{GTAGS_ARGS} holds arguments which are passed to
@code{gtags}.
@vindex GTAGS_ARGS


@node Suffixes
@section Handling new file extensions

@cindex Adding new SUFFIXES
@cindex SUFFIXES, adding
@vindex SUFFIXES

It is sometimes useful to introduce a new implicit rule to handle a file
type that Automake does not know about.

For instance, suppose you had a compiler which could compile @samp{.foo}
files to @samp{.o} files.  You would simply define an suffix rule for
your language:

@example
.foo.o:
        foocc -c -o $@@ $<
@end example

Then you could directly use a @samp{.foo} file in a @samp{_SOURCES}
variable and expect the correct results:

@example
bin_PROGRAMS = doit
doit_SOURCES = doit.foo
@end example

This was the simpler and more common case.  In other cases, you will
have to help Automake to figure which extensions you are defining your
suffix rule for.  This usually happens when your extensions does not
start with a dot.  Then, all you have to do is to put a list of new
suffixes in the @code{SUFFIXES} variable @strong{before} you define your
implicit rule.

For instance the following definition prevents Automake to misinterpret
@samp{.idlC.cpp:} as an attempt to transform @samp{.idlC} into
@samp{.cpp}.

@example
SUFFIXES = .idl C.cpp
.idlC.cpp:
        # whatever
@end example

As you may have noted, the @code{SUFFIXES} variable behaves like the
@code{.SUFFIXES} special target of @code{make}.  You should not touch
@code{.SUFFIXES} yourself, but use @code{SUFFIXES} instead and let
Automake generate the suffix list for @code{.SUFFIXES}.  Any given
@code{SUFFIXES} go at the start of the generated suffixes list, followed
by Automake generated suffixes not already in the list.

@node Multilibs
@section Support for Multilibs

Automake has support for an obscure feature called multilibs.  A
@dfn{multilib} is a library which is built for multiple different ABIs
at a single time; each time the library is built with a different target
flag combination.  This is only useful when the library is intended to
be cross-compiled, and it is almost exclusively used for compiler
support libraries.

The multilib support is still experimental.  Only use it if you are
familiar with multilibs and can debug problems you might encounter.


@node Include
@chapter Include

@cmindex include
@cindex Including Makefile fragment
@cindex Makefile fragment, including

Automake supports an @code{include} directive which can be used to
include other @file{Makefile} fragments when @code{automake} is run.
Note that these fragments are read and interpreted by @code{automake},
not by @code{make}.  As with conditionals, @code{make} has no idea that
@code{include} is in use.

There are two forms of @code{include}:

@table @code
@item include $(srcdir)/file
Include a fragment which is found relative to the current source
directory.

@item include $(top_srcdir)/file
Include a fragment which is found relative to the top source directory.
@end table

Note that if a fragment is included inside a conditional, then the
condition applies to the entire contents of that fragment.

Makefile fragments included this way are always distributed because
there are needed to rebuild @file{Makefile.in}.

@node Conditionals
@chapter Conditionals

@cindex Conditionals

Automake supports a simple type of conditionals.

@cvindex AM_CONDITIONAL
Before using a conditional, you must define it by using
@code{AM_CONDITIONAL} in the @code{configure.ac} file (@pxref{Macros}).

@defmac AM_CONDITIONAL (@var{conditional}, @var{condition})
The conditional name, @var{conditional}, should be a simple string
starting with a letter and containing only letters, digits, and
underscores.  It must be different from @samp{TRUE} and @samp{FALSE}
which are reserved by Automake.

The shell @var{condition} (suitable for use in a shell @code{if}
statement) is evaluated when @code{configure} is run.  Note that you
must arrange for @emph{every} @code{AM_CONDITIONAL} to be invoked every
time @code{configure} is run -- if @code{AM_CONDITIONAL} is run
conditionally (e.g., in a shell @code{if} statement), then the result
will confuse automake.
@end defmac

@cindex --enable-debug, example
@cindex Example conditional --enable-debug
@cindex Conditional example,  --enable-debug

Conditionals typically depend upon options which the user provides to
the @code{configure} script.  Here is an example of how to write a
conditional which is true if the user uses the @samp{--enable-debug}
option.

@example
AC_ARG_ENABLE(debug,
[  --enable-debug    Turn on debugging],
[case "$@{enableval@}" in
  yes) debug=true ;;
  no)  debug=false ;;
  *) AC_MSG_ERROR(bad value $@{enableval@} for --enable-debug) ;;
esac],[debug=false])
AM_CONDITIONAL(DEBUG, test x$debug = xtrue)
@end example

Here is an example of how to use that conditional in @file{Makefile.am}:

@cmindex if
@cmindex endif
@cmindex else

@example
if DEBUG
DBG = debug
else
DBG =
endif
noinst_PROGRAMS = $(DBG)
@end example

This trivial example could also be handled using EXTRA_PROGRAMS
(@pxref{Conditional Programs}).

You may only test a single variable in an @code{if} statement, possibly
negated using @samp{!}.  The @code{else} statement may be omitted.
Conditionals may be nested to any depth.  You may specify an argument to
@code{else} in which case it must be the negation of the condition used
for the current @code{if}.  Similarly you may specify the condition
which is closed by an @code{end}:

@example
if DEBUG
DBG = debug
else !DEBUG
DBG =
endif !DEBUG
@end example

@noindent
Unbalanced conditions are errors.

Note that conditionals in Automake are not the same as conditionals in
GNU Make.  Automake conditionals are checked at configure time by the
@file{configure} script, and affect the translation from
@file{Makefile.in} to @file{Makefile}.  They are based on options passed
to @file{configure} and on results that @file{configure} has discovered
about the host system.  GNU Make conditionals are checked at @code{make}
time, and are based on variables passed to the make program or defined
in the @file{Makefile}.

Automake conditionals will work with any make program.


@node Gnits
@chapter The effect of @code{--gnu} and @code{--gnits}

@cindex --gnu, required files
@cindex --gnu, complete description

The @samp{--gnu} option (or @samp{gnu} in the @samp{AUTOMAKE_OPTIONS}
variable) causes @code{automake} to check the following:

@itemize @bullet
@item
The files @file{INSTALL}, @file{NEWS}, @file{README}, @file{AUTHORS},
and @file{ChangeLog}, plus one of @file{COPYING.LIB}, @file{COPYING.LESSER}
or @file{COPYING}, are required at the topmost directory of the package.

@item
The options @samp{no-installman} and @samp{no-installinfo} are
prohibited.
@end itemize

Note that this option will be extended in the future to do even more
checking; it is advisable to be familiar with the precise requirements
of the GNU standards.  Also, @samp{--gnu} can require certain
non-standard GNU programs to exist for use by various maintainer-only
rules; for instance in the future @code{pathchk} might be required for
@samp{make dist}.

@cindex --gnits, complete description

The @samp{--gnits} option does everything that @samp{--gnu} does, and
checks the following as well:

@itemize @bullet
@item
@samp{make installcheck} will check to make sure that the @code{--help}
and @code{--version} really print a usage message and a version string,
respectively.  This is the @code{std-options} option (@pxref{Options}).

@item
@samp{make dist} will check to make sure the @file{NEWS} file has been
updated to the current version.

@item
@samp{VERSION} is checked to make sure its format complies with Gnits
standards.
@c FIXME xref when standards are finished

@item
@cindex README-alpha
If @samp{VERSION} indicates that this is an alpha release, and the file
@file{README-alpha} appears in the topmost directory of a package, then
it is included in the distribution.  This is done in @samp{--gnits}
mode, and no other, because this mode is the only one where version
number formats are constrained, and hence the only mode where Automake
can automatically determine whether @file{README-alpha} should be
included.

@item
The file @file{THANKS} is required.
@end itemize


@node Cygnus
@chapter The effect of @code{--cygnus}

@cindex Cygnus strictness

Some packages, notably GNU GCC and GNU gdb, have a build environment
originally written at Cygnus Support (subsequently renamed Cygnus
Solutions, and then later purchased by Red Hat).  Packages with this
ancestry are sometimes referred to as ``Cygnus'' trees.

A Cygnus tree has slightly different rules for how a @file{Makefile.in}
is to be constructed.  Passing @samp{--cygnus} to @code{automake} will
cause any generated @file{Makefile.in} to comply with Cygnus rules.

Here are the precise effects of @samp{--cygnus}:

@itemize @bullet
@item
Info files are always created in the build directory, and not in the
source directory.

@item
@file{texinfo.tex} is not required if a Texinfo source file is
specified.  The assumption is that the file will be supplied, but in a
place that Automake cannot find.  This assumption is an artifact of how
Cygnus packages are typically bundled.

@item
@samp{make dist} is not supported, and the rules for it are not
generated.  Cygnus-style trees use their own distribution mechanism.

@item
Certain tools will be searched for in the build tree as well as in the
user's @samp{PATH}.  These tools are @code{runtest}, @code{expect},
@code{makeinfo} and @code{texi2dvi}.

@item
@code{--foreign} is implied.

@item
The options @samp{no-installinfo} and @samp{no-dependencies} are
implied.

@item
The macros @samp{AM_MAINTAINER_MODE} and @samp{AM_CYGWIN32} are
required.

@item
The @code{check} target doesn't depend on @code{all}.
@end itemize

GNU maintainers are advised to use @samp{gnu} strictness in preference
to the special Cygnus mode.  Some day, perhaps, the differences between
Cygnus trees and GNU trees will disappear (for instance, as GCC is made
more standards compliant).  At that time the special Cygnus mode will be
removed.


@node Not Enough
@chapter When Automake Isn't Enough

In some situations, where Automake is not up to one task, one has to
resort to handwritten rules or even handwritten @file{Makefile}s.

@menu
* Extending::                   Adding new rules or overriding existing ones.
* Third-Party Makefiles::       Integrating Non-Automake @file{Makefile}s.
@end menu

@node Extending
@section Extending Automake Rules

With some minor exceptions (like @code{_PROGRAMS} variables being
rewritten to append @code{$(EXEEXT)}), the contents of a
@file{Makefile.am} is copied to @file{Makefile.in} verbatim.

@cindex copying semantics

These copying semantics means that many problems can be worked around
by simply adding some @code{make} variables and rules to
@file{Makefile.am}.  Automake will ignore these additions.

@cindex conflicting definitions
@cindex rules, conflicting
@cindex variables, conflicting
@cindex definitions, conflicts

Since a @file{Makefile.in} is built from data gathered from three
different places (@file{Makefile.am}, @file{configure.ac}, and
@command{automake} itself), it is possible to have conflicting
definitions of rules or variables.  When building @file{Makefile.in}
the following priorities are respected by @command{automake} to ensure
the user always have the last word.  User defined variables in
@file{Makefile.am} have priority over variables @code{AC_SUBST}ed from
@file{configure.ac}, and @code{AC_SUBST}ed variables have priority
over @command{automake}-defined variables.  As far rules are
concerned, a user-defined rule overrides any
@command{automake}-defined rule for the same target.

@cindex overriding rules
@cindex overriding semantics
@cindex rules, overriding

These overriding semantics make it possible to fine tune some default
settings of Automake, or replace some of its rules.  Overriding
Automake rules is often inadvisable, particularly in the topmost
directory of a package with subdirectories.  The @code{-Woverride}
option (@pxref{Invoking Automake}) comes handy to catch overridden
definitions.

Note that Automake does not make any difference between rules with
commands and rules that only specify dependencies.  So it is not
possible to append new dependencies to an @code{automake}-defined
target without redefining the entire rule.

@cindex -local targets
@cindex local targets

However, various useful targets have a @samp{-local} version you can
specify in your @file{Makefile.in}.  Automake will supplement the
standard target with these user-supplied targets.

@trindex  all
@trindex  all-local
@trindex  info
@trindex  info-local
@trindex  dvi
@trindex  dvi-local
@trindex  ps
@trindex  ps-local
@trindex  pdf
@trindex  pdf-local
@trindex  html
@trindex  html-local
@trindex  check
@trindex  check-local
@trindex  install
@trindex  install-data-local
@trindex  install-exec
@trindex  install-exec-local
@trindex  uninstall
@trindex  uninstall-local
@trindex  mostlyclean
@trindex  mostlyclean-local
@trindex  clean
@trindex  clean-local
@trindex  distclean
@trindex  distclean-local
@trindex  installdirs
@trindex  installdirs-local
@trindex  installcheck
@trindex  installcheck-local

The targets that support a local version are @code{all}, @code{info},
@code{dvi}, @code{ps}, @code{pdf}, @code{html}, @code{check},
@code{install-data}, @code{install-exec}, @code{uninstall},
@code{installdirs}, @code{installcheck} and the various @code{clean} targets
(@code{mostlyclean}, @code{clean}, @code{distclean}, and
@code{maintainer-clean}).  Note that there are no
@code{uninstall-exec-local} or @code{uninstall-data-local} targets; just
use @code{uninstall-local}.  It doesn't make sense to uninstall just
data or just executables.

For instance, here is one way to install a file in @file{/etc}:

@example
install-data-local:
        $(INSTALL_DATA) $(srcdir)/afile $(DESTDIR)/etc/afile
@end example

@cindex -hook targets
@cindex hook targets

Some rule also have a way to run another rule, called a @dfn{hook},
after their work is done.  The hook is named after the principal target,
with @samp{-hook} appended.  The targets allowing hooks are
@code{install-data}, @code{install-exec}, @code{uninstall}, @code{dist},
and @code{distcheck}.
@trindex install-data-hook
@trindex install-exec-hook
@trindex uninstall-hook
@trindex dist-hook

For instance, here is how to create a hard link to an installed program:

@example
install-exec-hook:
        ln $(DESTDIR)$(bindir)/program$(EXEEXT) \
           $(DESTDIR)$(bindir)/proglink$(EXEEXT)
@end example

Although cheaper and more portable than symbolic links, hard links
will not work everywhere (for instance OS/2 does not have
@command{ln}).  Ideally you should fall back to @code{cp -p} when
@code{ln} does not work.  An easy way, if symbolic links are
acceptable to you, is to add @code{AC_PROG_LN_S} to
@file{configure.ac} (@pxref{Particular Programs, , Particular Program
Checks, autoconf, The Autoconf Manual}) and use @code{$(LN_S)} in
@file{Makefile.am}.

@cindex versioned binaries, installing
@cindex installing versioned binaries
@cindex LN_S example
For instance, here is how you could install a versioned copy of a
program using @code{$(LN_S)}:

@example
install-exec-hook:
        cd $(DESTDIR)$(bindir) && \
          mv -f prog$(EXEEXT) prog-$(VERSION)$(EXEEXT) && \
          $(LN_S) prog-$(VERSION)$(EXEEXT) prog$(EXEEXT)
@end example

Note that we rename the program so that a new version will erase the
symbolic link, not the real binary.  Also we @code{cd} into the
destination directory in order to create relative links.

@c FIXME should include discussion of variables you can use in these
@c rules

@node Third-Party Makefiles
@section Third-Party @file{Makefile}s

@cindex Third-party packages, interfacing with
@cindex Interfacing with third-party packages

In most projects all @file{Makefile}s are generated by Automake.  In
some cases, however, projects need to embed subdirectories with
handwritten @file{Makefile}s.  For instance one subdirectory could be
a third-party project with its own build system, not using Automake.

It is possible to list arbitrary directories in @code{SUBDIRS} or
@code{DIST_SUBDIRS} provided each of these directories has a
@file{Makefile} that recognizes all the following recursive targets.

@cindex recursive targets and third-party @file{Makefile}s
When a user runs one of these targets, that target is run recursively
in all subdirectories.  This is why it is important that even
third-party @file{Makefile}s support them.

@table @code
@item all
Compile the entire package.  This is the default target in
Automake-generated @file{Makefile}s, but it does not need to be the
default in third-party @file{Makefile}s.

@item distdir
@trindex distdir
@vindex distdir
@vindex top_distdir
Copy files to distribute into @code{$(distdir)}, before a tarball is
constructed.  Of course this target is not required if the
@code{no-dist} option (@pxref{Options}) is used.

The variables @code{$(top_distdir)} and @code{$(distdir)}
(@pxref{Dist}) will be passed from the outer package to the subpackage
when the @code{distdir} target is invoked.  These two variables have
been adjusted for the directory which is being recursed into, so they
are ready to use.

@item install
@itemx install-data
@itemx install-exec
@itemx uninstall
Install or uninstall files (@pxref{Install}).

@item install-info
Install only the Texinfo documentation (@pxref{Texinfo}).

@item installdirs
Create install directories, but do not install any files.

@item check
@itemx installcheck
Check the package (@pxref{Tests}).

@item mostlyclean
@itemx clean
@itemx distclean
@itemx maintainer-clean
Cleaning rules (@pxref{Clean}).

@item dvi
@itemx pdf
@itemx ps
@itemx info
@itemx html
Build the documentation in various formats (@pxref{Texinfo}).

@item tags
@itemx ctags
Build @code{TAGS} and @code{CTAGS} (@pxref{Tags}).
@end table

If you have ever used Gettext in a project, this is a good example of
how third-party @file{Makefile}s can be used with Automake.  The
@file{Makefile}s @command{gettextize} puts in the @file{po/} and
@file{intl/} directories are handwritten @file{Makefile}s that
implement all these targets.  That way they can be added to
@code{SUBDIRS} in Automake packages.

Directories which are only listed in @code{DIST_SUBDIRS} but not in
@code{SUBDIRS} need only the @code{distclean},
@code{maintainer-clean}, and @code{distdir} rules (@pxref{Conditional
Subdirectories}).

Usually, many of these rules are irrelevant to the third-party
subproject, but they are required for the whole package to work.  It's
OK to have a rule that does nothing, so if you are integrating a
third-party project with no documentation or tag support, you could
simply augment its @file{Makefile} as follows:

@example
EMPTY_AUTOMAKE_TARGETS = dvi pdf ps info html tags ctags
.PHONY: $(EMPTY_AUTOMAKE_TARGETS)
$(EMPTY_AUTOMAKE_TARGETS):
@end example

Another aspect of integrating third-party build systems is whether
they support VPATH builds.  Obviously if the subpackage does not
support VPATH builds the whole package will not support VPATH builds.
This in turns means that @code{make distcheck} will not work, because
it relies on VPATH builds.  Some people can live without this
(actually, many Automake users have never heard of @code{make
distcheck}).  Other people may prefer to revamp the existing
@file{Makefile}s to support VPATH.  Doing so does not necessarily
require Automake, only Autoconf is needed (@pxref{Build Directories, ,
Build Directories, autoconf, The Autoconf Manual}).  The necessary
substitutions: @code{@@scrdir@@}, @code{@@top_srcdir@@}, and
@code{@@top_buildir@@} are defined by @file{configure} when it
processes a @file{Makefile} (@pxref{Preset Output Variables, , Preset
Output Variables, autoconf, The Autoconf Manual}), they are not
computed by the Makefile like the aforementioned @code{$(distdir)} and
@code{$(top_distdir)} variables..

It is sometimes inconvenient to modify a third-party @file{Makefile}
to introduce the above required targets.  For instance one may want to
keep the third-party sources untouched to ease upgrades to new
versions.

@cindex @file{GNUmakefile} including @file{Makefile}
Here are two other ideas.  If GNU make is assumed, one possibility is
to add to that subdirectory a @file{GNUmakefile} that defines the
required targets and include the third-party @file{Makefile}.  For
this to work in VPATH builds, @file{GNUmakefile} must lie in the build
directory; the easiest way to do this is to write a
@file{GNUmakefile.in} instead, and have it processed with
@code{AC_CONFIG_FILES} from the outer package.  For example if we
assume @file{Makefile} defines all targets except the documentation
targets, and that the @code{check} target is actually called
@code{test}, we could write @file{GNUmakefile} (or
@file{GNUmakefile.in}) like this:

@example
# First, include the real Makefile
include Makefile
# Then, define the other targets needed by Automake Makefiles.
.PHONY: dvi pdf ps info html check
dvi pdf ps info html:
check: test
@end example

@cindex Proxy @file{Makefile} for third-party packages
A similar idea that does not use @code{include} is to write a proxy
@file{Makefile} that dispatches rules to the real @file{Makefile},
either with @code{$(MAKE) -f Makefile.real $(AM_MAKEFLAGS) target} (if
it's OK to rename the original @file{Makefile}) or with @code{cd
subdir && $(MAKE) $(AM_MAKEFLAGS) target} (if it's OK to store the
subdirectory project one directory deeper).  The good news is that
this proxy @file{Makefile} can be generated with Automake.  All we
need are -local targets (@pxref{Extending}) that perform the dispatch.
Of course the other Automake features are available, so you could
decide to let Automake perform distribution or installation.  Here is
a possible @file{Makefile.am}:

@example
all-local:
        cd subdir && $(MAKE) $(AM_MAKEFLAGS) all
check-local:
        cd subdir && $(MAKE) $(AM_MAKEFLAGS) test
clean-local:
        cd subdir && $(MAKE) $(AM_MAKEFLAGS) clean

# Assuming the package knows how to install itself
install-data-local:
        cd subdir && $(MAKE) $(AM_MAKEFLAGS) install-data
install-exec-local:
        cd subdir && $(MAKE) $(AM_MAKEFLAGS) install-exec
uninstall-local:
        cd subdir && $(MAKE) $(AM_MAKEFLAGS) uninstall

# Distribute files from here.
EXTRA_DIST = subdir/Makefile subdir/program.c ...
@end example

Pushing this idea to the extreme, it is also possible to ignore the
subproject build system and build everything from this proxy
@file{Makefile.am}.  This might sounds very sensible if you need VPATH
builds but the subproject does not support them.

@node Distributing
@chapter Distributing @file{Makefile.in}s

Automake places no restrictions on the distribution of the resulting
@file{Makefile.in}s.  We still encourage software authors to
distribute their work under terms like those of the GPL, but doing so
is not required to use Automake.

Some of the files that can be automatically installed via the
@code{--add-missing} switch do fall under the GPL@.  However, these also
have a special exception allowing you to distribute them with your
package, regardless of the licensing you choose.


@node API versioning
@chapter Automake API versioning

New Automake releases usually include bug fixes and new features.
Unfortunately they may also introduce new bugs and incompatibilities.
This makes four reasons why a package may require a particular Automake
version.

Things get worse when maintaining a large tree of packages, each one
requiring a different version of Automake.  In the past, this meant that
any developer (and sometime users) had to install several versions of
Automake in different places, and switch @samp{$PATH} appropriately for
each package.

Starting with version 1.6, Automake installs versioned binaries.  This
means you can install several versions of Automake in the same
@samp{$prefix}, and can select an arbitrary Automake version by running
@samp{automake-1.6} or @samp{automake-1.7} without juggling with
@samp{$PATH}.  Furthermore, @file{Makefile}'s generated by Automake 1.6
will use @samp{automake-1.6} explicitly in their rebuild rules.

The number @samp{1.6} in @samp{automake-1.6} is Automake's API version,
not Automake's version.  If a bug fix release is made, for instance
Automake 1.6.1, the API version will remain 1.6.  This means that a
package which work with Automake 1.6 should also work with 1.6.1; after
all, this is what people expect from bug fix releases.

If your package relies on a feature or a bug fix introduced in
a release, you can pass this version as an option to Automake to ensure
older releases will not be used.  For instance, use this in your
@file{configure.ac}:

@example
  AM_INIT_AUTOMAKE(1.6.1)    dnl Require Automake 1.6.1 or better.
@end example
@noindent
or, in a particular @file{Makefile.am}:

@example
  AUTOMAKE_OPTIONS = 1.6.1   # Require Automake 1.6.1 or better.
@end example
@noindent
Automake will print an error message if its version is
older than the requested version.


@heading What is in the API

Automake's programming interface is not easy to define.  Basically it
should include at least all @strong{documented} variables and targets
that a @samp{Makefile.am} author can use, any behavior associated with
them (e.g. the places where @samp{-hook}'s are run), the command line
interface of @samp{automake} and @samp{aclocal}, @dots{}

@heading What is not in the API

Every undocumented variable, target, or command line option, is not part
of the API@.  You should avoid using them, as they could change from one
version to the other (even in bug fix releases, if this helps to fix a
bug).

If it turns out you need to use such a undocumented feature, contact
@email{automake@@gnu.org} and try to get it documented and exercised by
the test-suite.

@node Upgrading
@chapter Upgrading a Package to a Newer Automake Version

Automake maintains three kind of files in a package.

@itemize
@item @file{aclocal.m4}
@item @file{Makefile.in}s
@item auxiliary tools like @file{install-sh} or @file{py-compile}
@end itemize

@file{aclocal.m4} is generated by @command{aclocal} and contains some
Automake-supplied M4 macros.  Auxiliary tools are installed by
@samp{automake --add-missing} when needed.  @file{Makefile.in}s are
built from @file{Makefile.am} by @command{automake}, and rely on the
definitions of the M4 macros put in @file{aclocal.m4} as well as the
behavior of the auxiliary tools installed.

Because all these files are closely related, it is important to
regenerate all of them when upgrading to a newer Automake release.
The usual way to do that is

@example
aclocal # with any option needed (such a -I m4)
autoconf
automake --add-missing --force-missing
@end example

@noindent
or more conveniently:

@example
autoreconf -vfi
@end example

The use of @code{--force-missing} ensures that auxiliary tools will be
overridden by new versions (@pxref{Invoking Automake}).

It is important to regenerate all these files each time Automake is
upgraded, even between bug fixes releases.  For instance it is not
unusual for a bug fix to involve changes to both the rules generated
in @file{Makefile.in} and the supporting M4 macros copied to
@file{aclocal.m4}.

Presently @command{automake} is able to diagnose situations where
@file{aclocal.m4} has been generated with another version of
@command{aclocal}.  However it never checks whether auxiliary scripts
are up-to-date.  In other words, @command{automake} will tell you when
@command{aclocal} needs to be rerun, but it will never diagnose a
missing @code{--force-missing}.

Before upgrading to a new major release, it is a good idea to read the
file @file{NEWS}.  This file lists all changes between releases: new
features, obsolete constructs, known incompatibilities, and
workarounds.

@node FAQ
@chapter Frequently Asked Questions about Automake

This chapter covers some questions that often come up on the mailing
lists.

@menu
* CVS::                         CVS and generated files
* maintainer-mode::             missing and AM_MAINTAINER_MODE
* wildcards::                   Why doesn't Automake support wildcards?
* distcleancheck::              Files left in build directory after distclean
* renamed objects::             Why are object files sometimes renamed?
* Multiple Outputs::            Writing rules for tools with many output files
@end menu

@node CVS
@section CVS and generated files

@subsection Background: distributed generated files
@cindex generated files, distributed
@cindex rebuild rules

Packages made with Autoconf and Automake ship with some generated
files like @file{configure} or @file{Makefile.in}.  These files were
generated on the developer's host and are distributed so that
end-users do not have to install the maintainer tools required to
rebuild them.  Other generated files like Lex scanners, Yacc parsers,
or Info documentation, are usually distributed on similar grounds.

Automake outputs rules in @file{Makefile}s to rebuild these files.  For
instance @command{make} will run @command{autoconf} to rebuild
@file{configure} whenever @file{configure.ac} is changed.  This makes
development safer by ensuring a @file{configure} is never out-of-date
with respect to @file{configure.ac}.

As generated files shipped in packages are up-to-date, and because
@command{tar} preserves times-tamps, these rebuild rules are not
triggered when a user unpacks and builds a package.

@subsection Background: CVS and timestamps
@cindex timestamps and CVS
@cindex CVS and timestamps

Unless you use CVS keywords (in which case files must be updated at
commit time), CVS preserves timestamp during @code{cvs commit} and
@code{cvs import -d} operations.

When you check out a file using @code{cvs checkout} its timestamp is
set to that of the revision which is being checked out.

However, during @command{cvs update}, files will have the date of the
update, not the original timestamp of this revision.  This is meant to
make sure that @command{make} notices sources files have been updated.

This times tamp shift is troublesome when both sources and generated
files are kept under CVS.  Because CVS processes files in alphabetical
order, @file{configure.ac} will appear older than @file{configure}
after a @command{cvs update} that updates both files, even if
@file{configure} was newer than @file{configure.ac} when it was
checked in.  Calling @code{make} will then trigger a spurious rebuild
of @file{configure}.

@subsection Living with CVS in Autoconfiscated projects
@cindex CVS and generated files
@cindex generated files and CVS

There are basically two clans amongst maintainers: those who keep all
distributed files under CVS, including generated files, and those who
keep generated files @emph{out} of CVS.

@subsubheading All files in CVS

@itemize @bullet
@item
The CVS repository contains all distributed files so you know exactly
what is distributed, and you can checkout any prior version entirely.

@item
Maintainers can see how generated files evolve (for instance you can
see what happens to your @file{Makefile.in}s when you upgrade Automake
and make sure they look OK).

@item
Users do not need the autotools to build a checkout of the project, it
works just like a released tarball.

@item
If users use @command{cvs update} to update their copy, instead of
@command{cvs checkout} to fetch a fresh one, timestamps will be
inaccurate.  Some rebuild rules will be triggered and attempt to
run developer tools such as @command{autoconf} or @command{automake}.

Actually, calls to such tools are all wrapped into a call to the
@command{missing} script discussed later (@pxref{maintainer-mode}).
@command{missing} will take care of fixing the timestamps when these
tools are not installed, so that the build can continue.

@item
In distributed development, developers are likely to have different
version of the maintainer tools installed.  In this case rebuilds
triggered by timestamp lossage will lead to spurious changes
to generated files.  There are several solutions to this:

@itemize
@item
All developers should use the same versions, so that the rebuilt files
are identical to files in CVS.  (This starts to be difficult when each
project you work on uses different versions.)
@item
Or people use a script to fix the timestamp after a checkout (the GCC
folks have such a script).
@item
Or @file{configure.ac} uses @code{AM_MAINTAINER_MODE}, which will
disable all these rebuild rules by default.  This is further discussed
in @ref{maintainer-mode}.
@end itemize

@item
Although we focused on spurious rebuilds, the converse can also
happen.  CVS's timestamp handling can also let you think an
out-of-date file is up-to-date.

For instance, suppose a developer has modified @file{Makefile.am} and
rebuilt @file{Makefile.in}, and then decide to do a last-minute change
to @file{Makefile.am} right before checking in both files (without
rebuilding @file{Makefile.in} to account for the change).

This last change to @file{Makefile.am} make the copy of
@file{Makefile.in} out-of-date.  Since CVS processes files
alphabetically, when another developer @code{cvs update} his or her
tree, @file{Makefile.in} will happen to be newer than
@file{Makefile.am}.  This other developer will not see
@file{Makefile.in} is out-of-date.

@end itemize

@subsubheading Generated files out of CVS

One way to get CVS and @code{make} working peacefully is to never
store generated files in CVS, i.e., do not CVS-control files which
are @code{Makefile} targets (also called @emph{derived} files).

This way developers are not annoyed by changes to generated files.  It
does not matter if they all have different versions (assuming they are
compatible, of course).  And finally, timestamps are not lost, changes
to sources files can't be missed as in the
@file{Makefile.am}/@file{Makefile.in} example discussed earlier.

The drawback is that the CVS repository is not an exact copy of what
is distributed and that users now need to install various development
tools (maybe even specific versions) before they can build a checkout.
But, after all, CVS's job is versioning, not distribution.

Allowing developers to use different versions of their tools can also
hide bugs during distributed development.  Indeed, developers will be
using (hence testing) their own generated files, instead of the
generated files that will be released actually.  The developer who
prepares the tarball might be using a version of the tool that
produces bogus output (for instance a non-portable C file), something
other developers could have noticed if they weren't using their own
versions of this tool.

@subsection Third-party files
@cindex CVS and third-party files
@cindex third-party files and CVS

Another class of files not discussed here (because they do not cause
timestamp issues) are files which are shipped with a package, but
maintained elsewhere.  For instance tools like @command{gettextize}
and @command{autopoint} (from Gettext) or @command{libtoolize} (from
Libtool), will install or update files in your package.

These files, whether they are kept under CVS or not, raise similar
concerns about version mismatch between developers' tools.  The
Gettext manual has a section about this, see @ref{CVS Issues, CVS
Issues, Integrating with CVS, gettext, GNU gettext tools}.

@node maintainer-mode
@section @command{missing} and @code{AM_MAINTAINER_MODE}

@subsection @command{missing}
@cindex missing, purpose

The @command{missing} script is a wrapper around several maintainer
tools, designed to warn users if a maintainer tool is required but
missing.  Typical maintainer tools are @command{autoconf},
@command{automake}, @command{bison}, etc.  Because file generated by
these tools are shipped with the other sources of a package, these
tools shouldn't be required during a user build and they are not
checked for in @file{configure}.

However, if for some reason a rebuild rule is triggered and involves a
missing tool, @command{missing} will notice it and warn the user.
Besides the warning, when a tool is missing, @command{missing} will
attempt to fix timestamps in a way which allow the build to continue.
For instance @command{missing} will touch @file{configure} if
@command{autoconf} is not installed.  When all distributed files are
kept under CVS, this feature of @command{missing} allows user
@emph{with no maintainer tools} to build a package off CVS, bypassing
any timestamp inconsistency implied by @code{cvs update}.

If the required tool is installed, @command{missing} will run it and
won't attempt to continue after failures.  This is correct during
development: developers love fixing failures.  However, users with
wrong versions of maintainer tools may get an error when the rebuild
rule is spuriously triggered, halting the build.  This failure to let
the build continue is one of the arguments of the
@code{AM_MAINTAINER_MODE} advocates.

@subsection @code{AM_MAINTAINER_MODE}
@cindex AM_MAINTAINER_MODE, purpose
@cvindex AM_MAINTAINER_MODE

@code{AM_MAINTAINER_MODE} disables the so called "rebuild rules" by
default.  If you have @code{AM_MAINTAINER_MODE} in
@file{configure.ac}, and run @code{./configure && make}, then
@command{make} will *never* attempt to rebuilt @file{configure},
@file{Makefile.in}s, Lex or Yacc outputs, etc.  I.e., this disables
build rules for files which are usually distributed and that users
should normally not have to update.

If you run @code{./configure --enable-maintainer-mode}, then these
rebuild rules will be active.

People use @code{AM_MAINTAINER_MODE} either because they do want their
users (or themselves) annoyed by timestamps lossage (@pxref{CVS}), or
because they simply can't stand the rebuild rules and prefer running
maintainer tools explicitly.

@code{AM_MAINTAINER_MODE} also allows you to disable some custom build
rules conditionally.  Some developers use this feature to disable
rules that need exotic tools that users may not have available.

Several years ago Fran@,{c}ois Pinard pointed out several arguments
against @code{AM_MAINTAINER_MODE}.  Most of them relate to insecurity.
By removing dependencies you get non-dependable builds: change to
sources files can have no effect on generated files and this can be
very confusing when unnoticed.  He adds that security shouldn't be
reserved to maintainers (what @code{--enable-maintainer-mode}
suggests), on the contrary.  If one user has to modify a
@file{Makefile.am}, then either @file{Makefile.in} should be updated
or a warning should be output (this is what Automake uses
@code{missing} for) but the last thing you want is that nothing
happens and the user doesn't notice it (this is what happens when
rebuild rules are disabled by @code{AM_MAINTAINER_MODE}).

Jim Meyering, the inventor of the @code{AM_MAINTAINER_MODE} macro was
swayed by Fran@,{c}ois's arguments, and got rid of
@code{AM_MAINTAINER_MODE} in all of his packages.

Still many people continue to use @code{AM_MAINTAINER_MODE}, because
it helps them working on projects where all files are kept under CVS,
and because @command{missing} isn't enough if you have the wrong
version of the tools.


@node wildcards
@section Why doesn't Automake support wildcards?
@cindex wildcards

Developers are lazy.  They often would like to use wildcards in
@file{Makefile.am}s, so they don't need to remember they have to
update @file{Makefile.am}s every time they add, delete, or rename a
file.

There are several objections to this:
@itemize
@item
When using CVS (or similar) developers need to remember they have to
run @code{cvs add} or @code{cvs rm} anyway.  Updating
@file{Makefile.am} accordingly quickly becomes a reflex.

Conversely, if your application doesn't compile
because you forgot to add a file in @file{Makefile.am}, it will help
you remember to @code{cvs add} it.

@item
Using wildcards makes easy to distribute files by mistake.  For
instance some code a developer is experimenting with (a test case,
say) but which should not be part of the distribution.

@item
Using wildcards it's easy to omit some files by mistake.  For
instance one developer creates a new file, uses it at many places,
but forget to commit it.  Another developer then checkout the
incomplete project and is able to run `make dist' successfully,
even though a file is missing.

@item
Listing files, you control *exactly* what you distribute.
If some file that should be distributed is missing from your
tree, @code{make dist} will complain.  Besides, you don't distribute
more than what you listed.

@item
Finally it's really hard to @file{forget} adding a file to
@file{Makefile.am}, because if you don't add it, it doesn't get
compiled nor installed, so you can't even test it.
@end itemize

Still, these are philosophical objections, and as such you may disagree,
or find enough value in wildcards to dismiss all of them.  Before you
start writing a patch against Automake to teach it about wildcards,
let's see the main technical issue: portability.

Although @code{$(wildcard ...)} works with GNU @command{make}, it is
not portable to other @command{make} implementations.

The only way Automake could support @command{$(wildcard ...)} is by
expending @command{$(wildcard ...)} when @command{automake} is run.
Resulting @file{Makefile.in}s would be portable since they would
list all files and not use @code{$(wildcard ...)}.  However that
means developers need to remember they must run @code{automake} each
time they add, delete, or rename files.

Compared to editing @file{Makefile.am}, this is really little win.  Sure,
it's easier and faster to type @code{automake; make} than to type
@code{emacs Makefile.am; make}.  But nobody bothered enough to write a
patch add support for this syntax.  Some people use scripts to
generated file lists in @file{Makefile.am} or in separate
@file{Makefile} fragments.

Even if you don't care about portability, and are tempted to use
@code{$(wildcard ...)} anyway because you target only GNU Make, you
should know there are many places where Automake need to know exactly
which files should be processed.  As Automake doesn't know how to
expand @code{$(wildcard ...)}, you cannot use it in these places.
@code{$(wildcard ...)} is a black box comparable to @code{AC_SUBST}ed
variables as far Automake is concerned.

You can get warnings about @code{$(wildcard ...}) constructs using the
@code{-Wportability} flag.

@node distcleancheck
@section Files left in build directory after distclean
@cindex distclean, diagnostic
@cindex dependencies and distributed files
@trindex distclean
@trindex distcleancheck

This is a diagnostic you might encounter while running @code{make
distcheck}.

As explained in @ref{Dist}, @code{make distcheck} attempts to build
and check your package for errors like this one.

@code{make distcheck} will perform a @code{VPATH} build of your
package, and then call @code{make distclean}.  Files left in the build
directory after @code{make distclean} has run are listed after this
error.

This diagnostic really covers two kinds of errors:

@itemize @bullet
@item
files that are forgotten by distclean;
@item
distributed files that are erroneously rebuilt.
@end itemize

The former left-over files are not distributed, so the fix is to mark
them for cleaning (@pxref{Clean}), this is obvious and doesn't deserve
more explanations.

The latter bug is not always easy to understand and fix, so let's
proceed with an example.  Suppose our package contains a program for
which we want to build a man page using @command{help2man}.  GNU
@command{help2man} produces simple manual pages from the @code{--help}
and @code{--version} output of other commands (@pxref{Top, , Overview,
help2man, The Help2man Manual}).  Because we don't to force want our
users to install @command{help2man}, we decide to distribute the
generated man page using the following setup.

@example
# This Makefile.am is bogus.
bin_PROGRAMS = foo
foo_SOURCES = foo.c
dist_man_MANS = foo.1

foo.1: foo$(EXEEXT)
	help2man --output=foo.1 ./foo$(EXEEXT)
@end example

This will effectively distribute the man page.  However,
@code{make distcheck} will fail with:

@example
ERROR: files left in build directory after distclean:
./foo.1
@end example

Why was @file{foo.1} rebuilt?  Because although distributed,
@file{foo.1} depends on a non-distributed built file:
@file{foo$(EXEEXT)}.  @file{foo$(EXEEXT)} is built by the user, so it
will always appear to be newer than the distributed @file{foo.1}.

@code{make distcheck} caught an inconsistency in our package.  Our
intent was to distribute @file{foo.1} so users do not need installing
@command{help2man}, however since this our rule causes this file to be
always rebuilt, users @emph{do} need @command{help2man}.  Either we
should ensure that @file{foo.1} is not rebuilt by users, or there is
no point in distributing @file{foo.1}.

More generally, the rule is that distributed files should never depend
on non-distributed built files.  If you distribute something
generated, distribute its sources.

One way to fix the above example, while still distributing
@file{foo.1} is to not depend on @file{foo$(EXEEXT)}.  For instance,
assuming @command{foo --version} and @command{foo --help} do not
change unless @file{foo.c} or @file{configure.ac} change, we could
write the following @file{Makefile.am}:

@example
bin_PROGRAMS = foo
foo_SOURCES = foo.c
dist_man_MANS = foo.1

foo.1: foo.c $(top_srcdir)/configure.ac
        $(MAKE) $(AM_MAKEFLAGS) foo$(EXEEXT)
	help2man --output=foo.1 ./foo$(EXEEXT)
@end example

This way, @file{foo.1} will not get rebuilt every time
@file{foo$(EXEEXT)} changes.  The @command{make} call makes sure
@file{foo$(EXEEXT)} is up-to-date before @command{help2man}.  Another
way to ensure this would be to use separate directories for binaries
and man pages, and set @code{SUBDIRS} so that binaries are built
before man pages.

We could also decide not to distribute @file{foo.1}.  In
this case it's fine to have @file{foo.1} dependent upon
@file{foo$(EXEEXT)}, since both will have to be rebuilt.
However it would be impossible to build the package in a
cross-compilation, because building @file{foo.1} involves
an @emph{execution} of @file{foo$(EXEEXT)}.

Another context where such errors are common is when distributed files
are built by tools which are built by the package.  The pattern is similar:

@example
distributed-file: built-tools distributed-sources
        build-command
@end example

@noindent
should be changed to

@example
distributed-file: distributed-sources
        $(MAKE) $(AM_MAKEFLAGS) built-tools
        build-command
@end example

@noindent
or you could choose not to distribute @file{distributed-file}, if
cross-compilation does not matter.

The points made through these examples are worth a summary:

@cartouche
@itemize
@item
Distributed files should never depend upon non-distributed built
files.
@item
Distributed files should be distributed will all their dependencies.
@item
If a file is @emph{intended} be rebuilt by users, there is no point in
distributing it.
@end itemize
@end cartouche

@vrindex distcleancheck_listfiles
For desperate cases, it's always possible to disable this check by
setting @code{distcleancheck_listfiles} as documented in @ref{Dist}.
Make sure you do understand the reason why @code{make distcheck}
complains before you do this.  @code{distcleancheck_listfiles} is a
way to @emph{hide} errors, not to fix them.  You can always do better.

@node renamed objects
@section Why are object files sometimes renamed?

This happens when per-target compilation flags are used.  Object
files need to be renamed just in case they would clash with object
files compiled from the same sources, but with different flags.
Consider the following example.

@example
bin_PROGRAMS = true false
true_SOURCES = generic.c
true_CPPFLAGS = -DEXIT_CODE=0
false_SOURCES = generic.c
false_CPPFLAGS = -DEXIT_CODE=1
@end example
@noindent
Obviously the two programs are built from the same source, but it
would be bad if they shared the same object, because @file{generic.o}
cannot be built with both @code{-DEXIT_CODE=0} *and*
@code{-DEXIT_CODE=1}.  Therefore @command{automake} outputs rules to
build two different objects: @file{true-generic.o} and
@file{false-generic.o}.

@command{automake} doesn't actually look whether sources files are
shared to decide if it must rename objects.  It will just rename all
objects of a target as soon as it sees per-target compilation flags
are used.

It's OK to share object files when per-target compilation flags are not
used.  For instance @file{true} and @file{false} will both use
@file{version.o} in the following example.

@example
AM_CPPFLAGS = -DVERSION=1.0
bin_PROGRAMS = true false
true_SOURCES = true.c version.c
false_SOURCES = false.c version.c
@end example

Note that the renaming of objects is also affected by the
@code{_SHORTNAME} variable (@pxref{Program and Library Variables}).


@node Multiple Outputs
@section Handling Tools that Produce Many Outputs
@cindex multiple outputs, rules with
@cindex many outputs, rules with
@cindex rules with multiple outputs

This section describes a @command{make} idiom that can be used when a
tool produces multiple output files.  It is not specific to Automake
and can be used in ordinary @file{Makefile}s.

Suppose we have a program called @command{foo} that will read one file
called @file{data.foo} and produce two files named @file{data.c} and
@file{data.h}.  We want to write a @file{Makefile} rule that captures
this one-to-two dependency.

The naive rule is incorrect:

@example
# This is incorrect.
data.c data.h: data.foo
        foo data.foo
@end example

@noindent
What the above rule really says is that @file{data.c} and
@file{data.h} each depend on @file{data.foo}, and can each be built by
running @code{foo data.foo}.  In other words it is equivalent to:

@example
# We do not want this.
data.c: data.foo
        foo data.foo
data.h: data.foo
        foo data.foo
@end example

@noindent
which means that @command{foo} can be run twice.  Usually it will not
be run twice, because @command{make} implementations are smart enough
to check for the existence of the second file after the first one has
been built; they will therefore detect that it already exists.
However there are a few situations where it can run twice anyway:

@itemize
@item
The most worrying case is when running a parallel @command{make}.  If
@file{data.c} and @file{data.h} are built in parallel, two @code{foo
data.foo} commands will run concurrently.  This is harmful.
@item
Another case is when the dependency (here @code{data.foo}) is
(or depends upon) a phony target.
@end itemize

A solution that works with parallel @command{make} but not with
phony dependencies is the following:

@example
data.c data.h: data.foo
        foo data.foo
data.h: data.c
@end example

@noindent
The above rules are equivalent to

@example
data.c: data.foo
        foo data.foo
data.h: data.foo data.c
        foo data.foo
@end example
@noindent
therefore a parallel @command{make} will have to serialize the builds
of @file{data.c} and @file{data.h}, and will detect that the second is
no longer needed once the first is over.

Using this pattern is probably enough for most cases.  However it does
not scale easily to more output files (in this scheme all output files
must be totally ordered by the dependency relation), so we will
explore a more complicated solution.

Another idea is to write the following:

@example
# There is still a problem with this one.
data.c: data.foo
        foo data.foo
data.h: data.c
@end example

@noindent
The idea is that @code{foo data.foo} is run only when @file{data.c}
needs to be updated, but we further state that @file{data.h} depends
upon @file{data.c}.  That way, if @file{data.h} is required and
@file{data.foo} is out of date, the dependency on @file{data.c} will
trigger the build.

This is almost perfect, but suppose we have built @file{data.h} and
@file{data.c}, and then we erase @file{data.h}.  Then, running
@code{make data.h} will not rebuild @file{data.h}.  The above rules
just state that @file{data.c} must be up-to-date with respect to
@file{data.foo}, and this is already the case.

What we need is a rule that forces a rebuild when @file{data.h} is
missing.  Here it is:

@example
data.c: data.foo
        foo data.foo
data.h: data.c
        @@if test -f $@@; then :; else \
          rm -f data.c; \
          $(MAKE) $(AM_MAKEFLAGS) data.c; \
        fi
@end example

The above scales easily to more outputs and more inputs.  One of the
output is picked up to serve as a witness of the run of the command,
it depends upon all inputs, and all other outputs depend upon it.  For
instance if @command{foo} should additionally read @file{data.bar} and
also produce @file{data.w} and @file{data.x}, we would write:

@example
data.c: data.foo data.bar
        foo data.foo data.bar
data.h data.w data.x: data.c
        @@if test -f $@@; then :; else \
          rm -f data.c; \
          $(MAKE) $(AM_MAKEFLAGS) data.c; \
        fi
@end example

There is still a minor problem with this setup.  @command{foo} outputs
four files, but we do not know in which order these files are created.
Suppose that @file{data.h} is created before @file{data.c}.  Then we
have a weird situation.  The next time @command{make} is run,
@file{data.h} will appear older than @file{data.c}, the second rule
will be triggered, a shell will be started to execute the
@code{if...fi} command, but actually it will just execute the
@code{then} branch, that is: nothing.  In other words, because the
witness we selected is not the first file created by @command{foo},
@command{make} will start a shell to do nothing each time it is run.

A simple riposte is to fix the timestamps when this happens.

@example
data.c: data.foo data.bar
        foo data.foo data.bar
data.h data.w data.x: data.c
        @@if test -f $@@; then \
          touch $@@; \
        else \
          rm -f data.c; \
          $(MAKE) $(AM_MAKEFLAGS) data.c; \
        fi
@end example

Another solution, not incompatible with the previous one, is to use a
different and dedicated file as witness, rather than using any of
@command{foo}'s outputs.

@example
data.stamp: data.foo data.bar
        @@rm -f data.tmp
        @@touch data.tmp
        foo data.foo data.bar
        @@mv -f data.tmp $@@
data.c data.h data.w data.x: data.stamp
        @@if test -f $@@; then \
          touch $@@; \
        else \
          rm -f data.stamp; \
          $(MAKE) $(AM_MAKEFLAGS) data.stamp; \
        fi
@end example

@file{data.tmp} is created before @command{foo} is run, so it has a
timestamp older than output files output by @command{foo}.  It is then
renamed to @file{data.stamp} after @command{foo} has run, because we
do not want to update @file{data.stamp} if @command{foo} fails.

Using a dedicated witness like this is very handy when the list of
output files is not known beforehand.  As an illustration, consider
the following rules to compile many @file{*.el} files into
@file{*.elc} files in a single command.  It does not matter how
@code{ELFILES} is defined (as long as it is not empty: empty targets
are not accepted by POSIX).

@example
ELFILES = one.el two.el three.el @dots{}
ELCFILES = $(ELFILES:=c)

elc-stamp: $(ELFILES)
        @@rm -f elc-temp
        @@touch elc-temp
        $(elisp_comp) $(ELFILES)
        @@mv -f elc-temp $@@

$(ELCFILES): elc-stamp
        @@if test -f $@@; then \
          touch $@@; \
        else \
          rm -f elc-stamp; \
          $(MAKE) $(AM_MAKEFLAGS) elc-stamp; \
        fi
@end example

For completeness it should be noted that GNU @command{make} is able to
express rules with multiple output files using pattern rules
(@pxref{Pattern Examples, , Pattern Rule Examples, make, The GNU Make
Manual}).  We do not discuss pattern rules here because they are not
portable, but they can be convenient in packages that assume GNU
@command{make}.

@c ========================================================== Appendices

@page
@node Copying This Manual
@appendix Copying This Manual

@menu
* GNU Free Documentation License::  License for copying this manual
@end menu

@include fdl.texi

@page
@node Indices
@appendix Indices

@menu
* Macro and Variable Index::    Index of Autoconf macros and Automake variables
* General Index::               General index
@end menu

@node Macro and Variable Index
@appendixsec Macro and Variable Index

@printindex vr

@node General Index
@appendixsec General Index

@printindex cp


@page
@contents
@bye

@c  LocalWords:  texinfo setfilename settitle setchapternewpage texi direntry
@c  LocalWords:  dircategory in's aclocal ifinfo titlepage Tromey vskip pt sp
@c  LocalWords:  filll defcodeindex ov cv op tr syncodeindex fn cp vr ifnottex
@c  LocalWords:  dir Automake's ac Dist Gnits gnits cygnus dfn Autoconf's pxref
@c  LocalWords:  cindex Autoconf autoconf perl samp cvs dist trindex SUBST foo
@c  LocalWords:  xs emph FIXME ref vindex pkglibdir pkgincludedir pkgdatadir mt
@c  LocalWords:  pkg libdir cvindex cpio bindir sbindir rmt pax sbin zar zardir
@c  LocalWords:  HTML htmldir html noinst TEXINFOS nodist nobase strudel CFLAGS
@c  LocalWords:  libmumble CC YFLAGS ansi knr itemx de fication config url comp
@c  LocalWords:  depcomp elisp sh mdate mkinstalldirs mkdir py tex dvi ps pdf
@c  LocalWords:  ylwrap zardoz INIT gettext acinclude mv FUNCS LIBOBJS LDADD fr
@c  LocalWords:  uref featureful dnl src LINGUAS es ko nl pl sl sv PROG ISC doc
@c  LocalWords:  POSIX STDC fcntl FUNC ALLOCA blksize struct stat intl po chmod
@c  LocalWords:  ChangeLog SUBDIRS gettextize gpl testdata getopt INTLLIBS cpp
@c  LocalWords:  localedir datadir DLOCALEDIR DEXIT CPPFLAGS autoreconf opindex
@c  LocalWords:  AUX var symlink deps Wno Wnone package's aclocal's distclean
@c  LocalWords:  ltmain xref LIBSOURCE LIBSOURCES LIBOBJ MEMCMP vs RANLIB CXX
@c  LocalWords:  LDFLAGS LIBTOOL libtool XTRA LIBS gettext's acdir APIVERSION
@c  LocalWords:  dirlist noindent usr MULTILIB multilib Multilibs TIOCGWINSZ sc
@c  LocalWords:  GWINSZ termios SRCDIR tarball bzip LISPDIR lispdir XEmacs CCAS
@c  LocalWords:  emacsen MicroEmacs CCASFLAGS UX GCJ gcj GCJFLAGS posix DMALLOC
@c  LocalWords:  dmalloc ldmalloc REGEX regex rx DEPDIR DEP DEFUN aclocaldir fi
@c  LocalWords:  mymacro myothermacro AMFLAGS autopoint autogen libtoolize yum
@c  LocalWords:  autoheader README MAKEFLAGS subdir Inetutils sync COND endif
@c  LocalWords:  Miller's installable includedir inc pkgdata EXEEXT libexec bsd
@c  LocalWords:  pkglib libexecdir prog libcpio cpio's dlopen dlpreopen linux
@c  LocalWords:  subsubsection OBJEXT esac lib LTLIBRARIES liblob LIBADD AR ar
@c  LocalWords:  ARFLAGS cru ing maude libgettext lo LTLIBOBJS rpath SGI PRE yy
@c  LocalWords:  libmaude CCLD CXXFLAGS FFLAGS LFLAGS OBJCFLAGS RFLAGS DEFS cc
@c  LocalWords:  SHORTNAME vtable srcdir nostdinc basename yxx cxx ll lxx gdb
@c  LocalWords:  lexers yymaxdepth maxdepth yyparse yylex yyerror yylval lval
@c  LocalWords:  yychar yydebug yypact yyr yydef def yychk chk yypgo pgo yyact
@c  LocalWords:  yyexca exca yyerrflag errflag yynerrs nerrs yyps yypv pv yys
@c  LocalWords:  yystate yytmp tmp yyv yyval val yylloc lloc yyreds yytoks toks
@c  LocalWords:  yylhs yylen yydefred yydgoto yysindex yyrindex yygindex yyname
@c  LocalWords:  yytable yycheck yyrule byacc CXXCOMPILE CXXLINK FLINK cfortran
@c  LocalWords:  Catalogue preprocessable FLIBS libfoo baz JAVACFLAGS java exe
@c  LocalWords:  SunOS fying basenames exeext uninstalled oldinclude kr FSF's
@c  LocalWords:  pkginclude oldincludedir sysconf sharedstate localstate gcc rm
@c  LocalWords:  sysconfdir sharedstatedir localstatedir preexist CLEANFILES gz
@c  LocalWords:  unnumberedsubsec depfile tmpdepfile depmode const interoperate
@c  LocalWords:  JAVAC javac JAVAROOT builddir CLASSPATH ENV pyc pyo pkgpython
@c  LocalWords:  pyexecdir pkgpyexecdir Python's pythondir pkgpythondir txi ois
@c  LocalWords:  installinfo vers MAKEINFO makeinfo MAKEINFOFLAGS noinstall rf
@c  LocalWords:  mandir thesame alsothesame installman myexecbin DESTDIR Pinard
@c  LocalWords:  uninstall installdirs uninstalls MOSTLYCLEANFILES mostlyclean
@c  LocalWords:  DISTCLEANFILES MAINTAINERCLEANFILES gzip'd GZIP gzip shar exp
@c  LocalWords:  distdir distcheck distcleancheck listfiles distuninstallcheck
@c  LocalWords:  VPATH tarfile stdout XFAIL DejaGnu dejagnu DEJATOOL runtest ln
@c  LocalWords:  RUNTESTDEFAULTFLAGS toolchain RUNTESTFLAGS asis readme DVIPS
@c  LocalWords:  installcheck gzipped tarZ std utils etags mkid multilibbing cd
@c  LocalWords:  ARGS taggable ETAGSFLAGS lang ctags CTAGSFLAGS GTAGS gtags idl
@c  LocalWords:  foocc doit idlC multilibs ABIs cmindex defmac ARG enableval
@c  LocalWords:  MSG xtrue DBG pathchk CYGWIN afile proglink versioned CVS's
@c  LocalWords:  wildcards Autoconfiscated subsubheading autotools Meyering API
@c  LocalWords:  ois's wildcard Wportability cartouche vrindex printindex Duret
@c  LocalWords:  DSOMEFLAG DVERSION automake Lutz insertcopying versioning FAQ
@c  LocalWords:  LTLIBOBJ Libtool's libtool's libltdl dlopening itutions libbar
@c  LocalWords:  WANTEDLIBS libhello sublibraries libtop libsub dlopened Ratfor
@c  LocalWords:  mymodule timestamps timestamp underquoted MAKEINFOHTMLFLAGS
@c  LocalWords:  GNUmakefile buildir Subpackages subpackage's subpackages
